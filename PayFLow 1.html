<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payroll & HR Management UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet"><!-- Supabase Integration Script -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
        .accent-gradient {
            background-image: linear-gradient(to right, #4f46e5, #9333ea); /* Blue to Purple */
        }
        .shadow-lg-custom {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .sidebar-link.active {
            background-color: rgba(255, 255, 255, 0.1);
            border-left: 4px solid #9333ea;
        }
        /* Custom scrollbar for clean look */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background-color: #a78bfa; border-radius: 3px; }
        ::-webkit-scrollbar-track { background-color: transparent; }
        
        /* Pulse animation for clock status */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Main Application Container -->
    <div id="app-container" class="hidden">
        <!-- Sidebar Navigation -->
        <aside id="sidebar" class="w-64 fixed inset-y-0 transform transition-transform duration-300 ease-in-out bg-white text-gray-800 border-r border-gray-100 p-4 flex flex-col z-20">
            <!-- Logo/App Name -->
            <div class="h-16 flex items-center justify-center mb-6">
                <span class="text-xl font-extrabold accent-gradient bg-clip-text text-transparent">PayFlow</span>
                <span id="user-role-tag" class="ml-2 px-2 py-0.5 text-xs font-semibold rounded-full text-white"></span>
            </div>

            <!-- Main Navigation Links -->
            <nav class="flex-grow space-y-2 overflow-y-auto">
                <!-- Links will be dynamically generated here -->
            </nav>

            <!-- User/Settings Footer -->
            <div class="mt-auto pt-4 border-t border-gray-100">
                <div class="flex items-center space-x-3 cursor-pointer p-2 rounded-lg hover:bg-gray-100 transition">
                    <div class="w-10 h-10 bg-purple-200 rounded-full flex items-center justify-center text-purple-700 font-semibold">
                        <span id="user-initials">US</span>
                    </div>
                    <div>
                        <p class="text-sm font-semibold" id="user-name">User Name</p>
                        <p class="text-xs text-gray-500" id="user-id">ID: 000000</p>
                    </div>
                </div>
                <button onclick="logout()" class="w-full mt-3 py-2 text-sm text-red-600 bg-red-100 rounded-lg hover:bg-red-200 transition">
                    Logout
                </button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="ml-64 p-6 min-h-screen">
            <!-- Header/Breadcrumbs -->
            <header class="h-16 flex items-center justify-between border-b border-gray-100 mb-6 bg-white sticky top-0 z-10">
                <h1 class="text-2xl font-bold text-gray-800" id="page-title">Dashboard</h1>
                <div class="flex items-center space-x-4">
                    <button onclick="showNotifications()" class="text-gray-500 hover:text-purple-600 transition p-2 rounded-full bg-gray-100/50 relative">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bell"><path d="M18.667 17.333c0 2.2-1.79 4-4 4H9.333c-2.2 0-4-1.8-4-4"></path><path d="M18 10a6 6 0 0 0-12 0v2c0 1.1-.9 2-2 2h16c-1.1 0-2-.9-2-2v-2z"></path><path d="M12 2v2"></path></svg>
                        <span id="notification-badge" class="hidden absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full text-xs text-white flex items-center justify-center">0</span>
                    </button>
                    <div class="w-8 h-8 rounded-full bg-purple-500"></div> <!-- Small user avatar -->
                </div>
            </header>

            <!-- Content Area for various pages -->
            <div id="content-area" class="pb-10">
                <!-- Content will be injected here -->
            </div>
        </main>
    </div>

    <!-- Login/Authentication Screen -->
    <div id="auth-screen" class="min-h-screen flex items-center justify-center bg-gray-50 p-4">
        <div class="w-full max-w-md bg-white p-8 rounded-2xl shadow-lg-custom">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-extrabold accent-gradient bg-clip-text text-transparent">PayFlow Login</h1>
                <p class="text-gray-500 mt-2">Access your personalized HR and Payroll portal.</p>
            </div>

            <div id="login-form">
                <input type="text" id="login-username" placeholder="Username" class="w-full p-3 mb-4 border border-gray-300 rounded-xl focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition">
                <input type="password" id="login-password" placeholder="Password" class="w-full p-3 mb-6 border border-gray-300 rounded-xl focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition">
                <select id="user-role" class="w-full p-3 mb-6 border border-gray-300 rounded-xl focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition bg-white">
                    <option value="employee">Employee</option>
                    <option value="admin">System Admin</option>
                    <option value="ceo">Manager / CEO</option>
                </select>
                <button onclick="login()" class="w-full p-3 text-white font-bold rounded-xl accent-gradient hover:shadow-lg hover:shadow-purple-500/50 transition duration-300">
                    Sign In
                </button>
                <p class="text-center text-sm text-gray-500 mt-4 cursor-pointer hover:text-purple-600" onclick="showSignup()">
                    Don't have an account? Sign Up
                </p>
            </div>

            <div id="signup-form" class="hidden">
                <input type="text" id="signup-username" placeholder="Username" class="w-full p-3 mb-4 border border-gray-300 rounded-xl">
                <input type="password" id="signup-password" placeholder="Password" class="w-full p-3 mb-4 border border-gray-300 rounded-xl">
                <input type="text" id="signup-id" placeholder="Employee ID Number" class="w-full p-3 mb-4 border border-gray-300 rounded-xl">
                <select id="signup-role" class="w-full p-3 mb-4 border border-gray-300 rounded-xl bg-white" onchange="toggleAdminKeyField()">
                    <option value="employee">Employee Account</option>
                    <option value="admin">Admin Account (Requires Key)</option>
                    <option value="ceo">CEO Account (Requires Key)</option>
                </select>
                <div id="admin-key-field" class="hidden mb-4">
                    <input type="text" id="signup-admin-key" placeholder="Enter Admin/CEO Registration Key" class="w-full p-3 border border-purple-300 rounded-xl bg-purple-50">
                    <p class="text-xs text-purple-600 mt-1">Get this key from your CEO</p>
                </div>
                <button onclick="signup()" class="w-full p-3 text-white font-bold rounded-xl accent-gradient hover:shadow-lg hover:shadow-purple-500/50 transition duration-300">
                    Create Account
                </button>
                <p class="text-center text-sm text-gray-500 mt-4 cursor-pointer hover:text-purple-600" onclick="showLogin()">
                    Already have an account? Log In
                </p>
            </div>

        </div>
    </div>

    <script type="module">
        // Initialize Supabase Client
const client = supabase.createClient(
"https://faaxxtiadatnvsxqqfgr.supabase.co",
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZhYXh4dGlhZGF0bnZzeHFxZmdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0NTYwNzYsImV4cCI6MjA4MDAzMjA3Nn0.1IXlTz_xS9HhgP7YeVaHsHUJYuEAESOil4cnaLu-phs"
);

let currentUser = null;

        // --- Toast Notification System ---
        window.showToast = function(message, type = 'info', duration = 4000) {
            // Remove existing toasts
            const existingToast = document.getElementById('toast-notification');
            if (existingToast) existingToast.remove();

            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-indigo-500'
            };
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };

            const toast = document.createElement('div');
            toast.id = 'toast-notification';
            toast.className = `fixed top-6 right-6 ${colors[type] || colors.info} text-white px-6 py-4 rounded-xl shadow-2xl z-[9999] flex items-center space-x-3 transform transition-all duration-300 translate-x-full`;
            toast.innerHTML = `
                <span class="text-xl">${icons[type] || icons.info}</span>
                <span class="font-medium">${message}</span>
                <button onclick="this.parentElement.remove()" class="ml-4 hover:bg-white/20 rounded p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            `;
            document.body.appendChild(toast);

            // Animate in
            setTimeout(() => toast.classList.remove('translate-x-full'), 10);

            // Auto remove
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        };
        
        // --- UI State Management Functions ---

        window.showSignup = function() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('signup-form').classList.remove('hidden');
            document.getElementById('signup-role').value = 'employee';
            toggleAdminKeyField();
        }

        window.showLogin = function() {
            document.getElementById('signup-form').classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
        }

        window.toggleAdminKeyField = function() {
            const role = document.getElementById('signup-role').value;
            const keyField = document.getElementById('admin-key-field');
            if (role === 'admin' || role === 'ceo') {
                keyField.classList.remove('hidden');
            } else {
                keyField.classList.add('hidden');
            }
        }

        window.logout = function() {
            currentUser = null;
            document.getElementById('app-container').classList.add('hidden');
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('user-role').value = 'employee';
            showLogin();
            console.log("Logged out successfully.");
        }

        // Notification System
        window.showNotifications = async function() {
            try {
                const notifications = [];
                
                // Get recent announcements
                const { data: announcements } = await client
                    .from('announcements')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(5);

                if (announcements && announcements.length > 0) {
                    announcements.forEach(a => {
                        notifications.push({
                            type: 'announcement',
                            title: a.title,
                            date: new Date(a.created_at).toLocaleDateString()
                        });
                    });
                }

                // For admin/ceo, get pending requests count
                if (currentUser.role !== 'employee') {
                    const { count } = await client
                        .from('requests')
                        .select('*', { count: 'exact', head: true })
                        .eq('status', 'pending');

                    if (count > 0) {
                        notifications.unshift({
                            type: 'alert',
                            title: `${count} pending employee request(s)`,
                            date: 'Action required'
                        });
                    }
                }

                // Display notifications
                if (notifications.length === 0) {
                    alert('üîî No new notifications');
                } else {
                    let msg = 'üîî Recent Notifications:\n\n';
                    notifications.forEach((n, i) => {
                        const icon = n.type === 'alert' ? '‚ö†Ô∏è' : 'üì¢';
                        msg += `${icon} ${n.title}\n   ${n.date}\n\n`;
                    });
                    msg += 'View "System Updates/Notices" for full details.';
                    alert(msg);
                }

            } catch (err) {
                console.error('Error loading notifications:', err);
                alert('Could not load notifications.');
            }
        };

        // Check for notifications on login
        async function checkNotifications() {
            try {
                let count = 0;

                // Count recent announcements (last 7 days)
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                
                const { count: annCount } = await client
                    .from('announcements')
                    .select('*', { count: 'exact', head: true })
                    .gte('created_at', weekAgo.toISOString());

                count += annCount || 0;

                // For admin/ceo, add pending requests
                if (currentUser.role !== 'employee') {
                    const { count: reqCount } = await client
                        .from('requests')
                        .select('*', { count: 'exact', head: true })
                        .eq('status', 'pending');

                    count += reqCount || 0;
                }

                // Update badge
                const badge = document.getElementById('notification-badge');
                if (badge) {
                    if (count > 0) {
                        badge.textContent = count > 9 ? '9+' : count;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
            } catch (err) {
                console.error('Error checking notifications:', err);
            }
        }

        // --- Authentication Functions ---

       
       // ---------- AUTH: SIGNUP ----------
        window.signup = async function () {
        const username = document.getElementById('signup-username').value.trim();
        const password = document.getElementById('signup-password').value.trim();
        const id = document.getElementById('signup-id').value.toUpperCase().trim();
        const role = document.getElementById('signup-role').value;
        const adminKey = document.getElementById('signup-admin-key')?.value.trim() || '';

        if (!username || !password || !id) {
            showToast("Please fill in all required fields.", "error");
            return;
        }

        // Check admin key for admin/CEO accounts
        if ((role === 'admin' || role === 'ceo') && !adminKey) {
            showToast("Admin/CEO accounts require a registration key from the CEO.", "error");
            return;
        }

        try {
            // Verify admin key if needed
            if (role === 'admin' || role === 'ceo') {
                const { data: keyData, error: keyError } = await client
                    .from('admin_keys')
                    .select('*')
                    .eq('key', adminKey)
                    .eq('used', false)
                    .single();

                if (keyError || !keyData) {
                    showToast("Invalid or already used registration key.", "error");
                    return;
                }
            }

            // Create account with pending approval for admin/CEO
            const accountStatus = (role === 'admin' || role === 'ceo') ? 'pending_approval' : 'active';
            const accountData = { 
                id, 
                name: username, 
                role, 
                username, 
                password,
                account_status: accountStatus
            };

            const { data, error } = await client
                .from("users")
                .insert([accountData])
                .select();

            if (error) {
                console.error("Signup failed:", error);
                showToast("Signup failed: " + error.message, "error");
                return;
            }

            if (!data || data.length === 0) {
                showToast("Account creation issue. Please try again.", "error");
                return;
            }

            // Mark admin key as used if it was used
            if ((role === 'admin' || role === 'ceo') && adminKey) {
                await client
                    .from('admin_keys')
                    .update({ used: true, used_by: id, used_at: new Date().toISOString() })
                    .eq('key', adminKey);
            }

            if (accountStatus === 'pending_approval') {
                showToast("Account created! Waiting for admin approval. You'll be notified when approved.", "info");
                showLogin();
            } else {
                showToast("Account created successfully! Logging you in...", "success");
                currentUser = data[0];
                initializeAppUI(currentUser);
            }
        } catch (err) {
            console.error("Signup exception:", err);
            showToast("An error occurred during signup.", "error");
        }
        };
       // ---------- AUTH: LOGIN ----------
window.login = async function () {
    const username = document.getElementById('login-username').value.trim();
    const password = document.getElementById('login-password').value.trim();
    const role = document.getElementById('user-role').value;

    if (!username || !password) {
        alert("‚ùå Please enter both username and password.");
        return;
    }

    console.log("Attempting login with:", { username, role });

    try {
        // Try querying by username first, then by name
        let allUsers = null;
        let checkError = null;
        
        // First, try querying by username (exact match)
        const usernameResult = await client
            .from("users")
            .select("*")
            .eq("username", username);
        
        if (usernameResult.data && usernameResult.data.length > 0) {
            allUsers = usernameResult.data;
            console.log("Found users by username:", allUsers);
        } else if (usernameResult.error) {
            console.log("Username query error (may be expected if username field doesn't exist):", usernameResult.error);
        }
        
        // If no results, try querying by name (case-insensitive)
        if (!allUsers || allUsers.length === 0) {
            console.log("Trying name-based query...");
            const nameResult = await client
                .from("users")
                .select("*")
                .ilike("name", username);
            
            if (nameResult.data && nameResult.data.length > 0) {
                allUsers = nameResult.data;
                checkError = null;
                console.log("Found users by name query:", allUsers);
            } else if (nameResult.error) {
                checkError = nameResult.error;
                console.error("Name query error:", nameResult.error);
            }
        }
        
        // If still no results, try getting all users (may be blocked by RLS)
        if (!allUsers || allUsers.length === 0) {
            console.log("Trying to get all users...");
            const allResult = await client
                .from("users")
                .select("*")
                .limit(100);
            
            if (allResult.data && allResult.data.length > 0) {
                allUsers = allResult.data;
                checkError = null;
                console.log("Found users via all query:", allUsers);
            } else if (allResult.error) {
                checkError = allResult.error;
                console.error("All users query error:", allResult.error);
            }
        }

        if (checkError) {
            console.error("Database error:", checkError);
            showToast("Database error: " + checkError.message + ". This may be a permissions issue. Please contact administrator.", "error");
            return;
        }

        if (!allUsers || allUsers.length === 0) {
            console.error("No users found. This may be due to RLS policies blocking access.");
            showToast("Unable to access user database. Please ensure Row Level Security policies allow user access, or contact administrator.", "error");
            return;
        }

        console.log("All users from database:", allUsers);
        console.log("Searching for:", { username, role, searchTerm: username.toLowerCase().trim() });

        // Find user by username or name (case-insensitive, for backward compatibility)
        const searchTerm = username.toLowerCase().trim();
        let userWithRole = null;
        let userFound = false;
        let foundUsers = [];

        for (const user of allUsers || []) {
            const userUsername = (user.username || '').toLowerCase().trim();
            const userName = (user.name || '').toLowerCase().trim();
            
            console.log("Checking user:", { 
                id: user.id, 
                username: user.username, 
                name: user.name, 
                role: user.role,
                userUsername, 
                userName, 
                searchTerm,
                usernameMatch: userUsername === searchTerm,
                nameMatch: userName === searchTerm
            });
            
            // Check if username or name matches (partial match also)
            if (userUsername === searchTerm || userName === searchTerm || 
                userUsername.includes(searchTerm) || userName.includes(searchTerm)) {
                userFound = true;
                foundUsers.push(user);
                
                // Check if role matches
                if (user.role === role) {
                    userWithRole = user;
                    console.log("Found matching user with correct role:", user);
                    break;
                }
            }
        }

        console.log("Search results:", { userFound, foundUsers, userWithRole });

        // If no user found at all
        if (!userFound) {
            console.log("User not found in database. Available users:", allUsers?.map(u => ({ id: u.id, username: u.username, name: u.name, role: u.role })));
            showToast("Account not found! No account exists with username: '" + username + "'. Please check your username and try again.", "error");
            return;
        }

        // If user found but wrong role
        if (!userWithRole) {
            console.log("User found but wrong role. Found users:", foundUsers);
            const availableRoles = [...new Set(foundUsers.map(u => u.role))];
            showToast("Incorrect role! Username '" + username + "' exists but not as '" + role + "'. Available roles: " + availableRoles.join(", "), "error");
            return;
        }

        // Check if password matches
        if (userWithRole.password !== password) {
            console.log("Incorrect password");
            showToast("Incorrect password. Please try again.", "error");
            return;
        }

        // Check if account is pending approval (only if account_status field exists)
        if (userWithRole.account_status && userWithRole.account_status === 'pending_approval') {
            showToast("Your account is pending admin approval. Please wait for approval before logging in.", "warning");
            return;
        }
        
        // For old users without account_status, set it to 'active' for backward compatibility
        if (!userWithRole.account_status) {
            userWithRole.account_status = 'active';
        }

        // Success!
        console.log("Login successful:", userWithRole);
        showToast("Welcome back, " + userWithRole.name + "!", "success");
        currentUser = userWithRole;
        initializeAppUI(userWithRole);
    } catch (err) {
        console.error("Login exception:", err);
        alert("‚ùå An error occurred during login. Check the console.");
    }
};


        // --- Core UI Initialization ---

        function initializeAppUI(user) {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');

            document.getElementById('user-name').textContent = user.name;
            document.getElementById('user-id').textContent = `ID: ${user.id}`;
            document.getElementById('user-initials').textContent = user.name.split(' ').map(n => n[0]).join('');

            const roleTag = document.getElementById('user-role-tag');
            roleTag.textContent = user.role === 'employee' ? 'USER' : (user.role === 'admin' ? 'ADMIN' : 'CEO');
            roleTag.className = user.role === 'employee'
                ? 'ml-2 px-2 py-0.5 text-xs font-semibold rounded-full text-white bg-indigo-500'
                : (user.role === 'admin' 
                    ? 'ml-2 px-2 py-0.5 text-xs font-semibold rounded-full text-white bg-purple-600'
                    : 'ml-2 px-2 py-0.5 text-xs font-semibold rounded-full text-white bg-red-600');

            setupNavigation(user.role);
            loadPage('dashboard'); // Load dashboard content initially using the existing page loader
            
            // Check for notifications after login
            setTimeout(() => checkNotifications(), 500);
        }

        // --- Navigation Setup ---

        function setupNavigation(role) {
            const nav = document.querySelector('#sidebar nav');
            nav.innerHTML = '';
            let links = [];

            const iconMap = {
                dashboard: 'gauge', payslips: 'file-text', requests: 'clipboard-list', benefits: 'gift',
                budgeting: 'banknote', hours: 'clock', calculate: 'calculator',
                generation: 'dollar-sign', reports: 'file-bar-chart', data: 'users',
                security: 'lock', system: 'server', journal: 'book-open',
                updates: 'megaphone',
            };

            const staffLinks = [
                // Employer's Payroll Generation
                { id: 'payroll_generation', title: "Payroll Generation", icon: 'generation', access: ['admin', 'ceo'] },
                { id: 'payslip_gen', title: "Generate Payslips", icon: 'payslips', access: ['admin', 'ceo'] },
                { id: 'financial_statements', title: "Financial Statements", icon: 'journal', access: ['ceo'] },

                // Data Management
                { id: 'manage_data', title: "Manage Employee Data", icon: 'data', access: ['admin', 'ceo'] },
                { id: 'security', title: "System Security", icon: 'lock', access: ['admin', 'ceo'] },

                // Payroll Calculations
                { id: 'statutory_calc', title: "Statutory & Compliance", icon: 'calculate', access: ['admin', 'ceo'] },

                // Budgeting (Tied to Managerial Role)
                { id: 'emp_budget', title: "Generate Employee Budget", icon: 'budgeting', access: ['admin', 'ceo'] },
                { id: 'business_budget', title: "Generate Business Budget", icon: 'budgeting', access: ['ceo'], restricted: true }, // CEO Only

                // Reporting
                { id: 'full_reports', title: "Full System Reports", icon: 'reports', access: ['ceo'] },
                { id: 'past_reports', title: "Access Past Reports", icon: 'reports', access: ['admin', 'ceo'] },

                // System Services
                { id: 'back_up', title: "Back Up System", icon: 'system', access: ['admin', 'ceo'] },
                { id: 'purge', title: "Purge Ancient Records", icon: 'system', access: ['admin', 'ceo'] },

                // Shared Utilities
                { id: 'view_hours', title: "View Working Hours", icon: 'hours', access: ['employee', 'admin', 'ceo'], shared: true },
                { id: 'tasks', title: "Task Management", icon: 'clipboard-list', access: ['employee', 'admin', 'ceo'], shared: true },
                { id: 'updates', title: "System Updates/Notices", icon: 'updates', access: ['employee', 'admin', 'ceo'], shared: true },
            ];

            const employeeLinks = [
                { id: 'view_hours', title: "View Working Hours", icon: 'hours', access: ['employee'], shared: true },
                { id: 'access_payslips', title: "Access Payslips", icon: 'payslips', access: ['employee'] },
                { id: 'tasks', title: "My Tasks", icon: 'clipboard-list', access: ['employee'], shared: true },
                { id: 'request_statutory', title: "Request Statutory Info", icon: 'requests', access: ['employee'] },
                { id: 'request_benefits', title: "Request Benefits", icon: 'benefits', access: ['employee'] },
                { id: 'my_budget', title: "My Expense Projection", icon: 'budgeting', access: ['employee'] },
                { id: 'salary_calc', title: "My Salary Calculator", icon: 'calculate', access: ['employee'] },
                { id: 'request_data', title: "Request Payroll Data", icon: 'data', access: ['employee'] },
                { id: 'updates', title: "Announcements/Memos", icon: 'updates', access: ['employee'], shared: true },
            ];


            if (role === 'employee') {
                links = [{ id: 'dashboard', title: "Dashboard", icon: 'dashboard', access: ['employee'] }].concat(employeeLinks);
            } else { // admin or ceo
                links = [{ id: 'dashboard', title: "Dashboard", icon: 'dashboard', access: ['admin', 'ceo'] }].concat(staffLinks);
            }


            links.forEach(link => {
                if (link.access.includes(role)) {
                    let isRestricted = link.restricted && role !== 'ceo';
                    let linkHtml = `
                        <a href="#" data-page="${link.id}"
                           class="sidebar-link flex items-center space-x-3 p-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors duration-200
                           ${isRestricted ? 'opacity-40 cursor-not-allowed bg-gray-50' : ''}"
                           onclick="loadPage('${link.id}', event)"
                           ${isRestricted ? 'aria-disabled="true"' : ''}>
                           ${getIcon(iconMap[link.icon])}
                           <span class="text-sm font-medium">${link.title}
                           ${isRestricted ? ' (CEO Only)' : ''}
                           </span>
                        </a>
                    `;
                    nav.innerHTML += linkHtml;
                }
            });
        }

        // --- Content Rendering ---

        window.loadPage = function(pageId, event) {
    if (event) event.preventDefault();

    document.querySelectorAll('.sidebar-link').forEach(link => link.classList.remove('active'));
    const activeLink = document.querySelector(`.sidebar-link[data-page="${pageId}"]`);
    if (activeLink && !activeLink.getAttribute('aria-disabled')) {
         activeLink.classList.add('active');
    }

    const contentArea = document.getElementById('content-area');
    const titleElement = document.getElementById('page-title');

    let content = '';
    let title = '';

    switch(pageId) {
        case 'dashboard':
            title = currentUser.role === 'employee' ? 'My Dashboard' : 'Staff Dashboard';
            content = renderDashboardContent(currentUser.role);
            // Load real stats for dashboards
            if (currentUser.role !== 'employee') {
                setTimeout(() => {
                    loadDashboardStats();
                    loadDashboardMeetings();
                    loadDashboardTasks();
                }, 100);
            } else {
                setTimeout(() => {
                    loadEmployeeDashboardStats();
                    loadDashboardMeetings();
                    loadDashboardTasks();
                }, 100);
            }
            break;
        case 'tasks':
            title = 'Task Management';
            content = renderTaskList();
            setTimeout(() => loadTaskList(), 100);
            break;
                case 'view_hours':
                    title = 'Employee Working Hours';
                    content = renderWorkingHours();
                    // Load time records after rendering
                    setTimeout(() => {
                        loadTimeRecords();
                        updateCurrentTime();
                    }, 100);
                    break;
                case 'salary_calc':
                    title = 'My Salary Calculation';
                    content = renderSalaryCalc();
                    // Auto-load hours data
                    setTimeout(() => loadSalaryCalcData(), 100);
                    break;
                case 'access_payslips':
                    title = 'Access Payslips';
                    content = renderEmployeeDataRequest('payslips');
                    break;
                case 'request_data':
                    title = 'Request Payroll Data';
                    content = renderEmployeeDataRequest('payroll');
                    break;
                case 'request_statutory':
                    title = 'Statutory Info Request';
                    content = renderRequestStatutory();
                    setTimeout(() => loadPendingRequests('statutory', 'pending-statutory-requests'), 100);
                    break;
                case 'request_benefits':
                    title = 'Benefits Application';
                    content = renderRequestBenefits();
                    setTimeout(() => loadPendingRequests('benefits', 'pending-benefits-requests'), 100);
                    break;
                case 'my_budget':
                case 'emp_budget': 
                case 'business_budget': 
                    // Set title from link text
                    title = activeLink.querySelector('span').textContent.replace(' (CEO Only)', '').trim();
                    content = renderBudgetingContent(pageId);
                    if (pageId === 'my_budget') {
                        setTimeout(() => loadPersonalBudgetData(), 100);
                    }
                    break;
                case 'manage_data':
                    title = 'Manage Employee Information';
                    content = renderAdminEmployeeManagement();
                    setTimeout(() => loadEmployeeList(), 100);
                    break;
                case 'payroll_generation':
                    title = 'Employer\'s Payroll Generation';
                    content = renderPayrollGeneration();
                    break;
                case 'payslip_gen':
                    title = 'Generate Payslips';
                    content = renderPayslipGenerationTool();
                    break;
                case 'statutory_calc':
                    title = 'Statutory & Compliance';
                    content = renderStatutoryCompliance();
                    break;
                case 'financial_statements':
                    title = 'Financial Statements';
                    content = renderFinancialStatements();
                    setTimeout(() => loadFinancialSummary(), 100);
                    break;
                case 'security':
                    title = 'System Security';
                    content = renderSystemSecurity();
                    setTimeout(() => loadSecurityPage(), 100);
                    break;
                case 'full_reports':
                case 'past_reports':
                    title = 'System Reporting Console';
                    content = renderReportingConsole();
                    break;
                case 'back_up':
                case 'purge':
                    title = 'System Maintenance';
                    content = renderSystemMaintenance();
                    setTimeout(() => {
                        loadMaintenanceStats();
                        initBackupStatus();
                    }, 100);
                    break;
                case 'updates':
                    title = 'System Updates/Notices';
                    content = renderSystemUpdates();
                    setTimeout(() => loadAnnouncements(), 100);
                    break;
                default:
                    title = activeLink ? activeLink.querySelector('span').textContent.replace(' (CEO Only)', '') : 'Feature Not Implemented';
                    content = `<div class="p-6 bg-white rounded-xl shadow-md text-gray-600">
                                   <p class="text-lg">Welcome to the ${title} page!</p>
                                   <p class="mt-2">This is where the detailed interface for **${title}** would be built.</p>
                               </div>`;
                    break;
            }

            titleElement.textContent = title;
            contentArea.innerHTML = content;
        }

        // --- Content Blocks (UI Mockups) ---

        function renderCard(color, title, value, icon) {
            return `
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-500">${title}</span>
                        ${getIcon(icon, color)}
                    </div>
                    <p class="mt-1 text-3xl font-extrabold text-gray-900">${value}</p>
                </div>
            `;
        }

        function renderActionCard(title, description, pageId, icon) {
            return `
                <div class="bg-white p-6 rounded-xl shadow-md flex flex-col justify-between hover:shadow-lg transition duration-200">
                    <div>
                         ${getIcon(icon, 'text-purple-600')}
                         <h3 class="text-lg font-bold text-gray-800 mt-2">${title}</h3>
                         <p class="text-sm text-gray-500 mt-1">${description}</p>
                    </div>
                    <button onclick="loadPage('${pageId}')" class="mt-4 p-2 text-sm font-semibold rounded-lg text-white accent-gradient hover:opacity-90 transition">
                        Go to ${title}
                    </button>
                </div>
            `;
        }

        function renderDashboardContent(role) {
    if (role === 'employee') {
        // Employee dashboard with dynamic clock in/out status
        return `
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-md col-span-1 md:col-span-2">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Clock Status</p>
                            <p id="dash-clock-status" class="text-xl font-bold text-gray-800">Checking...</p>
                        </div>
                        <div id="dash-status-indicator" class="w-4 h-4 rounded-full bg-gray-300"></div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="loadPage('view_hours')" class="flex-1 py-2 px-4 text-sm font-semibold rounded-lg text-white accent-gradient hover:opacity-90 transition">
                            Go to Time Clock
                        </button>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-500">Hours This Month</span>
                        ${getIcon('clock', 'text-indigo-600')}
                    </div>
                    <p id="dash-month-hours" class="mt-1 text-3xl font-extrabold text-gray-900">0.0</p>
                    <p id="dash-month-pay" class="text-sm text-green-600 font-medium">JMD 0</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-500">Hours Today</span>
                        ${getIcon('calendar', 'text-purple-600')}
                    </div>
                    <p id="dash-today-hours" class="mt-1 text-3xl font-extrabold text-gray-900">0.0</p>
                </div>
            </div>
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Quick Self-Service</h2>
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                ${renderActionCard('Payslips', 'View or export your latest pay information.', 'access_payslips', 'file-text')}
                ${renderActionCard('Benefits', 'Request new or update existing benefits.', 'request_benefits', 'gift')}
                ${renderActionCard('Budget', 'Manage your personal expense projection.', 'my_budget', 'banknote')}
                ${renderActionCard('Working Hours', 'Clock in/out and view your time records.', 'view_hours', 'clock')}
            </div>
            
            <!-- Upcoming Meetings -->
            <div class="mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">üìÖ Upcoming Meetings</h2>
                <div id="dashboard-meetings" class="space-y-2">
                    <p class="text-gray-500 text-sm">Loading meetings...</p>
                </div>
            </div>
            
            <!-- My Tasks -->
            <div>
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">‚úÖ My Tasks</h2>
                    <button onclick="loadPage('tasks')" class="text-purple-600 hover:text-purple-800 text-sm font-semibold">View All ‚Üí</button>
                </div>
                <div id="dashboard-tasks" class="space-y-2">
                    <p class="text-gray-500 text-sm">Loading tasks...</p>
                </div>
            </div>
        `;
    } else { // admin or ceo
        // Return a loading placeholder first
        return `
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8" id="stats-cards">
                ${renderCard('text-indigo-600', 'Active Employees', 'Loading...', 'users')}
                ${renderCard('text-purple-600', 'Payroll Scheduled For', '28/11/2025', 'calendar')}
                ${renderCard('text-green-600', 'Open Tickets/Requests', '12', 'mail')}
            </div>
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Staff Actions</h2>
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                ${renderActionCard('Generate Payroll', 'Start the monthly payroll calculation process.', 'payroll_generation', 'dollar-sign')}
                ${renderActionCard('Manage Data', 'Create, update, or delete employee records.', 'manage_data', 'database')}
                ${renderActionCard('Employee Budget', 'Generate Employee Expense Reports.', 'emp_budget', 'banknote')}
                <div class="bg-white p-6 rounded-xl shadow-md border-2 border-dashed border-gray-200">
                     <h3 class="text-lg font-bold text-gray-400">Business Budget</h3>
                     <p class="text-sm text-gray-400 mt-1">Strategic financial reports.</p>
                     ${currentUser.role === 'admin' ? '<p class="text-sm text-red-500 mt-2">Access Restricted (CEO Only)</p>' : ''}
                     <button class="w-full mt-3 p-2 text-sm font-semibold rounded-lg bg-gray-200 text-gray-500 ${currentUser.role === 'admin' ? 'cursor-not-allowed' : 'hover:bg-gray-300'}"
                             ${currentUser.role === 'admin' ? 'disabled' : ''} onclick="loadPage('business_budget')">
                         View Budget
                     </button>
                </div>
            </div>
            
            <!-- Upcoming Meetings -->
            <div class="mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">üìÖ Upcoming Meetings</h2>
                <div id="dashboard-meetings" class="space-y-2">
                    <p class="text-gray-500 text-sm">Loading meetings...</p>
                </div>
            </div>
            
            <!-- My Tasks -->
            <div>
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">‚úÖ My Tasks</h2>
                    <button onclick="loadPage('tasks')" class="text-purple-600 hover:text-purple-800 text-sm font-semibold">View All ‚Üí</button>
                </div>
                <div id="dashboard-tasks" class="space-y-2">
                    <p class="text-gray-500 text-sm">Loading tasks...</p>
                </div>
            </div>
        `;
    }
}

// This function loads dashboard stats
// Enhanced function to load all dynamic dashboard stats
async function loadDashboardStats() {
    try {
        // 1. Count all employees
        const { count: employeeCount, error: employeeError } = await client
            .from('users')
            .select('*', { count: 'exact', head: true })
            .eq('role', 'employee');

        if (employeeError) {
            console.error('Error fetching employee count:', employeeError);
        }

        // 2. Count pending requests (tickets)
        const { count: requestCount, error: requestError } = await client
            .from('requests')
            .select('*', { count: 'exact', head: true })
            .eq('status', 'pending');

        if (requestError) {
            console.error('Error fetching request count:', requestError);
        }

        // 3. Get the next scheduled payroll date (we'll calculate it)
        const nextPayrollDate = calculateNextPayrollDate();

        // Update the stats cards with real data
        const statsContainer = document.getElementById('stats-cards');
        if (statsContainer) {
            statsContainer.innerHTML = `
                ${renderCard('text-indigo-600', 'Active Employees', employeeCount || 0, 'users')}
                ${renderCard('text-purple-600', 'Payroll Scheduled For', nextPayrollDate, 'calendar')}
                ${renderCard('text-green-600', 'Open Tickets/Requests', requestCount || 0, 'mail')}
            `;
        }

        console.log('Dashboard stats loaded:', {
            employees: employeeCount,
            requests: requestCount,
            nextPayroll: nextPayrollDate
        });

    } catch (err) {
        console.error('Exception loading dashboard stats:', err);
    }
}

// Calculate the next payroll date (last day of current month)
function calculateNextPayrollDate() {
    const today = new Date();
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();
    
    // Get the last day of the current month
    const lastDayOfMonth = new Date(currentYear, currentMonth + 1, 0);
    
    // If today is past the 25th, schedule for next month
    if (today.getDate() > 25) {
        const nextMonth = new Date(currentYear, currentMonth + 2, 0);
        return formatDate(nextMonth);
    }
    
    return formatDate(lastDayOfMonth);
}

// Format date as DD/MM/YYYY
function formatDate(date) {
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
}

// Function to load employee dashboard stats (clock status and hours)
async function loadEmployeeDashboardStats() {
    try {
        // Check for active clock-in session
        const { data: activeSession, error: sessionError } = await client
            .from('attendance')
            .select('*')
            .eq('employee_id', currentUser.id)
            .is('clock_out', null)
            .single();

        const clockStatusEl = document.getElementById('dash-clock-status');
        const statusIndicatorEl = document.getElementById('dash-status-indicator');

        if (activeSession) {
            const clockInTime = new Date(activeSession.clock_in);
            if (clockStatusEl) clockStatusEl.textContent = 'Clocked In at ' + formatTime(clockInTime);
            if (statusIndicatorEl) statusIndicatorEl.className = 'w-4 h-4 rounded-full bg-green-500 animate-pulse';
        } else {
            if (clockStatusEl) clockStatusEl.textContent = 'Not Clocked In';
            if (statusIndicatorEl) statusIndicatorEl.className = 'w-4 h-4 rounded-full bg-red-500';
        }

        // Get hours for this month
        const startOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
        const today = new Date().toISOString().split('T')[0];

        const { data: monthRecords, error: monthError } = await client
            .from('attendance')
            .select('*')
            .eq('employee_id', currentUser.id)
            .gte('date', startOfMonth)
            .not('clock_out', 'is', null);

        let monthHours = 0;
        let todayHours = 0;

        if (monthRecords) {
            monthRecords.forEach(record => {
                const hoursWorked = calculateHoursFromRecord(record);
                monthHours += hoursWorked;
                if (record.date === today) {
                    todayHours += hoursWorked;
                }
            });
        }

        const monthHoursEl = document.getElementById('dash-month-hours');
        const monthPayEl = document.getElementById('dash-month-pay');
        const todayHoursEl = document.getElementById('dash-today-hours');

        if (monthHoursEl) monthHoursEl.textContent = monthHours.toFixed(1);
        if (monthPayEl) monthPayEl.textContent = 'JMD ' + (monthHours * HOURLY_RATE).toLocaleString();
        if (todayHoursEl) todayHoursEl.textContent = todayHours.toFixed(1);

    } catch (err) {
        console.error('Error loading employee dashboard stats:', err);
    }
}

// Function to submit a request to admin
async function submitRequest(requestType, details) {
    try {
        const { data, error } = await client
            .from('requests')
            .insert([{
                employee_id: currentUser.id,
                employee_name: currentUser.name,
                request_type: requestType,
                request_category: requestType,
                status: 'pending',
                details: details,
                created_at: new Date().toISOString()
            }])
            .select();

        if (error) {
            console.error('Error submitting request:', error);
            alert('‚ùå Failed to submit request: ' + error.message);
            return false;
        }

        console.log('Request submitted:', data[0]);
        alert('‚úÖ Request submitted successfully! Admin will review it soon.');
        return true;
    } catch (err) {
        console.error('Exception submitting request:', err);
        alert('‚ùå An error occurred while submitting your request.');
        return false;
    }
}
    function renderWorkingHours() {
            const isStaff = currentUser.role !== 'employee';
            return `
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-bold mb-4">Employee Working Hours</h2>
                    
                    <!-- Clock In/Out Section for Employees -->
                    ${currentUser.role === 'employee' ? `
                    <div class="mb-8 p-6 border-2 border-purple-200 rounded-xl bg-gradient-to-r from-purple-50 to-indigo-50">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3 class="text-lg font-bold text-purple-800">Time Clock</h3>
                                <p class="text-sm text-gray-600">Current Time: <span id="current-time" class="font-semibold text-indigo-600"></span></p>
                            </div>
                            <div id="clock-status" class="px-4 py-2 rounded-full text-sm font-semibold">
                                <!-- Status will be updated dynamically -->
                            </div>
                        </div>
                        
                        <div class="flex space-x-4">
                            <button id="clock-in-btn" onclick="clockIn()" class="flex-1 py-4 px-6 text-white font-bold rounded-xl bg-green-500 hover:bg-green-600 transition transform hover:scale-105 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline mr-2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></svg>
                                Clock In
                            </button>
                            <button id="clock-out-btn" onclick="clockOut()" class="flex-1 py-4 px-6 text-white font-bold rounded-xl bg-red-500 hover:bg-red-600 transition transform hover:scale-105 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline mr-2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
                                Clock Out
                            </button>
                        </div>
                        
                        <div id="session-info" class="mt-4 p-3 bg-white rounded-lg border hidden">
                            <p class="text-sm text-gray-600">Session started at: <span id="session-start" class="font-semibold"></span></p>
                            <p class="text-sm text-gray-600">Time elapsed: <span id="session-elapsed" class="font-semibold text-purple-600"></span></p>
                        </div>
                    </div>
                    ` : ''}

                    <!-- Hours Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="p-4 bg-indigo-50 rounded-xl border border-indigo-200">
                            <p class="text-xs text-indigo-600 font-medium">Today's Hours</p>
                            <p id="today-hours" class="text-2xl font-bold text-indigo-800">0.0</p>
                        </div>
                        <div class="p-4 bg-purple-50 rounded-xl border border-purple-200">
                            <p class="text-xs text-purple-600 font-medium">This Week</p>
                            <p id="week-hours" class="text-2xl font-bold text-purple-800">0.0</p>
                        </div>
                        <div class="p-4 bg-green-50 rounded-xl border border-green-200">
                            <p class="text-xs text-green-600 font-medium">This Month</p>
                            <p id="month-hours" class="text-2xl font-bold text-green-800">0.0</p>
                        </div>
                        <div class="p-4 bg-yellow-50 rounded-xl border border-yellow-200">
                            <p class="text-xs text-yellow-600 font-medium">Est. Pay (JMD 700/hr)</p>
                            <p id="est-pay" class="text-2xl font-bold text-yellow-800">$0</p>
                        </div>
                    </div>

                    <!-- Filter Section -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        ${isStaff ? `<input type="text" id="filter-employee-id" placeholder="Employee ID Number" class="p-3 border rounded-lg">` : ''}
                        <input type="date" id="filter-start-date" class="p-3 border rounded-lg">
                        <input type="date" id="filter-end-date" class="p-3 border rounded-lg">
                    </div>
                    <button onclick="loadTimeRecords()" class="py-2 px-4 text-white font-semibold rounded-lg accent-gradient">
                        Generate Hours Report
                    </button>

                    <!-- Time Records Table -->
                    <div class="mt-8">
                        <h3 class="text-lg font-semibold mb-2">Time Records</h3>
                        <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 border rounded-lg">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Clock In</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Clock Out</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Hours</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Pay (JMD)</th>
                                </tr>
                            </thead>
                                <tbody id="time-records-body" class="bg-white divide-y divide-gray-200">
                                    <tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Loading records...</td></tr>
                            </tbody>
                                <tfoot class="bg-gray-100">
                                    <tr>
                                        <td colspan="3" class="px-6 py-3 text-right font-bold text-gray-700">Total:</td>
                                        <td id="total-hours-cell" class="px-6 py-3 font-bold text-indigo-600">0.0 hrs</td>
                                        <td id="total-pay-cell" class="px-6 py-3 font-bold text-green-600">JMD 0</td>
                                    </tr>
                                </tfoot>
                        </table>
                        </div>
                    </div>
                </div>
            `;
        }

        // Time Clock Functions
        let clockInterval = null;
        let currentClockIn = null;
        const HOURLY_RATE = 700;

        window.clockIn = async function() {
            const now = new Date();
            
            try {
                // Check if already clocked in
                const { data: activeSession, error: checkError } = await client
                    .from('attendance')
                    .select('*')
                    .eq('employee_id', currentUser.id)
                    .is('clock_out', null)
                    .single();

                if (activeSession) {
                    alert('‚ö†Ô∏è You are already clocked in! Please clock out first.');
                    return;
                }

                // Create new clock in record
                const { data, error } = await client
                    .from('attendance')
                    .insert([{
                        employee_id: currentUser.id,
                        clock_in: now.toISOString(),
                        date: now.toISOString().split('T')[0]
                    }])
                    .select();

                if (error) {
                    console.error('Clock in error:', error);
                    alert('‚ùå Failed to clock in: ' + error.message);
                    return;
                }

                currentClockIn = now;
                alert('‚úÖ Clocked in successfully at ' + formatTime(now));
                updateClockUI(true, now);
                loadTimeRecords();
                startSessionTimer();

            } catch (err) {
                console.error('Clock in exception:', err);
                alert('‚ùå An error occurred while clocking in.');
            }
        };

        window.clockOut = async function() {
            const now = new Date();
            
            try {
                // Find active clock in session
                const { data: activeSession, error: findError } = await client
                    .from('attendance')
                    .select('*')
                    .eq('employee_id', currentUser.id)
                    .is('clock_out', null)
                    .single();

                if (!activeSession) {
                    alert('‚ö†Ô∏è No active clock-in session found. Please clock in first.');
                    return;
                }

                // Calculate hours worked
                const clockInTime = new Date(activeSession.clock_in);
                const hoursWorked = ((now - clockInTime) / (1000 * 60 * 60)).toFixed(2);

                // Update the record with clock out time
                const { data, error } = await client
                    .from('attendance')
                    .update({
                        clock_out: now.toISOString()
                    })
                    .eq('id', activeSession.id)
                    .select();

                if (error) {
                    console.error('Clock out error:', error);
                    alert('‚ùå Failed to clock out: ' + error.message);
                    return;
                }

                const pay = (parseFloat(hoursWorked) * HOURLY_RATE).toFixed(2);
                alert(`‚úÖ Clocked out successfully!\n\nHours worked: ${hoursWorked}\nPay earned: JMD ${pay}`);
                
                currentClockIn = null;
                updateClockUI(false, null);
                stopSessionTimer();
                loadTimeRecords();

            } catch (err) {
                console.error('Clock out exception:', err);
                alert('‚ùå An error occurred while clocking out.');
            }
        };

        function updateClockUI(isClockedIn, clockInTime) {
            const clockInBtn = document.getElementById('clock-in-btn');
            const clockOutBtn = document.getElementById('clock-out-btn');
            const clockStatus = document.getElementById('clock-status');
            const sessionInfo = document.getElementById('session-info');
            const sessionStart = document.getElementById('session-start');

            if (clockInBtn && clockOutBtn && clockStatus) {
                if (isClockedIn) {
                    clockInBtn.disabled = true;
                    clockOutBtn.disabled = false;
                    clockStatus.textContent = 'üü¢ Clocked In';
                    clockStatus.className = 'px-4 py-2 rounded-full text-sm font-semibold bg-green-100 text-green-800';
                    
                    if (sessionInfo && sessionStart) {
                        sessionInfo.classList.remove('hidden');
                        sessionStart.textContent = formatTime(clockInTime);
                    }
                } else {
                    clockInBtn.disabled = false;
                    clockOutBtn.disabled = true;
                    clockStatus.textContent = 'üî¥ Clocked Out';
                    clockStatus.className = 'px-4 py-2 rounded-full text-sm font-semibold bg-red-100 text-red-800';
                    
                    if (sessionInfo) {
                        sessionInfo.classList.add('hidden');
                    }
                }
            }
        }

        function startSessionTimer() {
            if (clockInterval) clearInterval(clockInterval);
            
            clockInterval = setInterval(() => {
                if (currentClockIn) {
                    const elapsed = new Date() - currentClockIn;
                    const hours = Math.floor(elapsed / (1000 * 60 * 60));
                    const minutes = Math.floor((elapsed % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((elapsed % (1000 * 60)) / 1000);
                    
                    const elapsedEl = document.getElementById('session-elapsed');
                    if (elapsedEl) {
                        elapsedEl.textContent = `${hours}h ${minutes}m ${seconds}s`;
                    }
                }
            }, 1000);
        }

        function stopSessionTimer() {
            if (clockInterval) {
                clearInterval(clockInterval);
                clockInterval = null;
            }
        }

        function updateCurrentTime() {
            const timeEl = document.getElementById('current-time');
            if (timeEl) {
                timeEl.textContent = formatTime(new Date());
            }
        }

        // Start the current time display
        setInterval(updateCurrentTime, 1000);

        // Helper function to calculate hours from clock_in and clock_out timestamps
        function calculateHoursFromRecord(record) {
            if (!record.clock_in || !record.clock_out) return 0;
            const clockIn = new Date(record.clock_in);
            const clockOut = new Date(record.clock_out);
            return (clockOut - clockIn) / (1000 * 60 * 60); // Convert ms to hours
        }

        window.loadTimeRecords = async function() {
            const isStaff = currentUser.role !== 'employee';
            const employeeId = isStaff 
                ? (document.getElementById('filter-employee-id')?.value || null)
                : currentUser.id;
            
            const startDate = document.getElementById('filter-start-date')?.value;
            const endDate = document.getElementById('filter-end-date')?.value;

            try {
                let query = client.from('attendance').select('*');
                
                if (employeeId) {
                    query = query.eq('employee_id', employeeId);
                }
                if (startDate) {
                    query = query.gte('date', startDate);
                }
                if (endDate) {
                    query = query.lte('date', endDate);
                }
                
                query = query.order('date', { ascending: false }).order('clock_in', { ascending: false });

                const { data, error } = await query;

                if (error) {
                    console.error('Error loading time records:', error);
                    return;
                }

                renderTimeRecords(data || []);
                calculateHoursSummary(data || []);
                
                // Check for active session
                if (currentUser.role === 'employee') {
                    checkActiveSession();
                }

            } catch (err) {
                console.error('Exception loading time records:', err);
            }
        };

        async function checkActiveSession() {
            try {
                const { data: activeSession, error } = await client
                    .from('attendance')
                    .select('*')
                    .eq('employee_id', currentUser.id)
                    .is('clock_out', null)
                    .single();

                if (activeSession) {
                    currentClockIn = new Date(activeSession.clock_in);
                    updateClockUI(true, currentClockIn);
                    startSessionTimer();
                } else {
                    updateClockUI(false, null);
                }
            } catch (err) {
                // No active session, which is fine
                updateClockUI(false, null);
            }
        }

        function renderTimeRecords(records) {
            const tbody = document.getElementById('time-records-body');
            if (!tbody) return;

            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No time records found.</td></tr>';
                return;
            }

            let totalHours = 0;
            let html = '';

            records.forEach(record => {
                const clockIn = record.clock_in ? formatTime(new Date(record.clock_in)) : '-';
                const clockOut = record.clock_out ? formatTime(new Date(record.clock_out)) : '<span class="text-yellow-600 font-semibold">In Progress</span>';
                
                // Calculate hours from timestamps
                const hoursWorked = calculateHoursFromRecord(record);
                const hours = hoursWorked > 0 ? hoursWorked.toFixed(2) : '-';
                const pay = hoursWorked > 0 ? (hoursWorked * HOURLY_RATE).toLocaleString() : '-';
                
                if (hoursWorked > 0) {
                    totalHours += hoursWorked;
                }

                html += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${record.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${clockIn}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${clockOut}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold">${hours}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-green-600">${pay !== '-' ? 'JMD ' + pay : '-'}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;

            // Update totals
            const totalHoursCell = document.getElementById('total-hours-cell');
            const totalPayCell = document.getElementById('total-pay-cell');
            
            if (totalHoursCell) totalHoursCell.textContent = totalHours.toFixed(2) + ' hrs';
            if (totalPayCell) totalPayCell.textContent = 'JMD ' + (totalHours * HOURLY_RATE).toLocaleString();
        }

        function calculateHoursSummary(records) {
            const today = new Date().toISOString().split('T')[0];
            const startOfWeek = getStartOfWeek(new Date()).toISOString().split('T')[0];
            const startOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];

            let todayHours = 0;
            let weekHours = 0;
            let monthHours = 0;

            records.forEach(record => {
                // Calculate hours from timestamps
                const hoursWorked = calculateHoursFromRecord(record);
                if (hoursWorked <= 0) return;
                
                if (record.date === today) {
                    todayHours += hoursWorked;
                }
                if (record.date >= startOfWeek) {
                    weekHours += hoursWorked;
                }
                if (record.date >= startOfMonth) {
                    monthHours += hoursWorked;
                }
            });

            const todayEl = document.getElementById('today-hours');
            const weekEl = document.getElementById('week-hours');
            const monthEl = document.getElementById('month-hours');
            const payEl = document.getElementById('est-pay');

            if (todayEl) todayEl.textContent = todayHours.toFixed(1);
            if (weekEl) weekEl.textContent = weekHours.toFixed(1);
            if (monthEl) monthEl.textContent = monthHours.toFixed(1);
            if (payEl) payEl.textContent = '$' + (monthHours * HOURLY_RATE).toLocaleString();
        }

        function getStartOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function formatTime(date) {
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
        }

        function renderSalaryCalc() {
             return `
                <div class="bg-white p-6 rounded-xl shadow-md max-w-2xl">
                    <h2 class="text-xl font-bold mb-4">Personal Salary Calculation</h2>
                    <p class="text-sm text-gray-500 mb-6">Calculations are run for your account (${currentUser.name}, ID: ${currentUser.id}).</p>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Total Hours Worked (This Month)</label>
                            <input type="number" id="calc-hours" value="0" class="w-full p-3 border rounded-lg bg-gray-50" readonly>
                        </div>

                        <div>
                        <label class="block text-sm font-medium text-gray-700">Hourly Pay Rate (JMD)</label>
                            <input type="number" value="700" class="w-full p-3 border rounded-lg bg-gray-50" readonly>
                        </div>
                    </div>

                    <button onclick="calculateSalary()" class="mt-6 py-3 px-6 text-white font-semibold rounded-xl accent-gradient hover:opacity-90 transition">
                        Calculate Gross & Net Pay
                    </button>

                    <div id="salary-result" class="mt-8 p-6 border border-purple-200 bg-purple-50 rounded-xl">
                        <h3 class="text-lg font-bold text-purple-800 mb-3">Calculation Summary</h3>
                        <div id="salary-breakdown" class="space-y-2 text-gray-700">
                            <p class="text-gray-500 text-center">Click "Calculate Gross & Net Pay" to see your salary breakdown</p>
                            </div>
                        </div>
                    </div>
            `;
        }

        // Auto-load salary calc data when page loads
        window.loadSalaryCalcData = async function() {
            try {
                const startOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];

                const { data, error } = await client
                    .from('attendance')
                    .select('*')
                    .eq('employee_id', currentUser.id)
                    .gte('date', startOfMonth)
                    .not('clock_out', 'is', null);

                if (data) {
                    // Calculate hours from timestamps
                    const totalHours = data.reduce((sum, r) => sum + calculateHoursFromRecord(r), 0);
                    const hoursEl = document.getElementById('calc-hours');
                    if (hoursEl) hoursEl.value = totalHours.toFixed(2);
                }
            } catch (err) {
                console.error('Error loading salary calc data:', err);
            }
        };

        window.calculateSalary = function() {
            const hoursEl = document.getElementById('calc-hours');
            const hours = parseFloat(hoursEl?.value || 0);
            
            const grossPay = hours * HOURLY_RATE;
            
            // Calculate Jamaican statutory deductions
            const nisDeduction = Math.min(grossPay * 0.03, 3000); // NIS: 3% capped
            const nhtDeduction = grossPay * 0.02; // NHT: 2%
            const educationTax = grossPay * 0.0225; // Education Tax: 2.25%
            
            // PAYE calculation (simplified)
            const annualizedGross = grossPay * 12;
            const taxThreshold = 1500096;
            const payeDeduction = annualizedGross > taxThreshold 
                ? ((annualizedGross - taxThreshold) * 0.25) / 12 
                : 0;
            
            const totalDeductions = nisDeduction + nhtDeduction + educationTax + payeDeduction;
            const netPay = grossPay - totalDeductions;

            const breakdownEl = document.getElementById('salary-breakdown');
            if (breakdownEl) {
                breakdownEl.innerHTML = `
                    <p class="flex justify-between"><span>Gross Pay (${hours.toFixed(1)}h @ JMD 700)</span> <span class="font-bold">JMD ${grossPay.toLocaleString()}</span></p>
                    <div class="pt-2 border-t border-purple-100 space-y-1">
                        <p class="flex justify-between text-sm"><span>NIS (3%)</span> <span class="text-red-600 font-semibold">-JMD ${nisDeduction.toLocaleString()}</span></p>
                        <p class="flex justify-between text-sm"><span>NHT (2%)</span> <span class="text-red-600 font-semibold">-JMD ${nhtDeduction.toLocaleString()}</span></p>
                        <p class="flex justify-between text-sm"><span>Education Tax (2.25%)</span> <span class="text-red-600 font-semibold">-JMD ${educationTax.toLocaleString()}</span></p>
                        <p class="flex justify-between text-sm"><span>PAYE</span> <span class="text-red-600 font-semibold">-JMD ${payeDeduction.toLocaleString()}</span></p>
                        <p class="flex justify-between text-sm font-medium"><span>Total Deductions</span> <span class="text-red-600">-JMD ${totalDeductions.toLocaleString()}</span></p>
                </div>
                    <p class="flex justify-between text-lg font-extrabold text-indigo-700 pt-3 border-t-2 border-indigo-200"><span>NET SALARY</span> <span>JMD ${netPay.toLocaleString()}</span></p>
            `;
        }
        };

        function renderEmployeeDataRequest(type) {
            const isStaff = currentUser.role !== 'employee';
            const title = type === 'payslips' ? 'Access My Payslips' : 'Request My Payroll Data';
            const description = type === 'payslips' ? `Quickly retrieve and download your individual payslips.` : `Request a detailed report of your payroll records (e.g., salary, deductions).`;
            const staffPrompt = type === 'payslips' ? 'Enter Employee ID to Generate Payslip' : 'Enter Employee ID for Payroll Data';

             return `
                <div class="bg-white p-6 rounded-xl shadow-md max-w-4xl">
                    <h2 class="text-xl font-bold mb-4">${isStaff ? staffPrompt : title}</h2>
                    <p class="text-sm text-gray-500 mb-6">${description}</p>

                    <div class="grid grid-cols-1 ${isStaff ? 'md:grid-cols-3' : 'md:grid-cols-2'} gap-4 mb-6">
                        ${isStaff ? `<input type="text" id="payslip-emp-id" placeholder="Employee ID" class="p-3 border rounded-lg">` : ''}
                        <input type="date" id="payslip-start-date" class="p-3 border rounded-lg">
                        <input type="date" id="payslip-end-date" class="p-3 border rounded-lg">
                    </div>

                    <button onclick="loadPayslipRecords('${type}')" class="py-3 px-6 text-white font-semibold rounded-xl accent-gradient hover:opacity-90 transition">
                        Search & Retrieve Records
                    </button>

                    <div class="mt-8">
                        <h3 class="text-lg font-semibold mb-2">Retrieved ${type === 'payslips' ? 'Payslips' : 'Reports'}</h3>
                        <div id="payslip-records-list" class="space-y-4">
                            <p class="text-gray-500 text-center py-4">Click "Search & Retrieve Records" to load your ${type === 'payslips' ? 'payslips' : 'payroll data'}.</p>
                           </div>
                    </div>
                </div>
            `;
        }

        window.loadPayslipRecords = async function(type) {
            const isStaff = currentUser.role !== 'employee';
            const empId = isStaff 
                ? document.getElementById('payslip-emp-id')?.value.trim().toUpperCase()
                : currentUser.id;
            const startDate = document.getElementById('payslip-start-date')?.value;
            const endDate = document.getElementById('payslip-end-date')?.value;

            if (isStaff && !empId) {
                alert('‚ùå Please enter an Employee ID.');
                return;
            }

            const listContainer = document.getElementById('payslip-records-list');
            if (!listContainer) return;

            listContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Loading...</p>';

            try {
                let query = client.from('payroll_records').select('*').eq('employee_id', empId);
                
                if (startDate) query = query.gte('period_start', startDate);
                if (endDate) query = query.lte('period_end', endDate);
                
                query = query.order('period_end', { ascending: false });

                const { data, error } = await query;

                if (error) {
                    console.error('Error loading payroll records:', error);
                    listContainer.innerHTML = '<p class="text-red-500 text-center py-4">Error loading records.</p>';
                    return;
                }

                if (!data || data.length === 0) {
                    listContainer.innerHTML = `
                        <p class="text-gray-500 text-center py-4">No ${type === 'payslips' ? 'payslips' : 'payroll records'} found for this period.</p>
                        <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg mt-4">
                            <p class="text-sm text-yellow-800"><strong>Note:</strong> Payroll records are created when an admin runs payroll generation. If you've worked hours but don't see records, please contact your administrator.</p>
                        </div>
                    `;
                    return;
                }

                listContainer.innerHTML = data.map(record => `
                    <div class="p-4 border rounded-lg bg-gray-50 hover:bg-gray-100 transition">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-semibold text-gray-800">${type === 'payslips' ? 'Payslip' : 'Report'} - ${formatPeriod(record.period_start, record.period_end)}</h4>
                                <p class="text-sm text-gray-600 mt-1">Employee: ${record.employee_name || record.employee_id}</p>
                            </div>
                            <button onclick="viewPayslipDetail('${record.id}')" class="text-purple-600 hover:text-indigo-600 text-sm font-semibold">
                                View Details
                                </button>
                           </div>
                        <div class="grid grid-cols-3 gap-4 mt-3 text-sm">
                            <div>
                                <p class="text-gray-500">Hours Worked</p>
                                <p class="font-semibold">${record.total_hours?.toFixed(2) || 0} hrs</p>
                        </div>
                            <div>
                                <p class="text-gray-500">Gross Pay</p>
                                <p class="font-semibold">JMD ${record.gross_pay?.toLocaleString() || 0}</p>
                    </div>
                            <div>
                                <p class="text-gray-500">Net Pay</p>
                                <p class="font-semibold text-green-600">JMD ${record.net_pay?.toLocaleString() || 0}</p>
                </div>
                        </div>
                    </div>
                `).join('');

            } catch (err) {
                console.error('Exception loading payroll records:', err);
                listContainer.innerHTML = '<p class="text-red-500 text-center py-4">An error occurred.</p>';
            }
        };

        function formatPeriod(start, end) {
            const startDate = new Date(start);
            const endDate = new Date(end);
            const options = { month: 'short', year: 'numeric' };
            return `${startDate.toLocaleDateString('en-US', options)} - ${endDate.toLocaleDateString('en-US', options)}`;
        }

        window.viewPayslipDetail = async function(recordId) {
            try {
                const { data, error } = await client
                    .from('payroll_records')
                    .select('*')
                    .eq('id', recordId)
                    .single();

                if (error || !data) {
                    showToast('Could not load payslip details.', 'error');
                    return;
                }

                const eduTax = data.education_tax || 0;
                
                // Create and show modal
                const modal = document.createElement('div');
                modal.id = 'payslip-modal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full mx-4 overflow-hidden">
                        <div class="accent-gradient px-6 py-4">
                            <h3 class="text-xl font-bold text-white">Payslip Details</h3>
                            <p class="text-purple-100 text-sm">${data.period_start} to ${data.period_end}</p>
                        </div>
                        <div class="p-6">
                            <div class="mb-4 pb-4 border-b">
                                <p class="text-sm text-gray-500">Employee</p>
                                <p class="text-lg font-bold text-gray-800">${data.employee_name || data.employee_id}</p>
                            </div>
                            
                            <div class="mb-4">
                                <p class="font-semibold text-gray-700 mb-2">Earnings</p>
                                <div class="space-y-1 text-sm">
                                    <div class="flex justify-between"><span>Hours Worked:</span><span>${(data.total_hours || 0).toFixed(2)} hrs</span></div>
                                    <div class="flex justify-between"><span>Hourly Rate:</span><span>JMD ${data.hourly_rate || HOURLY_RATE}</span></div>
                                    <div class="flex justify-between font-semibold text-blue-600"><span>Gross Pay:</span><span>JMD ${(data.gross_pay || 0).toLocaleString()}</span></div>
                                </div>
                            </div>
                            
                            <div class="mb-4 p-3 bg-red-50 rounded-lg">
                                <p class="font-semibold text-red-700 mb-2">Deductions</p>
                                <div class="space-y-1 text-sm">
                                    <div class="flex justify-between"><span>NIS (3%):</span><span class="text-red-600">-JMD ${(data.nis || 0).toLocaleString()}</span></div>
                                    <div class="flex justify-between"><span>NHT (2%):</span><span class="text-red-600">-JMD ${(data.nht || 0).toLocaleString()}</span></div>
                                    <div class="flex justify-between"><span>Education Tax (2.25%):</span><span class="text-red-600">-JMD ${eduTax.toLocaleString()}</span></div>
                                    <div class="flex justify-between"><span>PAYE:</span><span class="text-red-600">-JMD ${(data.paye || 0).toLocaleString()}</span></div>
                                    <div class="flex justify-between font-semibold border-t pt-1 mt-1"><span>Total Deductions:</span><span class="text-red-600">-JMD ${(data.total_deductions || 0).toLocaleString()}</span></div>
                                </div>
                            </div>
                            
                            <div class="p-4 bg-green-100 rounded-lg">
                                <div class="flex justify-between items-center">
                                    <span class="text-lg font-bold text-green-800">NET PAY</span>
                                    <span class="text-2xl font-extrabold text-green-800">JMD ${(data.net_pay || 0).toLocaleString()}</span>
                                </div>
                            </div>
                            
                            <p class="text-xs text-gray-400 mt-4 text-center">Generated: ${new Date(data.calculated_at).toLocaleString()}</p>
                        </div>
                        <div class="px-6 py-4 bg-gray-50 border-t flex justify-end">
                            <button onclick="closePayslipModal()" class="py-2 px-6 text-gray-600 font-semibold rounded-lg border border-gray-300 hover:bg-gray-100 transition">Close</button>
                    </div>
                </div>
            `;
                modal.onclick = function(e) {
                    if (e.target === modal) closePayslipModal();
                };
                document.body.appendChild(modal);
                
            } catch (err) {
                console.error('Error viewing payslip:', err);
                showToast('Error loading payslip details.', 'error');
            }
        };
        
        window.closePayslipModal = function() {
            const modal = document.getElementById('payslip-modal');
            if (modal) modal.remove();
        };

        function renderAdminEmployeeManagement() {
             return `
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-bold mb-4">Manage Employee Records</h2>

                    <div class="flex space-x-4 mb-6">
                        <input type="text" id="emp-search" placeholder="Search by ID or Name" class="p-3 border rounded-lg flex-grow" onkeyup="searchEmployees()">
                        <button onclick="showAddEmployeeModal()" class="py-2 px-4 text-white font-semibold rounded-lg accent-gradient">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-plus inline mr-1"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></svg>
                            Add New Employee
                        </button>
                    </div>

                    <!-- Employee List Table -->
                    <div class="mb-6 overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 border rounded-lg">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Username</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="employee-list" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="5" class="px-4 py-3 text-center text-gray-500">Loading employees...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="grid grid-cols-2 gap-6 mt-6">
                        <!-- Employee Detail Card -->
                        <div id="employee-detail-card" class="p-4 border border-gray-200 rounded-xl bg-gray-50">
                            <h3 class="text-lg font-bold mb-3 accent-gradient bg-clip-text text-transparent">Employee Details</h3>
                            <p class="text-sm text-gray-500">Select an employee from the list above to view details.</p>
                        </div>

                        <!-- Employee Stats Section -->
                        <div id="employee-stats-card" class="p-4 border border-gray-200 rounded-xl">
                            <h3 class="text-lg font-bold mb-3 text-gray-800">Employee Statistics</h3>
                            <p class="text-sm text-gray-500">Select an employee to view their work statistics.</p>
                        </div>
                    </div>
                </div>

                <!-- Add/Edit Employee Modal -->
                <div id="employee-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
                    <div class="bg-white p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                        <h3 id="modal-title" class="text-xl font-bold mb-4">Add New Employee</h3>
                        <div class="space-y-4">
                            <input type="text" id="modal-emp-id" placeholder="Employee ID (e.g., E001)" class="w-full p-3 border rounded-lg">
                            <input type="text" id="modal-emp-name" placeholder="Full Name" class="w-full p-3 border rounded-lg">
                            <input type="text" id="modal-emp-username" placeholder="Username" class="w-full p-3 border rounded-lg">
                            <input type="password" id="modal-emp-password" placeholder="Password" class="w-full p-3 border rounded-lg">
                            <select id="modal-emp-role" class="w-full p-3 border rounded-lg bg-white">
                                <option value="employee">Employee</option>
                                <option value="admin">Admin</option>
                                <option value="ceo">CEO</option>
                            </select>
                        </div>
                        <div class="flex space-x-3 mt-6">
                            <button onclick="saveEmployee()" class="flex-1 py-2 text-white font-semibold rounded-lg accent-gradient">Save</button>
                            <button onclick="closeEmployeeModal()" class="flex-1 py-2 text-gray-600 font-semibold rounded-lg border border-gray-300 hover:bg-gray-50">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Employee Management Functions
        let allEmployees = [];
        let editingEmployeeId = null;

        window.loadEmployeeList = async function() {
            try {
                const { data, error } = await client
                    .from('users')
                    .select('*')
                    .order('name');

                if (error) {
                    console.error('Error loading employees:', error);
                    return;
                }

                allEmployees = data || [];
                renderEmployeeList(allEmployees);
            } catch (err) {
                console.error('Exception loading employees:', err);
            }
        };

        function renderEmployeeList(employees) {
            const tbody = document.getElementById('employee-list');
            if (!tbody) return;

            if (employees.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-3 text-center text-gray-500">No employees found.</td></tr>';
                return;
            }

            tbody.innerHTML = employees.map(emp => `
                <tr class="hover:bg-gray-50 cursor-pointer" onclick="selectEmployee('${emp.id}')">
                    <td class="px-4 py-3 font-medium">${emp.id}</td>
                    <td class="px-4 py-3">${emp.name}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 text-xs rounded-full ${emp.role === 'employee' ? 'bg-blue-100 text-blue-800' : emp.role === 'admin' ? 'bg-purple-100 text-purple-800' : 'bg-red-100 text-red-800'}">
                            ${emp.role.toUpperCase()}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-gray-600">${emp.username}</td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="event.stopPropagation(); editEmployee('${emp.id}')" class="text-indigo-600 hover:text-indigo-800 mr-2">Edit</button>
                        <button onclick="event.stopPropagation(); deleteEmployee('${emp.id}')" class="text-red-600 hover:text-red-800">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        window.searchEmployees = function() {
            const query = document.getElementById('emp-search')?.value.toLowerCase() || '';
            const filtered = allEmployees.filter(emp => 
                emp.id.toLowerCase().includes(query) || 
                emp.name.toLowerCase().includes(query) ||
                emp.username.toLowerCase().includes(query)
            );
            renderEmployeeList(filtered);
        };

        window.selectEmployee = async function(empId) {
            const emp = allEmployees.find(e => e.id === empId);
            if (!emp) return;

            // Update detail card
            const detailCard = document.getElementById('employee-detail-card');
            if (detailCard) {
                detailCard.innerHTML = `
                    <h3 class="text-lg font-bold mb-3 accent-gradient bg-clip-text text-transparent">Employee Details (${emp.id})</h3>
                            <div class="space-y-2">
                        <p class="text-sm"><strong>Name:</strong> ${emp.name}</p>
                        <p class="text-sm"><strong>Username:</strong> ${emp.username}</p>
                        <p class="text-sm"><strong>Role:</strong> ${emp.role.charAt(0).toUpperCase() + emp.role.slice(1)}</p>
                        <p class="text-sm"><strong>Employee ID:</strong> ${emp.id}</p>
                            </div>
                            <div class="mt-4 flex space-x-2">
                        <button onclick="editEmployee('${emp.id}')" class="py-1 px-3 text-sm rounded-lg text-white bg-indigo-500 hover:bg-indigo-600">Edit</button>
                        <button onclick="deleteEmployee('${emp.id}')" class="py-1 px-3 text-sm rounded-lg text-white bg-red-500 hover:bg-red-600">Delete</button>
                            </div>
                `;
            }

            // Load and display employee stats
            await loadEmployeeStats(empId);
        };

        async function loadEmployeeStats(empId) {
            const statsCard = document.getElementById('employee-stats-card');
            if (!statsCard) return;

            try {
                // Get attendance records for this employee
                const startOfYear = new Date(new Date().getFullYear(), 0, 1).toISOString().split('T')[0];
                const { data: attendance, error: attError } = await client
                    .from('attendance')
                    .select('*')
                    .eq('employee_id', empId)
                    .gte('date', startOfYear)
                    .not('clock_out', 'is', null);

                let totalHours = 0;
                let totalDays = new Set();

                if (attendance) {
                    attendance.forEach(record => {
                        totalHours += calculateHoursFromRecord(record);
                        totalDays.add(record.date);
                    });
                }

                const estimatedPay = totalHours * HOURLY_RATE;

                statsCard.innerHTML = `
                    <h3 class="text-lg font-bold mb-3 text-gray-800">Employee Statistics (${empId})</h3>
                            <ul class="space-y-2 text-sm text-gray-600">
                        <li class="flex justify-between"><span>Hourly Rate:</span> <span class="font-semibold">JMD ${HOURLY_RATE}</span></li>
                        <li class="flex justify-between"><span>Hours Worked (YTD):</span> <span class="font-semibold">${totalHours.toFixed(2)} hrs</span></li>
                        <li class="flex justify-between"><span>Days Worked (YTD):</span> <span class="font-semibold">${totalDays.size} days</span></li>
                        <li class="flex justify-between"><span>Est. Gross Pay (YTD):</span> <span class="font-semibold text-green-600">JMD ${estimatedPay.toLocaleString()}</span></li>
                            </ul>
                    <button onclick="loadPage('view_hours')" class="w-full mt-4 py-2 text-sm rounded-lg text-purple-600 border border-purple-600 hover:bg-purple-50 transition">
                        View Full Time Records
                            </button>
                `;
            } catch (err) {
                console.error('Error loading employee stats:', err);
                statsCard.innerHTML = '<p class="text-red-500">Error loading statistics.</p>';
            }
        }

        window.showAddEmployeeModal = function() {
            editingEmployeeId = null;
            document.getElementById('modal-title').textContent = 'Add New Employee';
            document.getElementById('modal-emp-id').value = '';
            document.getElementById('modal-emp-id').disabled = false;
            document.getElementById('modal-emp-name').value = '';
            document.getElementById('modal-emp-username').value = '';
            document.getElementById('modal-emp-password').value = '';
            document.getElementById('modal-emp-role').value = 'employee';
            document.getElementById('employee-modal').classList.remove('hidden');
        };

        window.editEmployee = function(empId) {
            const emp = allEmployees.find(e => e.id === empId);
            if (!emp) return;

            editingEmployeeId = empId;
            document.getElementById('modal-title').textContent = 'Edit Employee';
            document.getElementById('modal-emp-id').value = emp.id;
            document.getElementById('modal-emp-id').disabled = true;
            document.getElementById('modal-emp-name').value = emp.name;
            document.getElementById('modal-emp-username').value = emp.username;
            document.getElementById('modal-emp-password').value = '';
            document.getElementById('modal-emp-role').value = emp.role;
            document.getElementById('employee-modal').classList.remove('hidden');
        };

        window.closeEmployeeModal = function() {
            document.getElementById('employee-modal').classList.add('hidden');
            editingEmployeeId = null;
        };

        window.saveEmployee = async function() {
            const id = document.getElementById('modal-emp-id').value.trim().toUpperCase();
            const name = document.getElementById('modal-emp-name').value.trim();
            const username = document.getElementById('modal-emp-username').value.trim();
            const password = document.getElementById('modal-emp-password').value.trim();
            const role = document.getElementById('modal-emp-role').value;

            if (!id || !name || !username) {
                alert('‚ùå Please fill in ID, Name, and Username.');
                return;
            }

            try {
                if (editingEmployeeId) {
                    // Update existing employee
                    const updateData = { name, username, role };
                    if (password) updateData.password = password;

                    const { error } = await client
                        .from('users')
                        .update(updateData)
                        .eq('id', editingEmployeeId);

                    if (error) throw error;
                    alert('‚úÖ Employee updated successfully!');
                } else {
                    // Create new employee
                    if (!password) {
                        alert('‚ùå Password is required for new employees.');
                        return;
                    }

                    const { error } = await client
                        .from('users')
                        .insert([{ id, name, username, password, role }]);

                    if (error) throw error;
                    alert('‚úÖ Employee added successfully!');
                }

                closeEmployeeModal();
                loadEmployeeList();
            } catch (err) {
                console.error('Error saving employee:', err);
                alert('‚ùå Failed to save employee: ' + err.message);
            }
        };

        window.deleteEmployee = async function(empId) {
            if (!confirm(`‚ö†Ô∏è Are you sure you want to delete employee ${empId}? This action cannot be undone.`)) {
                return;
            }

            try {
                const { error } = await client
                    .from('users')
                    .delete()
                    .eq('id', empId);

                if (error) throw error;
                alert('‚úÖ Employee deleted successfully!');
                loadEmployeeList();
                
                // Clear detail cards
                document.getElementById('employee-detail-card').innerHTML = '<h3 class="text-lg font-bold mb-3 accent-gradient bg-clip-text text-transparent">Employee Details</h3><p class="text-sm text-gray-500">Select an employee from the list above to view details.</p>';
                document.getElementById('employee-stats-card').innerHTML = '<h3 class="text-lg font-bold mb-3 text-gray-800">Employee Statistics</h3><p class="text-sm text-gray-500">Select an employee to view their work statistics.</p>';
            } catch (err) {
                console.error('Error deleting employee:', err);
                alert('‚ùå Failed to delete employee: ' + err.message);
            }
        };

         function renderPayrollGeneration() {
            return `
                <div class="bg-white p-6 rounded-xl shadow-md max-w-4xl">
                    <h2 class="text-xl font-bold mb-4">Generate Payroll & Payslip Reports</h2>

                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <input type="date" id="payroll-start-date" placeholder="Payroll Start Date" class="p-3 border rounded-lg">
                        <input type="date" id="payroll-end-date" placeholder="Payroll End Date" class="p-3 border rounded-lg">
                    </div>

                    <div class="p-4 border border-indigo-200 bg-indigo-50 rounded-xl mb-6">
                        <p class="font-semibold text-indigo-700">Payroll Configuration:</p>
                        <p class="text-sm text-indigo-600">Hourly Rate: <strong>JMD 700/hour</strong> for all employees</p>
                        <p class="text-sm text-indigo-600 mt-1">Statutory Deductions (PAYE, NIS, NHT) will be calculated based on Jamaican tax laws.</p>
                    </div>

                    <button onclick="generatePayroll()" class="py-3 px-6 text-white font-semibold rounded-xl accent-gradient hover:opacity-90 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-play inline mr-2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                        Run Full Payroll Calculation
                    </button>

                    <div id="payroll-results" class="mt-8 hidden">
                        <h3 class="text-lg font-semibold mb-4">Payroll Calculation Results</h3>
                        <div id="payroll-summary" class="mb-6"></div>
                        <div id="payroll-details"></div>
                    </div>

                    <div class="mt-8">
                        <h3 class="text-lg font-semibold mb-2">Payroll Statement Options</h3>
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                            <button onclick="generateAllPayslips()" class="p-4 bg-gray-50 hover:bg-gray-100 rounded-xl shadow-sm border text-gray-700 text-center transition">
                                ${getIcon('file-text', 'text-indigo-500 mx-auto mb-1')}
                                <span class="text-xs font-semibold block">Payslips (All)</span>
                            </button>
                            <button onclick="viewPayrollSummary()" class="p-4 bg-gray-50 hover:bg-gray-100 rounded-xl shadow-sm border text-gray-700 text-center transition">
                                ${getIcon('list-ordered', 'text-indigo-500 mx-auto mb-1')}
                                <span class="text-xs font-semibold block">Payroll Summary</span>
                            </button>
                            <button onclick="viewPayrollJournal()" class="p-4 bg-gray-50 hover:bg-gray-100 rounded-xl shadow-sm border text-gray-700 text-center transition">
                                ${getIcon('book-open-check', 'text-indigo-500 mx-auto mb-1')}
                                <span class="text-xs font-semibold block">Payroll Journal</span>
                            </button>
                            <button onclick="exportPayrollData()" class="p-4 bg-gray-50 hover:bg-gray-100 rounded-xl shadow-sm border text-gray-700 text-center transition">
                                ${getIcon('download', 'text-indigo-500 mx-auto mb-1')}
                                <span class="text-xs font-semibold block">Export to CSV</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Payroll Generation Function
        window.generatePayroll = async function() {
            const startDate = document.getElementById('payroll-start-date').value;
            const endDate = document.getElementById('payroll-end-date').value;

            if (!startDate || !endDate) {
                alert('‚ùå Please select both start and end dates for the payroll period.');
                return;
            }

            try {
                // Get all employees
                const { data: employees, error: empError } = await client
                    .from('users')
                    .select('*')
                    .eq('role', 'employee');

                if (empError) {
                    console.error('Error fetching employees:', empError);
                    alert('‚ùå Failed to fetch employees: ' + empError.message);
                    return;
                }

                // Get all attendance records for the period (completed shifts only)
                const { data: attendanceRecords, error: attendanceError } = await client
                    .from('attendance')
                    .select('*')
                    .gte('date', startDate)
                    .lte('date', endDate)
                    .not('clock_out', 'is', null);

                if (attendanceError) {
                    console.error('Error fetching attendance records:', attendanceError);
                    alert('‚ùå Failed to fetch attendance records: ' + attendanceError.message);
                    return;
                }

                // Calculate payroll for each employee
                const payrollData = [];
                let totalGross = 0;
                let totalDeductions = 0;
                let totalNet = 0;
                let totalHours = 0;

                employees.forEach(emp => {
                    const empRecords = attendanceRecords.filter(r => r.employee_id === emp.id);
                    // Calculate hours from timestamps
                    const hoursWorked = empRecords.reduce((sum, r) => sum + calculateHoursFromRecord(r), 0);
                    
                    const grossPay = hoursWorked * HOURLY_RATE;
                    
                    // Calculate Jamaican statutory deductions
                    const nisDeduction = Math.min(grossPay * 0.03, 3000); // NIS: 3% capped at $3,000
                    const nhtDeduction = grossPay * 0.02; // NHT: 2%
                    const educationTax = grossPay * 0.0225; // Education Tax: 2.25%
                    
                    // PAYE calculation (simplified - 25% on income over threshold)
                    const annualizedGross = grossPay * 12;
                    const taxThreshold = 1500096; // Annual tax-free threshold
                    const payeDeduction = annualizedGross > taxThreshold 
                        ? ((annualizedGross - taxThreshold) * 0.25) / 12 
                        : 0;
                    
                    const totalDed = nisDeduction + nhtDeduction + educationTax + payeDeduction;
                    const netPay = grossPay - totalDed;

                    totalHours += hoursWorked;
                    totalGross += grossPay;
                    totalDeductions += totalDed;
                    totalNet += netPay;

                    payrollData.push({
                        id: emp.id,
                        name: emp.name,
                        hours: hoursWorked,
                        gross: grossPay,
                        nis: nisDeduction,
                        nht: nhtDeduction,
                        eduTax: educationTax,
                        paye: payeDeduction,
                        deductions: totalDed,
                        net: netPay
                    });
                });

                // Display results
                displayPayrollResults(payrollData, {
                    startDate,
                    endDate,
                    totalHours,
                    totalGross,
                    totalDeductions,
                    totalNet
                });

                // Ask if user wants to save payroll records
                if (payrollData.length > 0 && confirm('‚úÖ Payroll calculated successfully!\n\nWould you like to save these payroll records to the database?\n\nThis will make payslips available for employees to view.')) {
                    await savePayrollRecords(payrollData, startDate, endDate);
                }

            } catch (err) {
                console.error('Payroll generation exception:', err);
                alert('‚ùå An error occurred while generating payroll.');
            }
        };

        async function savePayrollRecords(payrollData, startDate, endDate) {
            try {
                const records = payrollData.map(emp => ({
                    employee_id: emp.id,
                    employee_name: emp.name,
                    period_start: startDate,
                    period_end: endDate,
                    total_hours: emp.hours,
                    hourly_rate: HOURLY_RATE,
                    gross_pay: emp.gross,
                    paye: emp.paye,
                    nis: emp.nis,
                    nht: emp.nht,
                    education_tax: emp.eduTax,
                    total_deductions: emp.deductions,
                    net_pay: emp.net,
                    calculated_at: new Date().toISOString()
                }));

                const { error } = await client
                    .from('payroll_records')
                    .insert(records);

                if (error) {
                    console.error('Error saving payroll records:', error);
                    alert('‚ùå Failed to save payroll records: ' + error.message);
                    return;
                }

                alert('‚úÖ Payroll records saved successfully!\n\nEmployees can now view their payslips.');
            } catch (err) {
                console.error('Exception saving payroll records:', err);
                alert('‚ùå An error occurred while saving payroll records.');
            }
        }

        function displayPayrollResults(payrollData, totals) {
            const resultsDiv = document.getElementById('payroll-results');
            const summaryDiv = document.getElementById('payroll-summary');
            const detailsDiv = document.getElementById('payroll-details');

            if (!resultsDiv || !summaryDiv || !detailsDiv) return;

            // Store for later use by viewPayrollBreakdown
            currentPayrollData = payrollData;

            resultsDiv.classList.remove('hidden');

            // Summary Cards
            summaryDiv.innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="p-4 bg-blue-50 rounded-xl border border-blue-200">
                        <p class="text-xs text-blue-600 font-medium">Period</p>
                        <p class="text-sm font-bold text-blue-800">${totals.startDate} to ${totals.endDate}</p>
                    </div>
                    <div class="p-4 bg-purple-50 rounded-xl border border-purple-200">
                        <p class="text-xs text-purple-600 font-medium">Total Hours</p>
                        <p class="text-2xl font-bold text-purple-800">${totals.totalHours.toFixed(2)}</p>
                    </div>
                    <div class="p-4 bg-green-50 rounded-xl border border-green-200">
                        <p class="text-xs text-green-600 font-medium">Total Gross Pay</p>
                        <p class="text-xl font-bold text-green-800">JMD ${totals.totalGross.toLocaleString()}</p>
                    </div>
                    <div class="p-4 bg-indigo-50 rounded-xl border border-indigo-200">
                        <p class="text-xs text-indigo-600 font-medium">Total Net Pay</p>
                        <p class="text-xl font-bold text-indigo-800">JMD ${totals.totalNet.toLocaleString()}</p>
                    </div>
                </div>
            `;

            // Detailed Table
            let tableRows = '';
            payrollData.forEach(emp => {
                tableRows += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 font-medium">${emp.id}</td>
                        <td class="px-4 py-3">${emp.name}</td>
                        <td class="px-4 py-3 text-center">${emp.hours.toFixed(2)}</td>
                        <td class="px-4 py-3 text-right">JMD ${emp.gross.toLocaleString()}</td>
                        <td class="px-4 py-3 text-right text-red-600">JMD ${emp.deductions.toLocaleString()}</td>
                        <td class="px-4 py-3 text-right font-bold text-green-600">JMD ${emp.net.toLocaleString()}</td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="viewPayrollBreakdown('${emp.id}')" class="text-purple-600 hover:text-purple-800 text-sm">View</button>
                        </td>
                    </tr>
                `;
            });

            detailsDiv.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 border rounded-lg">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Hours</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Gross Pay</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Deductions</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Net Pay</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Details</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${tableRows || '<tr><td colspan="7" class="px-4 py-3 text-center text-gray-500">No employees found with time records.</td></tr>'}
                        </tbody>
                        <tfoot class="bg-gray-100 font-bold">
                            <tr>
                                <td colspan="2" class="px-4 py-3">TOTALS</td>
                                <td class="px-4 py-3 text-center">${totals.totalHours.toFixed(2)}</td>
                                <td class="px-4 py-3 text-right">JMD ${totals.totalGross.toLocaleString()}</td>
                                <td class="px-4 py-3 text-right text-red-600">JMD ${totals.totalDeductions.toLocaleString()}</td>
                                <td class="px-4 py-3 text-right text-green-600">JMD ${totals.totalNet.toLocaleString()}</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-xl">
                    <p class="text-sm text-yellow-800"><strong>Rate Applied:</strong> JMD 700 per hour for all employees</p>
                    <p class="text-xs text-yellow-700 mt-1">Deductions include: NIS (3%), NHT (2%), Education Tax (2.25%), PAYE (25% on income above threshold)</p>
                </div>
            `;
        }

        // Store current payroll data for report generation
        let currentPayrollData = [];

        window.viewPayrollBreakdown = function(empId) {
            const emp = currentPayrollData.find(e => e.id === empId);
            if (!emp) {
                alert('Employee data not found.');
                return;
            }

            const breakdown = `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
PAYROLL BREAKDOWN: ${emp.name} (${emp.id})
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

EARNINGS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Hours Worked:      ${emp.hours.toFixed(2)} hrs
Hourly Rate:       JMD ${HOURLY_RATE}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
GROSS PAY:         JMD ${emp.gross.toLocaleString()}

STATUTORY DEDUCTIONS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
NIS (3%):          -JMD ${emp.nis.toLocaleString()}
NHT (2%):          -JMD ${emp.nht.toLocaleString()}
Education Tax:     -JMD ${emp.eduTax.toLocaleString()}
PAYE:              -JMD ${emp.paye.toLocaleString()}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Total Deductions:  -JMD ${emp.deductions.toLocaleString()}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
NET PAY:           JMD ${emp.net.toLocaleString()}
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            `;
            alert(breakdown);
        };

        // Generate all payslips function
        window.generateAllPayslips = async function() {
            const startDate = document.getElementById('payroll-start-date').value;
            const endDate = document.getElementById('payroll-end-date').value;

            if (!startDate || !endDate) {
                alert('‚ùå Please select the payroll period dates first.');
                return;
            }

            try {
                const { data: payrollRecords, error } = await client
                    .from('payroll_records')
                    .select('*')
                    .gte('period_start', startDate)
                    .lte('period_end', endDate);

                if (error) throw error;

                if (!payrollRecords || payrollRecords.length === 0) {
                    alert('‚ùå No payroll records found for this period. Please run payroll generation first.');
                    return;
                }

                // Create printable payslips
                let payslipsHTML = `
                    <html><head><title>Payslips - ${startDate} to ${endDate}</title>
                    <style>
                        body { font-family: Arial, sans-serif; }
                        .payslip { page-break-after: always; padding: 20px; border: 2px solid #333; margin: 20px; }
                        .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
                        .row { display: flex; justify-content: space-between; padding: 5px 0; }
                        .section { margin: 15px 0; }
                        .section-title { font-weight: bold; border-bottom: 1px solid #ccc; margin-bottom: 10px; }
                        .total { font-size: 1.2em; font-weight: bold; background: #f0f0f0; padding: 10px; }
                    </style></head><body>
                `;

                payrollRecords.forEach(record => {
                    payslipsHTML += `
                        <div class="payslip">
                            <div class="header">
                                <h1>PayFlow - Employee Payslip</h1>
                                <p>Period: ${record.period_start} to ${record.period_end}</p>
                            </div>
                            <div class="section">
                                <div class="section-title">EMPLOYEE DETAILS</div>
                                <div class="row"><span>Name:</span><span>${record.employee_name || record.employee_id}</span></div>
                                <div class="row"><span>Employee ID:</span><span>${record.employee_id}</span></div>
                            </div>
                            <div class="section">
                                <div class="section-title">EARNINGS</div>
                                <div class="row"><span>Hours Worked:</span><span>${record.total_hours?.toFixed(2) || 0} hrs</span></div>
                                <div class="row"><span>Hourly Rate:</span><span>JMD ${record.hourly_rate || HOURLY_RATE}</span></div>
                                <div class="row"><span><strong>Gross Pay:</strong></span><span><strong>JMD ${record.gross_pay?.toLocaleString() || 0}</strong></span></div>
                            </div>
                            <div class="section">
                                <div class="section-title">DEDUCTIONS</div>
                                <div class="row"><span>NIS (3%):</span><span>-JMD ${record.nis?.toLocaleString() || 0}</span></div>
                                <div class="row"><span>NHT (2%):</span><span>-JMD ${record.nht?.toLocaleString() || 0}</span></div>
                                <div class="row"><span>PAYE:</span><span>-JMD ${record.paye?.toLocaleString() || 0}</span></div>
                                <div class="row"><span><strong>Total Deductions:</strong></span><span><strong>-JMD ${record.total_deductions?.toLocaleString() || 0}</strong></span></div>
                            </div>
                            <div class="total">
                                <div class="row"><span>NET PAY:</span><span>JMD ${record.net_pay?.toLocaleString() || 0}</span></div>
                            </div>
                            <p style="margin-top: 20px; font-size: 12px; color: #666;">Generated: ${new Date().toLocaleString()}</p>
                        </div>
                    `;
                });

                payslipsHTML += '</body></html>';

                // Open in new window for printing
                const printWindow = window.open('', '_blank');
                printWindow.document.write(payslipsHTML);
                printWindow.document.close();
                printWindow.print();

            } catch (err) {
                console.error('Error generating payslips:', err);
                alert('‚ùå Error generating payslips: ' + err.message);
            }
        };

        // View payroll summary
        window.viewPayrollSummary = async function() {
            const startDate = document.getElementById('payroll-start-date').value;
            const endDate = document.getElementById('payroll-end-date').value;

            if (!startDate || !endDate) {
                alert('‚ùå Please select the payroll period dates first.');
                return;
            }

            try {
                const { data, error } = await client
                    .from('payroll_records')
                    .select('*')
                    .gte('period_start', startDate)
                    .lte('period_end', endDate);

                if (error) throw error;

                if (!data || data.length === 0) {
                    alert('‚ùå No payroll records found for this period.');
                    return;
                }

                // Calculate totals
                let totals = { employees: data.length, hours: 0, gross: 0, deductions: 0, net: 0 };
                data.forEach(r => {
                    totals.hours += r.total_hours || 0;
                    totals.gross += r.gross_pay || 0;
                    totals.deductions += r.total_deductions || 0;
                    totals.net += r.net_pay || 0;
                });

                const summary = `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
PAYROLL SUMMARY REPORT
Period: ${startDate} to ${endDate}
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

OVERVIEW
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Employees Processed:  ${totals.employees}
Total Hours Worked:   ${totals.hours.toFixed(2)} hrs
Average Hours/Emp:    ${(totals.hours / totals.employees).toFixed(2)} hrs

FINANCIAL SUMMARY
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Total Gross Pay:      JMD ${totals.gross.toLocaleString()}
Total Deductions:     JMD ${totals.deductions.toLocaleString()}
Total Net Pay:        JMD ${totals.net.toLocaleString()}

Average Net/Emp:      JMD ${(totals.net / totals.employees).toLocaleString()}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Report Generated: ${new Date().toLocaleString()}
                `;
                alert(summary);

            } catch (err) {
                console.error('Error viewing summary:', err);
                alert('‚ùå Error: ' + err.message);
            }
        };

        // View payroll journal
        window.viewPayrollJournal = async function() {
            const startDate = document.getElementById('payroll-start-date').value;
            const endDate = document.getElementById('payroll-end-date').value;

            if (!startDate || !endDate) {
                alert('‚ùå Please select the payroll period dates first.');
                return;
            }

            try {
                const { data, error } = await client
                    .from('payroll_records')
                    .select('*')
                    .gte('period_start', startDate)
                    .lte('period_end', endDate);

                if (error) throw error;

                if (!data || data.length === 0) {
                    alert('‚ùå No payroll records found for this period.');
                    return;
                }

                // Calculate totals
                let totals = { gross: 0, paye: 0, nis: 0, nht: 0, net: 0 };
                data.forEach(r => {
                    totals.gross += r.gross_pay || 0;
                    totals.paye += r.paye || 0;
                    totals.nis += r.nis || 0;
                    totals.nht += r.nht || 0;
                    totals.net += r.net_pay || 0;
                });

                const journal = `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
PAYROLL JOURNAL ENTRY
Period: ${startDate} to ${endDate}
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

ACCOUNT                          DEBIT           CREDIT
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
6010 - Salaries Expense    JMD ${totals.gross.toLocaleString().padStart(12)}
2210 - PAYE Payable                        JMD ${totals.paye.toLocaleString().padStart(12)}
2220 - NIS Payable                         JMD ${totals.nis.toLocaleString().padStart(12)}
2230 - NHT Payable                         JMD ${totals.nht.toLocaleString().padStart(12)}
1010 - Cash/Bank                           JMD ${totals.net.toLocaleString().padStart(12)}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
TOTALS                     JMD ${totals.gross.toLocaleString().padStart(12)}    JMD ${totals.gross.toLocaleString().padStart(12)}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Journal Entry Verified: Debits = Credits ‚úì
Generated: ${new Date().toLocaleString()}
                `;
                alert(journal);

            } catch (err) {
                console.error('Error viewing journal:', err);
                alert('‚ùå Error: ' + err.message);
            }
        };

        // Export payroll data to CSV
        window.exportPayrollData = async function() {
            const startDate = document.getElementById('payroll-start-date').value;
            const endDate = document.getElementById('payroll-end-date').value;

            if (!startDate || !endDate) {
                alert('‚ùå Please select the payroll period dates first.');
                return;
            }

            try {
                const { data, error } = await client
                    .from('payroll_records')
                    .select('*')
                    .gte('period_start', startDate)
                    .lte('period_end', endDate);

                if (error) throw error;

                if (!data || data.length === 0) {
                    alert('‚ùå No payroll records found for this period.');
                    return;
                }

                // Create CSV content
                const headers = ['Employee ID', 'Employee Name', 'Period Start', 'Period End', 'Hours', 'Hourly Rate', 'Gross Pay', 'NIS', 'NHT', 'PAYE', 'Total Deductions', 'Net Pay'];
                let csvContent = headers.join(',') + '\n';

                data.forEach(record => {
                    const row = [
                        record.employee_id,
                        record.employee_name || '',
                        record.period_start,
                        record.period_end,
                        record.total_hours || 0,
                        record.hourly_rate || HOURLY_RATE,
                        record.gross_pay || 0,
                        record.nis || 0,
                        record.nht || 0,
                        record.paye || 0,
                        record.total_deductions || 0,
                        record.net_pay || 0
                    ];
                    csvContent += row.join(',') + '\n';
                });

                // Download CSV
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `payroll_${startDate}_to_${endDate}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                alert('‚úÖ Payroll data exported successfully!');

            } catch (err) {
                console.error('Error exporting data:', err);
                alert('‚ùå Error: ' + err.message);
            }
        };
        
        // --- NEWLY IMPLEMENTED PAGES ---

        function renderSystemUpdates() {
            const isStaff = currentUser.role !== 'employee';
            return `
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h2 class="text-xl font-bold text-gray-800">System Announcements & Memos</h2>
                            <p class="text-sm text-gray-500">Review the latest notices, system changes, and important policy updates.</p>
                        </div>
                        <div class="flex gap-2">
                            ${currentUser.role === 'ceo' ? `
                            <button onclick="showMeetingModal()" class="py-2 px-4 text-white font-semibold rounded-lg bg-indigo-600 hover:bg-indigo-700">
                                üìÖ Schedule Meeting
                            </button>
                            ` : ''}
                            ${isStaff ? `
                            <button onclick="showAnnouncementModal()" class="py-2 px-4 text-white font-semibold rounded-lg accent-gradient">
                                + New Announcement
                            </button>
                            ` : ''}
                        </div>
                    </div>

                    <div id="announcements-list" class="space-y-4">
                        <p class="text-gray-500 text-center py-4">Loading announcements...</p>
                    </div>
                </div>

                <!-- Announcement Modal -->
                ${isStaff ? `
                <div id="announcement-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
                    <div class="bg-white p-6 rounded-xl shadow-xl max-w-lg w-full mx-4">
                        <h3 class="text-xl font-bold mb-4">Create New Announcement</h3>
                    <div class="space-y-4">
                            <input type="text" id="announcement-title" placeholder="Announcement Title" class="w-full p-3 border rounded-lg">
                            <textarea id="announcement-content" rows="4" placeholder="Announcement content..." class="w-full p-3 border rounded-lg"></textarea>
                            <select id="announcement-type" class="w-full p-3 border rounded-lg bg-white">
                                <option value="info">Info (Blue)</option>
                                <option value="success">Success (Green)</option>
                                <option value="warning">Warning (Yellow)</option>
                                <option value="urgent">Urgent (Red)</option>
                            </select>
                            ${currentUser.role === 'ceo' ? `
                            <select id="announcement-audience" class="w-full p-3 border rounded-lg bg-white">
                                <option value="everyone">Everyone (All Users)</option>
                                <option value="admins_only">Admins Only</option>
                            </select>
                            ` : ''}
                        </div>
                        <div class="flex space-x-3 mt-6">
                            <button onclick="saveAnnouncement()" class="flex-1 py-2 text-white font-semibold rounded-lg accent-gradient">Post Announcement</button>
                            <button onclick="closeAnnouncementModal()" class="flex-1 py-2 text-gray-600 font-semibold rounded-lg border border-gray-300 hover:bg-gray-50">Cancel</button>
                        </div>
                    </div>
                </div>
                ` : ''}
                
                ${currentUser.role === 'ceo' ? `
                <!-- Meeting Scheduling Modal -->
                <div id="meeting-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
                    <div class="bg-white p-6 rounded-xl shadow-xl max-w-lg w-full mx-4">
                        <h3 class="text-xl font-bold mb-4">Schedule Staff Meeting</h3>
                        <div class="space-y-4">
                            <input type="text" id="meeting-title" placeholder="Meeting Title" class="w-full p-3 border rounded-lg">
                            <textarea id="meeting-description" rows="3" placeholder="Meeting description/agenda..." class="w-full p-3 border rounded-lg"></textarea>
                            <input type="datetime-local" id="meeting-date" class="w-full p-3 border rounded-lg">
                            <select id="meeting-audience" class="w-full p-3 border rounded-lg bg-white">
                                <option value="everyone">General (All Staff)</option>
                                <option value="admins_only">Admins Only</option>
                            </select>
                        </div>
                        <div class="flex space-x-3 mt-6">
                            <button onclick="saveMeeting()" class="flex-1 py-2 text-white font-semibold rounded-lg accent-gradient">Schedule Meeting</button>
                            <button onclick="closeMeetingModal()" class="flex-1 py-2 text-gray-600 font-semibold rounded-lg border border-gray-300 hover:bg-gray-50">Cancel</button>
                        </div>
                    </div>
                </div>
                ` : ''}
            `;
        }

        window.loadAnnouncements = async function() {
            const listContainer = document.getElementById('announcements-list');
            if (!listContainer) return;

            try {
                let query = client.from('announcements').select('*');
                
                // Filter by audience if not CEO
                if (currentUser.role === 'employee') {
                    // Employees only see "everyone" announcements
                    query = query.or('audience.eq.everyone,audience.is.null');
                } else if (currentUser.role === 'admin') {
                    // Admins see "everyone" and "admins_only"
                    query = query.or('audience.eq.everyone,audience.eq.admins_only,audience.is.null');
                }
                // CEO sees all announcements
                
                const { data, error } = await query.order('created_at', { ascending: false });

                if (error) {
                    console.error('Error loading announcements:', error);
                    // Show default message if table doesn't exist
                    listContainer.innerHTML = `
                        <div class="p-4 border border-indigo-200 bg-indigo-50 rounded-xl">
                            <div class="flex justify-between items-center mb-1">
                                <h3 class="font-bold text-indigo-700">Welcome to PayFlow!</h3>
                                <span class="text-xs text-indigo-500">${new Date().toLocaleDateString()}</span>
                            </div>
                            <p class="text-sm text-indigo-600">No announcements have been posted yet. ${currentUser.role !== 'employee' ? 'Click "New Announcement" to create one.' : 'Check back later for updates.'}</p>
                        </div>
                    `;
                    return;
                }

                if (!data || data.length === 0) {
                    listContainer.innerHTML = `
                        <div class="p-4 border border-gray-200 bg-gray-50 rounded-xl text-center">
                            <p class="text-gray-500">No announcements yet.</p>
                            </div>
                    `;
                    return;
                }

                const typeStyles = {
                    info: 'border-indigo-200 bg-indigo-50 text-indigo-700',
                    success: 'border-green-200 bg-green-50 text-green-700',
                    warning: 'border-yellow-200 bg-yellow-50 text-yellow-700',
                    urgent: 'border-red-200 bg-red-50 text-red-700'
                };

                listContainer.innerHTML = data.map(ann => {
                    const style = typeStyles[ann.type] || typeStyles.info;
                    return `
                        <div class="p-4 border ${style.split(' ').slice(0, 2).join(' ')} rounded-xl">
                            <div class="flex justify-between items-start mb-1">
                                <div class="flex-1">
                                    <h3 class="font-bold ${style.split(' ').slice(2).join(' ')}">${ann.title}</h3>
                                    ${ann.audience === 'admins_only' ? '<span class="text-xs px-2 py-0.5 rounded-full bg-purple-100 text-purple-700 ml-2">Admins Only</span>' : ''}
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs opacity-70">${new Date(ann.created_at).toLocaleDateString()}</span>
                                    ${currentUser.role !== 'employee' ? `
                                    <button onclick="deleteAnnouncement('${ann.id}')" class="text-red-500 hover:text-red-700 text-xs">Delete</button>
                                    ` : ''}
                        </div>
                    </div>
                            <p class="text-sm ${style.split(' ').slice(2).join(' ')} opacity-90">${ann.content}</p>
                            <p class="text-xs mt-2 opacity-60">Posted by: ${ann.author || 'Admin'}</p>
                </div>
            `;
                }).join('');

            } catch (err) {
                console.error('Exception loading announcements:', err);
                listContainer.innerHTML = '<p class="text-red-500 text-center py-4">Error loading announcements.</p>';
            }
        };

        window.showAnnouncementModal = function() {
            document.getElementById('announcement-title').value = '';
            document.getElementById('announcement-content').value = '';
            document.getElementById('announcement-type').value = 'info';
            if (currentUser.role === 'ceo') {
                document.getElementById('announcement-audience').value = 'everyone';
            }
            document.getElementById('announcement-modal').classList.remove('hidden');
        };

        window.closeAnnouncementModal = function() {
            document.getElementById('announcement-modal').classList.add('hidden');
        };

        window.saveAnnouncement = async function() {
            const title = document.getElementById('announcement-title').value.trim();
            const content = document.getElementById('announcement-content').value.trim();
            const type = document.getElementById('announcement-type').value;
            const audience = currentUser.role === 'ceo' 
                ? (document.getElementById('announcement-audience')?.value || 'everyone')
                : 'everyone';

            if (!title || !content) {
                showToast('Please fill in both title and content.', 'error');
                return;
            }

            try {
                const { error } = await client
                    .from('announcements')
                    .insert([{
                        title,
                        content,
                        type,
                        audience: audience,
                        author: currentUser.name,
                        created_at: new Date().toISOString()
                    }]);

                if (error) throw error;

                showToast('Announcement posted successfully!', 'success');
                closeAnnouncementModal();
                loadAnnouncements();
            } catch (err) {
                console.error('Error saving announcement:', err);
                showToast('Failed to post announcement: ' + err.message, 'error');
            }
        };

        // Meeting Scheduling Functions
        window.showMeetingModal = function() {
            document.getElementById('meeting-title').value = '';
            document.getElementById('meeting-description').value = '';
            document.getElementById('meeting-date').value = '';
            document.getElementById('meeting-audience').value = 'everyone';
            document.getElementById('meeting-modal').classList.remove('hidden');
        };

        window.closeMeetingModal = function() {
            document.getElementById('meeting-modal').classList.add('hidden');
        };

        window.saveMeeting = async function() {
            const title = document.getElementById('meeting-title').value.trim();
            const description = document.getElementById('meeting-description').value.trim();
            const dateTime = document.getElementById('meeting-date').value;
            const audience = document.getElementById('meeting-audience').value;

            if (!title || !dateTime) {
                showToast('Please fill in meeting title and date/time.', 'error');
                return;
            }

            try {
                const { error } = await client
                    .from('meetings')
                    .insert([{
                        title,
                        description,
                        meeting_date: dateTime,
                        audience: audience,
                        created_by: currentUser.id,
                        created_by_name: currentUser.name,
                        created_at: new Date().toISOString()
                    }]);

                if (error) throw error;

                // Also create announcement for the meeting
                await client
                    .from('announcements')
                    .insert([{
                        title: `üìÖ Meeting: ${title}`,
                        content: `Meeting scheduled for ${new Date(dateTime).toLocaleString()}\n\n${description || 'No description provided.'}`,
                        type: 'info',
                        audience: audience,
                        author: currentUser.name,
                        created_at: new Date().toISOString()
                    }]);

                showToast('Meeting scheduled successfully!', 'success');
                closeMeetingModal();
                loadAnnouncements();
                if (currentUser.role === 'ceo') loadDashboardMeetings();
            } catch (err) {
                console.error('Error saving meeting:', err);
                showToast('Failed to schedule meeting: ' + err.message, 'error');
            }
        };

        window.deleteAnnouncement = async function(id) {
            if (!confirm('Are you sure you want to delete this announcement?')) return;

            try {
                const { error } = await client
                    .from('announcements')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                alert('‚úÖ Announcement deleted.');
                loadAnnouncements();
            } catch (err) {
                console.error('Error deleting announcement:', err);
                alert('‚ùå Failed to delete announcement.');
            }
        };

        function renderRequestStatutory() {
    return `
        <div class="bg-white p-6 rounded-xl shadow-md max-w-2xl">
            <h2 class="text-xl font-bold mb-4">Statutory Information Request</h2>
            <p class="text-sm text-gray-500 mb-6">Request official documentation related to your statutory contributions (NIS, NHT) or tax records (P45, P60).</p>

            <div class="space-y-4">
                <div>
                    <label for="statutory-type" class="block text-sm font-medium text-gray-700">Type of Document</label>
                    <select id="statutory-type" class="w-full p-3 border rounded-lg bg-white">
                        <option>Annual Tax Summary (P60 Equivalent)</option>
                        <option>NIS Contribution History</option>
                        <option>NHT Contribution Statement</option>
                        <option>Confirmation of Employment Letter</option>
                    </select>
                </div>
                <div>
                    <label for="statutory-reason" class="block text-sm font-medium text-gray-700">Reason for Request</label>
                    <textarea id="statutory-reason" rows="3" placeholder="e.g., Mortgage application, visa application, personal records." class="w-full p-3 border rounded-lg"></textarea>
                </div>
            </div>

            <button onclick="submitStatutoryRequest()" class="mt-6 py-3 px-6 text-white font-semibold rounded-xl accent-gradient hover:opacity-90 transition">
                Submit Request to HR
            </button>

            <div class="mt-8 p-4 border border-yellow-200 bg-yellow-50 rounded-xl" id="pending-statutory-requests">
                <h3 class="font-bold text-yellow-800">Pending Requests</h3>
                <p class="text-sm text-yellow-700 mt-1">Loading...</p>
            </div>
        </div>
    `;
}

// Add this function to handle the submission
window.submitStatutoryRequest = async function() {
    const docType = document.getElementById('statutory-type').value;
    const reason = document.getElementById('statutory-reason').value.trim();

    if (!reason) {
        alert('‚ùå Please provide a reason for your request.');
        return;
    }

    const details = `Document Type: ${docType}\nReason: ${reason}`;
    const success = await submitRequest('statutory', details);

    if (success) {
        // Clear the form
        document.getElementById('statutory-reason').value = '';
        // Reload pending requests
        loadPendingRequests('statutory', 'pending-statutory-requests');
    }
}

// Function to load and display pending requests
async function loadPendingRequests(requestType, containerId) {
    try {
        const { data, error } = await client
            .from('requests')
            .select('*')
            .eq('employee_id', currentUser.id)
            .eq('request_type', requestType)
            .eq('status', 'pending')
            .order('created_at', { ascending: false });

        if (error) {
            console.error('Error loading requests:', error);
            return;
        }

        const container = document.getElementById(containerId);
        if (container && data && data.length > 0) {
            container.innerHTML = `
                <h3 class="font-bold text-yellow-800">Pending Requests</h3>
                ${data.map(req => `
                    <p class="text-sm text-yellow-700 mt-1">
                        ${req.request_type.charAt(0).toUpperCase() + req.request_type.slice(1)} Request 
                        (Submitted: ${new Date(req.created_at).toLocaleDateString()}) - **Processing**
                    </p>
                `).join('')}
            `;
        } else if (container) {
            container.innerHTML = `
                <h3 class="font-bold text-gray-500">Pending Requests</h3>
                <p class="text-sm text-gray-500 mt-1">No pending requests</p>
            `;
        }
    } catch (err) {
        console.error('Exception loading requests:', err);
    }
}

        function renderRequestBenefits() {
    return `
        <div class="bg-white p-6 rounded-xl shadow-md max-w-2xl">
            <h2 class="text-xl font-bold mb-4">Employee Benefits Request</h2>
            <p class="text-sm text-gray-500 mb-6">Apply for, modify, or inquire about company benefits such as health insurance, dental, or educational support.</p>

            <div class="space-y-4">
                <div>
                    <label for="benefit-type" class="block text-sm font-medium text-gray-700">Benefit Category</label>
                    <select id="benefit-type" class="w-full p-3 border rounded-lg bg-white">
                        <option>Health Insurance Enrollment</option>
                        <option>Dental Plan Change</option>
                        <option>Gym Membership Reimbursement</option>
                        <option>Educational Assistance Application</option>
                    </select>
                </div>
                <div>
                    <label for="benefit-details" class="block text-sm font-medium text-gray-700">Required Details / Supporting Documents</label>
                    <textarea id="benefit-details" rows="3" placeholder="Provide policy number, spouse/dependent details, or general inquiry." class="w-full p-3 border rounded-lg"></textarea>
                </div>
            </div>

            <button onclick="submitBenefitRequest()" class="mt-6 py-3 px-6 text-white font-semibold rounded-xl accent-gradient hover:opacity-90 transition">
                Submit Benefit Application
            </button>

            <div class="mt-8 p-4 border border-yellow-200 bg-yellow-50 rounded-xl" id="pending-benefits-requests">
                <h3 class="font-bold text-yellow-800">Pending Requests</h3>
                <p class="text-sm text-yellow-700 mt-1">Loading...</p>
            </div>
        </div>
    `;
}

window.submitBenefitRequest = async function() {
    const benefitType = document.getElementById('benefit-type').value;
    const details = document.getElementById('benefit-details').value.trim();

    if (!details) {
        alert('‚ùå Please provide details for your benefit request.');
        return;
    }

    const requestDetails = `Benefit Type: ${benefitType}\nDetails: ${details}`;
    const success = await submitRequest('benefits', requestDetails);

    if (success) {
        document.getElementById('benefit-details').value = '';
    }
}
        
        function renderPayslipGenerationTool() {
            return `
                <div class="bg-white p-6 rounded-xl shadow-md max-w-3xl">
                    <h2 class="text-xl font-bold mb-4">Single Payslip Generation Tool</h2>
                    <p class="text-sm text-gray-500 mb-6">Manually generate a payslip for a specific employee based on their attendance records.</p>

                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <input type="text" id="single-payslip-emp" placeholder="Employee ID (e.g., E001)" class="p-3 border rounded-lg">
                        <div class="grid grid-cols-2 gap-2">
                            <input type="date" id="single-payslip-start" class="p-3 border rounded-lg" placeholder="Start Date">
                            <input type="date" id="single-payslip-end" class="p-3 border rounded-lg" placeholder="End Date">
                        </div>
                    </div>

                    <div class="flex space-x-4">
                        <button onclick="previewSinglePayslip()" class="py-3 px-6 text-white font-semibold rounded-xl bg-indigo-500 hover:bg-indigo-600 transition">
                            Preview Payslip Data
                        </button>
                        <button onclick="generateSinglePayslip()" class="py-3 px-6 text-white font-semibold rounded-xl bg-green-500 hover:bg-green-600 transition">
                            Generate & Save Payslip
                        </button>
                    </div>

                    <div id="single-payslip-preview" class="mt-8 p-4 border border-gray-200 rounded-xl bg-gray-50">
                        <h3 class="font-bold text-gray-800">Preview Area</h3>
                        <p class="text-sm text-gray-600 mt-1">Enter employee ID and date range, then click "Preview Payslip Data".</p>
                    </div>
                </div>
            `;
        }

        let previewedPayslipData = null;

        window.previewSinglePayslip = async function() {
            const empId = document.getElementById('single-payslip-emp').value.trim().toUpperCase();
            const startDate = document.getElementById('single-payslip-start').value;
            const endDate = document.getElementById('single-payslip-end').value;
            const previewContainer = document.getElementById('single-payslip-preview');

            if (!empId || !startDate || !endDate) {
                alert('‚ùå Please enter Employee ID and date range.');
                return;
            }

            previewContainer.innerHTML = '<p class="text-gray-500">Loading...</p>';

            try {
                // Get employee info
                const { data: empData, error: empError } = await client
                    .from('users')
                    .select('*')
                    .eq('id', empId)
                    .single();

                if (empError || !empData) {
                    previewContainer.innerHTML = '<p class="text-red-500">Employee not found.</p>';
                    return;
                }

                // Get attendance records
                const { data: attendance, error: attError } = await client
                    .from('attendance')
                    .select('*')
                    .eq('employee_id', empId)
                    .gte('date', startDate)
                    .lte('date', endDate)
                    .not('clock_out', 'is', null);

                if (attError) throw attError;

                // Calculate hours
                const totalHours = attendance?.reduce((sum, r) => sum + calculateHoursFromRecord(r), 0) || 0;
                const grossPay = totalHours * HOURLY_RATE;

                // Calculate deductions
                const nisDeduction = Math.min(grossPay * 0.03, 3000);
                const nhtDeduction = grossPay * 0.02;
                const educationTax = grossPay * 0.0225;
                const annualizedGross = grossPay * 12;
                const payeDeduction = annualizedGross > 1500096 ? ((annualizedGross - 1500096) * 0.25) / 12 : 0;
                const totalDeductions = nisDeduction + nhtDeduction + educationTax + payeDeduction;
                const netPay = grossPay - totalDeductions;

                // Store for saving
                previewedPayslipData = {
                    employee_id: empId,
                    employee_name: empData.name,
                    period_start: startDate,
                    period_end: endDate,
                    total_hours: totalHours,
                    hourly_rate: HOURLY_RATE,
                    gross_pay: grossPay,
                    paye: payeDeduction,
                    nis: nisDeduction,
                    nht: nhtDeduction,
                    total_deductions: totalDeductions,
                    net_pay: netPay
                };

                previewContainer.innerHTML = `
                    <h3 class="font-bold text-gray-800 mb-3">Payslip Preview: ${empData.name} (${empId})</h3>
                    <p class="text-sm text-gray-600">Period: ${startDate} to ${endDate}</p>
                    
                    <div class="mt-4 space-y-2 text-sm">
                        <div class="flex justify-between border-b pb-2">
                            <span>Total Hours Worked:</span>
                            <span class="font-semibold">${totalHours.toFixed(2)} hrs</span>
                        </div>
                        <div class="flex justify-between border-b pb-2">
                            <span>Hourly Rate:</span>
                            <span class="font-semibold">JMD ${HOURLY_RATE}</span>
                        </div>
                        <div class="flex justify-between border-b pb-2">
                            <span>Gross Pay:</span>
                            <span class="font-semibold text-blue-600">JMD ${grossPay.toLocaleString()}</span>
                        </div>
                        <div class="pt-2 border-t">
                            <p class="font-medium text-gray-700 mb-1">Deductions:</p>
                            <div class="pl-4 space-y-1 text-gray-600">
                                <div class="flex justify-between"><span>NIS (3%):</span><span>-JMD ${nisDeduction.toLocaleString()}</span></div>
                                <div class="flex justify-between"><span>NHT (2%):</span><span>-JMD ${nhtDeduction.toLocaleString()}</span></div>
                                <div class="flex justify-between"><span>Education Tax (2.25%):</span><span>-JMD ${educationTax.toLocaleString()}</span></div>
                                <div class="flex justify-between"><span>PAYE:</span><span>-JMD ${payeDeduction.toLocaleString()}</span></div>
                            </div>
                        </div>
                        <div class="flex justify-between border-t pt-2 text-red-600">
                            <span>Total Deductions:</span>
                            <span class="font-semibold">-JMD ${totalDeductions.toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between bg-green-100 p-2 rounded-lg text-green-800 text-lg font-bold">
                            <span>NET PAY:</span>
                            <span>JMD ${netPay.toLocaleString()}</span>
                        </div>
                    </div>
                    
                    ${totalHours === 0 ? '<p class="text-yellow-600 text-sm mt-3">‚ö†Ô∏è No attendance records found for this period.</p>' : ''}
                `;

            } catch (err) {
                console.error('Error previewing payslip:', err);
                previewContainer.innerHTML = '<p class="text-red-500">Error loading payslip data.</p>';
            }
        };

        window.generateSinglePayslip = async function() {
            if (!previewedPayslipData) {
                alert('‚ùå Please preview the payslip first.');
                return;
            }

            if (previewedPayslipData.total_hours === 0) {
                if (!confirm('‚ö†Ô∏è This employee has 0 hours for the selected period. Generate anyway?')) {
                    return;
                }
            }

            try {
                const { error } = await client
                    .from('payroll_records')
                    .insert([{
                        ...previewedPayslipData,
                        calculated_at: new Date().toISOString()
                    }]);

                if (error) throw error;

                alert('‚úÖ Payslip generated and saved successfully!\n\nThe employee can now view it in their Payslips section.');
                previewedPayslipData = null;
                
                // Clear preview
                document.getElementById('single-payslip-preview').innerHTML = `
                    <h3 class="font-bold text-gray-800">Preview Area</h3>
                    <p class="text-sm text-green-600 mt-1">‚úÖ Payslip saved successfully! Enter another employee to generate more.</p>
                `;

            } catch (err) {
                console.error('Error saving payslip:', err);
                alert('‚ùå Failed to save payslip: ' + err.message);
            }
        };

        function renderStatutoryCompliance() {
            return `
                <div class="bg-white p-6 rounded-xl shadow-md max-w-4xl">
                    <h2 class="text-xl font-bold mb-4">Statutory and Compliance Calculation Tool</h2>
                    <p class="text-sm text-gray-500 mb-6">Verify current Jamaican tax rates, contribution ceilings, and compliance status for all employees.</p>

                    <!-- Current Rates Reference -->
                    <div class="grid grid-cols-4 gap-4 mb-6">
                        <div class="p-3 bg-blue-50 rounded-lg border border-blue-200">
                            <p class="text-xs text-blue-600 font-medium">NIS Rate</p>
                            <p class="text-lg font-bold text-blue-800">3%</p>
                            <p class="text-xs text-blue-600">Cap: JMD 3,000/mo</p>
                        </div>
                        <div class="p-3 bg-green-50 rounded-lg border border-green-200">
                            <p class="text-xs text-green-600 font-medium">NHT Rate</p>
                            <p class="text-lg font-bold text-green-800">2%</p>
                            <p class="text-xs text-green-600">No cap</p>
                        </div>
                        <div class="p-3 bg-purple-50 rounded-lg border border-purple-200">
                            <p class="text-xs text-purple-600 font-medium">Education Tax</p>
                            <p class="text-lg font-bold text-purple-800">2.25%</p>
                            <p class="text-xs text-purple-600">No cap</p>
                        </div>
                        <div class="p-3 bg-red-50 rounded-lg border border-red-200">
                            <p class="text-xs text-red-600 font-medium">PAYE Rate</p>
                            <p class="text-lg font-bold text-red-800">25%</p>
                            <p class="text-xs text-red-600">Above JMD 1.5M/yr</p>
                        </div>
                    </div>

                    <!-- Calculator Section -->
                    <div class="p-4 border rounded-xl bg-gray-50 mb-6">
                        <h3 class="font-bold text-gray-800 mb-3">Quick Statutory Calculator</h3>
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="text-sm text-gray-600">Monthly Gross Salary (JMD)</label>
                                <input type="number" id="statutory-gross" placeholder="e.g., 150000" class="w-full p-3 border rounded-lg mt-1">
                            </div>
                            <div class="flex items-end">
                                <button onclick="calculateStatutory()" class="w-full py-3 text-white font-semibold rounded-lg bg-indigo-500 hover:bg-indigo-600 transition">
                                    Calculate Deductions
                        </button>
                            </div>
                            <div id="statutory-result" class="p-3 bg-white rounded-lg border">
                                <p class="text-sm text-gray-500">Enter amount and click calculate</p>
                            </div>
                        </div>
                    </div>

                    <!-- Compliance Status -->
                    <div id="compliance-status" class="mt-6">
                        <h3 class="font-bold text-gray-800 mb-3">Compliance Status Check</h3>
                        <button onclick="checkComplianceStatus()" class="py-2 px-4 mb-4 text-white font-semibold rounded-lg bg-purple-600 hover:bg-purple-700 transition">
                            Run Compliance Check
                        </button>
                        <div id="compliance-results" class="p-4 border border-gray-200 rounded-xl">
                            <p class="text-gray-500 text-sm">Click "Run Compliance Check" to verify all employee deductions.</p>
                        </div>
                    </div>
                </div>
            `;
        }

        window.calculateStatutory = function() {
            const gross = parseFloat(document.getElementById('statutory-gross')?.value) || 0;
            const resultDiv = document.getElementById('statutory-result');
            
            if (!resultDiv) return;
            
            if (gross <= 0) {
                resultDiv.innerHTML = '<p class="text-red-500 text-sm">Please enter a valid amount</p>';
                return;
            }

            const nis = Math.min(gross * 0.03, 3000);
            const nht = gross * 0.02;
            const eduTax = gross * 0.0225;
            const annualized = gross * 12;
            const paye = annualized > 1500096 ? ((annualized - 1500096) * 0.25) / 12 : 0;
            const total = nis + nht + eduTax + paye;
            const net = gross - total;

            resultDiv.innerHTML = `
                <div class="space-y-1 text-xs">
                    <p class="flex justify-between"><span>NIS:</span><span>JMD ${nis.toLocaleString()}</span></p>
                    <p class="flex justify-between"><span>NHT:</span><span>JMD ${nht.toLocaleString()}</span></p>
                    <p class="flex justify-between"><span>Edu Tax:</span><span>JMD ${eduTax.toLocaleString()}</span></p>
                    <p class="flex justify-between"><span>PAYE:</span><span>JMD ${paye.toLocaleString()}</span></p>
                    <p class="flex justify-between border-t pt-1 font-bold"><span>Total:</span><span class="text-red-600">-JMD ${total.toLocaleString()}</span></p>
                    <p class="flex justify-between font-bold text-green-600"><span>Net:</span><span>JMD ${net.toLocaleString()}</span></p>
                </div>
            `;
        };

        window.checkComplianceStatus = async function() {
            const resultsDiv = document.getElementById('compliance-results');
            if (!resultsDiv) return;

            resultsDiv.innerHTML = '<p class="text-gray-500 text-sm">Checking compliance...</p>';

            try {
                // Get all payroll records
                const { data: payrollRecords, error } = await client
                    .from('payroll_records')
                    .select('*')
                    .order('calculated_at', { ascending: false });

                if (error) throw error;

                if (!payrollRecords || payrollRecords.length === 0) {
                    resultsDiv.innerHTML = `
                        <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <p class="text-yellow-800">No payroll records found to check. Generate payroll first.</p>
                        </div>
                    `;
                    return;
                }

                // Check each record for compliance
                const issues = [];
                payrollRecords.forEach(record => {
                    const expectedNis = Math.min((record.gross_pay || 0) * 0.03, 3000);
                    const expectedNht = (record.gross_pay || 0) * 0.02;
                    
                    // Check if deductions are within 5% tolerance
                    const nisDiff = Math.abs((record.nis || 0) - expectedNis);
                    const nhtDiff = Math.abs((record.nht || 0) - expectedNht);

                    if (nisDiff > expectedNis * 0.05 && expectedNis > 0) {
                        issues.push({ type: 'NIS', employee: record.employee_name || record.employee_id, period: record.period_end, expected: expectedNis, actual: record.nis || 0 });
                    }
                    if (nhtDiff > expectedNht * 0.05 && expectedNht > 0) {
                        issues.push({ type: 'NHT', employee: record.employee_name || record.employee_id, period: record.period_end, expected: expectedNht, actual: record.nht || 0 });
                    }
                });

                if (issues.length === 0) {
                    resultsDiv.innerHTML = `
                        <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                            <h4 class="font-bold text-green-800">‚úÖ All Clear!</h4>
                            <p class="text-sm text-green-700 mt-1">All ${payrollRecords.length} payroll records are compliant with statutory requirements.</p>
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML = `
                        <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                            <h4 class="font-bold text-red-800">‚ö†Ô∏è ${issues.length} Compliance Issue(s) Found</h4>
                            <div class="mt-3 max-h-48 overflow-y-auto space-y-2">
                                ${issues.map(issue => `
                                    <div class="p-2 bg-white rounded border text-sm">
                                        <p><strong>${issue.type} Issue:</strong> ${issue.employee}</p>
                                        <p class="text-gray-600">Period: ${issue.period}</p>
                                        <p class="text-gray-600">Expected: JMD ${issue.expected.toLocaleString()}, Actual: JMD ${issue.actual.toLocaleString()}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

            } catch (err) {
                console.error('Error checking compliance:', err);
                resultsDiv.innerHTML = '<p class="text-red-500">Error checking compliance status.</p>';
            }
        };

        function renderFinancialStatements() {
            const currentMonth = new Date().toISOString().slice(0, 7);
            return `
                <div class="bg-white p-6 rounded-xl shadow-md max-w-4xl">
                    <h2 class="text-xl font-bold mb-4">Financial Statements Console (CEO Access)</h2>
                    <p class="text-sm text-gray-500 mb-6">Comprehensive financial overview of payroll expenditure, ledger data, and budget analysis.</p>

                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <select id="statement-type" class="p-3 border rounded-lg bg-white">
                            <option value="ledger">Payroll General Ledger Summary</option>
                            <option value="ytd">Year-to-Date Expense Report</option>
                            <option value="monthly">Monthly Payroll Summary</option>
                        </select>
                        <input type="month" id="statement-month" value="${currentMonth}" class="p-3 border rounded-lg">
                        <button onclick="generateFinancialStatement()" class="py-2 px-4 text-white font-semibold rounded-lg bg-purple-600 hover:bg-purple-700 transition">
                            Generate Statement
                        </button>
                    </div>

                    <!-- Summary Cards -->
                    <div id="financial-summary" class="grid grid-cols-4 gap-4 mb-6">
                        <div class="p-4 bg-blue-50 rounded-xl border border-blue-200">
                            <p class="text-xs text-blue-600">Total Gross Pay</p>
                            <p id="fin-gross" class="text-xl font-bold text-blue-800">Loading...</p>
                        </div>
                        <div class="p-4 bg-red-50 rounded-xl border border-red-200">
                            <p class="text-xs text-red-600">Total Deductions</p>
                            <p id="fin-deductions" class="text-xl font-bold text-red-800">Loading...</p>
                        </div>
                        <div class="p-4 bg-green-50 rounded-xl border border-green-200">
                            <p class="text-xs text-green-600">Total Net Pay</p>
                            <p id="fin-net" class="text-xl font-bold text-green-800">Loading...</p>
                        </div>
                        <div class="p-4 bg-purple-50 rounded-xl border border-purple-200">
                            <p class="text-xs text-purple-600">Total Hours</p>
                            <p id="fin-hours" class="text-xl font-bold text-purple-800">Loading...</p>
                        </div>
                    </div>

                    <div id="financial-report" class="mt-8 p-6 border-2 border-dashed border-gray-300 rounded-xl">
                        <p class="text-gray-500 text-center">Click "Generate Statement" to view the report.</p>
                    </div>
                </div>
            `;
        }

        window.loadFinancialSummary = async function() {
            try {
                const { data, error } = await client
                    .from('payroll_records')
                    .select('gross_pay, total_deductions, net_pay, total_hours');

                if (error) throw error;

                let totalGross = 0, totalDeductions = 0, totalNet = 0, totalHours = 0;

                if (data) {
                    data.forEach(record => {
                        totalGross += record.gross_pay || 0;
                        totalDeductions += record.total_deductions || 0;
                        totalNet += record.net_pay || 0;
                        totalHours += record.total_hours || 0;
                    });
                }

                document.getElementById('fin-gross').textContent = 'JMD ' + totalGross.toLocaleString();
                document.getElementById('fin-deductions').textContent = 'JMD ' + totalDeductions.toLocaleString();
                document.getElementById('fin-net').textContent = 'JMD ' + totalNet.toLocaleString();
                document.getElementById('fin-hours').textContent = totalHours.toFixed(2) + ' hrs';

            } catch (err) {
                console.error('Error loading financial summary:', err);
            }
        };

        window.generateFinancialStatement = async function() {
            const type = document.getElementById('statement-type').value;
            const month = document.getElementById('statement-month').value;
            const reportContainer = document.getElementById('financial-report');

            if (!reportContainer) return;

            reportContainer.innerHTML = '<p class="text-gray-500 text-center">Loading...</p>';

            try {
                let query = client.from('payroll_records').select('*');

                if (type === 'monthly' && month) {
                    const startDate = month + '-01';
                    const endDate = month + '-31';
                    query = query.gte('period_start', startDate).lte('period_end', endDate);
                } else if (type === 'ytd') {
                    const yearStart = new Date().getFullYear() + '-01-01';
                    query = query.gte('period_start', yearStart);
                }

                const { data, error } = await query.order('period_end', { ascending: false });

                if (error) throw error;

                if (!data || data.length === 0) {
                    reportContainer.innerHTML = '<p class="text-gray-500 text-center py-8">No payroll records found for the selected period.</p>';
                    return;
                }

                // Calculate totals
                let totals = { gross: 0, paye: 0, nis: 0, nht: 0, deductions: 0, net: 0, hours: 0 };
                data.forEach(r => {
                    totals.gross += r.gross_pay || 0;
                    totals.paye += r.paye || 0;
                    totals.nis += r.nis || 0;
                    totals.nht += r.nht || 0;
                    totals.deductions += r.total_deductions || 0;
                    totals.net += r.net_pay || 0;
                    totals.hours += r.total_hours || 0;
                });

                const reportTitle = type === 'ytd' ? 'Year-to-Date Expense Report' :
                                   type === 'monthly' ? `Monthly Payroll Summary (${month})` :
                                   'Payroll General Ledger Summary';

                reportContainer.innerHTML = `
                    <h3 class="text-lg font-bold text-gray-800 mb-4">${reportTitle}</h3>
                    
                    <!-- Ledger Style Summary -->
                    <table class="min-w-full divide-y divide-gray-200 mb-6">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Account Code</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Description</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Debit (JMD)</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Credit (JMD)</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200 text-sm">
                            <tr><td class="px-4 py-2">6010</td><td>Salaries Expense</td><td class="px-4 py-2 text-right">${totals.gross.toLocaleString()}</td><td class="px-4 py-2 text-right">0.00</td></tr>
                            <tr><td class="px-4 py-2">2210</td><td>PAYE Payable</td><td class="px-4 py-2 text-right">0.00</td><td class="px-4 py-2 text-right">${totals.paye.toLocaleString()}</td></tr>
                            <tr><td class="px-4 py-2">2220</td><td>NIS Payable</td><td class="px-4 py-2 text-right">0.00</td><td class="px-4 py-2 text-right">${totals.nis.toLocaleString()}</td></tr>
                            <tr><td class="px-4 py-2">2230</td><td>NHT Payable</td><td class="px-4 py-2 text-right">0.00</td><td class="px-4 py-2 text-right">${totals.nht.toLocaleString()}</td></tr>
                            <tr><td class="px-4 py-2">1010</td><td>Cash/Bank (Net Wages)</td><td class="px-4 py-2 text-right">0.00</td><td class="px-4 py-2 text-right">${totals.net.toLocaleString()}</td></tr>
                            </tbody>
                        <tfoot class="bg-gray-100 font-bold">
                            <tr>
                                <td colspan="2" class="px-4 py-2">TOTALS</td>
                                <td class="px-4 py-2 text-right">${totals.gross.toLocaleString()}</td>
                                <td class="px-4 py-2 text-right">${totals.gross.toLocaleString()}</td>
                            </tr>
                        </tfoot>
                        </table>

                    <!-- Detail by Employee -->
                    <h4 class="text-md font-semibold text-gray-700 mb-2">Detail by Employee</h4>
                    <table class="min-w-full divide-y divide-gray-200 text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Employee</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Period</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500">Hours</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500">Gross</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500">Deductions</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500">Net</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${data.map(r => `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-3 py-2">${r.employee_name || r.employee_id}</td>
                                    <td class="px-3 py-2 text-gray-500">${r.period_start} to ${r.period_end}</td>
                                    <td class="px-3 py-2 text-right">${(r.total_hours || 0).toFixed(2)}</td>
                                    <td class="px-3 py-2 text-right">${(r.gross_pay || 0).toLocaleString()}</td>
                                    <td class="px-3 py-2 text-right text-red-600">${(r.total_deductions || 0).toLocaleString()}</td>
                                    <td class="px-3 py-2 text-right text-green-600 font-medium">${(r.net_pay || 0).toLocaleString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <p class="text-xs text-gray-400 mt-4">Report generated: ${new Date().toLocaleString()}</p>
                `;

            } catch (err) {
                console.error('Error generating financial statement:', err);
                reportContainer.innerHTML = '<p class="text-red-500 text-center">Error generating report.</p>';
            }
        };

        function renderSystemSecurity() {
            const isCEO = currentUser.role === 'ceo';
            return `
                <div class="bg-white p-6 rounded-xl shadow-md max-w-4xl">
                    <h2 class="text-xl font-bold mb-4">System Security & Access Control</h2>
                    <p class="text-sm text-gray-500 mb-6">Monitor access logs, manage user permissions, and enforce security policies across the application.</p>

                    ${isCEO ? `
                    <!-- CEO Key Generation -->
                    <div class="mb-6 p-4 border-2 border-purple-200 rounded-xl bg-gradient-to-r from-purple-50 to-indigo-50">
                        <h3 class="font-bold text-lg text-purple-700 mb-3">üîë Admin/CEO Registration Keys</h3>
                        <p class="text-sm text-gray-600 mb-3">Generate unique keys for Admin/CEO account creation. Users must enter this key during signup.</p>
                        <div class="flex gap-3">
                            <button onclick="generateAdminKey('admin')" class="py-2 px-4 text-sm text-white bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold">
                                Generate Admin Key
                            </button>
                            <button onclick="generateAdminKey('ceo')" class="py-2 px-4 text-sm text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg font-semibold">
                                Generate CEO Key
                            </button>
                        </div>
                        <div id="generated-key-display" class="mt-4 p-3 bg-white rounded-lg border border-purple-200 hidden">
                            <p class="text-xs text-gray-600 mb-1">Generated Key:</p>
                            <p id="generated-key-text" class="font-mono text-lg font-bold text-purple-700"></p>
                            <p class="text-xs text-gray-500 mt-2">Share this key with the person who needs to create an Admin/CEO account.</p>
                        </div>
                        <div id="active-keys-list" class="mt-4 space-y-2">
                            <p class="text-xs text-gray-600 font-semibold">Active Keys:</p>
                            <div id="keys-container" class="space-y-2"></div>
                        </div>
                    </div>
                    ` : ''}

                    <!-- Pending Account Approvals (Admin/CEO only) -->
                    ${currentUser.role !== 'employee' ? `
                    <div class="mb-6 p-4 border border-yellow-200 rounded-xl bg-yellow-50">
                        <h3 class="font-bold text-lg text-yellow-700 mb-3">‚è≥ Pending Account Approvals</h3>
                        <div id="pending-approvals-list" class="space-y-3 max-h-64 overflow-y-auto">
                            <p class="text-gray-500 text-sm">Loading...</p>
                        </div>
                    </div>
                    ` : ''}

                    <div class="grid grid-cols-2 gap-6">
                        <!-- User Permissions -->
                        <div class="p-4 border rounded-xl">
                            <h3 class="font-bold text-lg text-indigo-700 mb-3">Manage User Roles</h3>
                            <div id="user-roles-list" class="space-y-3 max-h-64 overflow-y-auto">
                                <p class="text-gray-500 text-sm">Loading users...</p>
                                </div>
                            <button onclick="saveAllRoleChanges()" class="mt-4 w-full py-2 text-sm text-white bg-indigo-500 hover:bg-indigo-600 rounded-lg">Save All Changes</button>
                                </div>

                        <!-- System Stats -->
                        <div class="p-4 border rounded-xl bg-gray-50">
                            <h3 class="font-bold text-lg text-gray-800 mb-3">System Statistics</h3>
                            <div id="system-stats" class="space-y-3">
                                <p class="text-gray-500 text-sm">Loading...</p>
                            </div>
                        </div>
                        </div>

                    <!-- Pending Requests Section -->
                    <div class="mt-6 p-4 border rounded-xl">
                        <h3 class="font-bold text-lg text-purple-700 mb-3">Pending Employee Requests</h3>
                        <div id="pending-requests-admin" class="space-y-3 max-h-96 overflow-y-auto">
                            <p class="text-gray-500 text-sm">Loading requests...</p>
                        </div>
                    </div>
                </div>
            `;
        }

        window.loadSecurityPage = async function() {
            await Promise.all([
                loadUserRoles(),
                loadSystemStats(),
                loadPendingRequestsAdmin(),
                loadPendingApprovals(),
                loadActiveKeys()
            ]);
        };

        // Generate Admin/CEO Key
        window.generateAdminKey = async function(role) {
            try {
                // Generate unique key
                const key = 'ADM-' + Math.random().toString(36).substring(2, 10).toUpperCase() + '-' + Date.now().toString(36).toUpperCase();
                
                const { error } = await client
                    .from('admin_keys')
                    .insert([{
                        key: key,
                        role: role,
                        generated_by: currentUser.id,
                        generated_by_name: currentUser.name,
                        generated_at: new Date().toISOString(),
                        used: false
                    }]);

                if (error) throw error;

                // Display the key
                document.getElementById('generated-key-text').textContent = key;
                document.getElementById('generated-key-display').classList.remove('hidden');
                showToast(`${role.toUpperCase()} key generated successfully!`, 'success');
                
                // Reload keys list
                loadActiveKeys();
            } catch (err) {
                console.error('Error generating key:', err);
                showToast('Failed to generate key: ' + err.message, 'error');
            }
        };

        // Load active keys
        async function loadActiveKeys() {
            if (currentUser.role !== 'ceo') return;
            
            try {
                const { data, error } = await client
                    .from('admin_keys')
                    .select('*')
                    .eq('used', false)
                    .order('generated_at', { ascending: false });

                if (error) throw error;

                const container = document.getElementById('keys-container');
                if (!container) return;

                if (!data || data.length === 0) {
                    container.innerHTML = '<p class="text-xs text-gray-500">No active keys</p>';
                    return;
                }

                container.innerHTML = data.map(k => `
                    <div class="p-2 bg-white rounded border border-purple-200 flex justify-between items-center">
                        <div>
                            <p class="font-mono text-sm font-semibold text-purple-700">${k.key}</p>
                            <p class="text-xs text-gray-500">${k.role.toUpperCase()} ‚Ä¢ Generated ${new Date(k.generated_at).toLocaleDateString()}</p>
                        </div>
                        <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-700">Active</span>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Error loading keys:', err);
            }
        }

        // Load pending approvals
        async function loadPendingApprovals() {
            if (currentUser.role === 'employee') return;

            const container = document.getElementById('pending-approvals-list');
            if (!container) return;

            try {
                // Query for pending approvals
                const { data, error } = await client
                    .from('users')
                    .select('*')
                    .eq('account_status', 'pending_approval');
                
                console.log('Pending approvals query result:', { data, error, count: data?.length });

                if (error) {
                    console.error('Error loading pending approvals:', error);
                    container.innerHTML = '<p class="text-red-500 text-sm">Error loading approvals: ' + error.message + '</p>';
                    return;
                }

                if (!data || data.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-sm">No pending approvals</p>';
                    return;
                }

                container.innerHTML = data.map(user => {
                    // Handle created_at if it doesn't exist
                    const createdDate = user.created_at 
                        ? new Date(user.created_at).toLocaleDateString() 
                        : 'Recently';
                    
                    return `
                    <div class="p-3 bg-white rounded-lg border border-yellow-300 flex justify-between items-center">
                        <div>
                            <p class="font-semibold text-gray-800">${user.name} (${user.id})</p>
                            <p class="text-xs text-gray-500">Role: ${user.role.toUpperCase()} ‚Ä¢ Created: ${createdDate}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="approveAccount('${user.id}')" class="px-3 py-1 text-xs text-white bg-green-500 hover:bg-green-600 rounded">Approve</button>
                            <button onclick="rejectAccount('${user.id}')" class="px-3 py-1 text-xs text-white bg-red-500 hover:bg-red-600 rounded">Reject</button>
                        </div>
                    </div>
                `;
                }).join('');
            } catch (err) {
                console.error('Error loading approvals:', err);
                container.innerHTML = '<p class="text-red-500 text-sm">Error loading approvals. Please refresh the page.</p>';
            }
        }

        window.approveAccount = async function(userId) {
            try {
                const { error } = await client
                    .from('users')
                    .update({ account_status: 'active' })
                    .eq('id', userId);

                if (error) throw error;

                showToast('Account approved successfully!', 'success');
                loadPendingApprovals();
            } catch (err) {
                console.error('Error approving account:', err);
                showToast('Failed to approve account', 'error');
            }
        };

        window.rejectAccount = async function(userId) {
            if (!confirm('Are you sure you want to reject this account? This will delete the user.')) return;

            try {
                const { error } = await client
                    .from('users')
                    .delete()
                    .eq('id', userId);

                if (error) throw error;

                showToast('Account rejected and deleted.', 'success');
                loadPendingApprovals();
            } catch (err) {
                console.error('Error rejecting account:', err);
                showToast('Failed to reject account', 'error');
            }
        };

        async function loadUserRoles() {
            const container = document.getElementById('user-roles-list');
            if (!container) return;

            try {
                const { data, error } = await client
                    .from('users')
                    .select('id, name, username, role')
                    .order('name');

                if (error) throw error;

                if (!data || data.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-sm">No users found.</p>';
                    return;
                }

                container.innerHTML = data.map(user => `
                    <div class="flex justify-between items-center p-2 bg-white rounded border">
                        <div>
                            <span class="font-medium">${user.name}</span>
                            <span class="text-xs text-gray-500 ml-1">(${user.id})</span>
                        </div>
                        <select id="role-${user.id}" class="p-1 border rounded text-sm" data-original="${user.role}">
                            <option value="employee" ${user.role === 'employee' ? 'selected' : ''}>Employee</option>
                            <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                            <option value="ceo" ${user.role === 'ceo' ? 'selected' : ''}>CEO</option>
                        </select>
                    </div>
                `).join('');

            } catch (err) {
                console.error('Error loading user roles:', err);
                container.innerHTML = '<p class="text-red-500 text-sm">Error loading users.</p>';
            }
        }

        async function loadSystemStats() {
            const container = document.getElementById('system-stats');
            if (!container) return;

            try {
                // Count users by role
                const { data: users } = await client.from('users').select('role');
                const employeeCount = users?.filter(u => u.role === 'employee').length || 0;
                const adminCount = users?.filter(u => u.role === 'admin').length || 0;
                const ceoCount = users?.filter(u => u.role === 'ceo').length || 0;

                // Count attendance records today
                const today = new Date().toISOString().split('T')[0];
                const { count: todayClockIns } = await client
                    .from('attendance')
                    .select('*', { count: 'exact', head: true })
                    .eq('date', today);

                // Count pending requests
                const { count: pendingRequests } = await client
                    .from('requests')
                    .select('*', { count: 'exact', head: true })
                    .eq('status', 'pending');

                container.innerHTML = `
                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-3 bg-blue-50 rounded-lg">
                            <p class="text-xs text-blue-600">Employees</p>
                            <p class="text-xl font-bold text-blue-800">${employeeCount}</p>
                        </div>
                        <div class="p-3 bg-purple-50 rounded-lg">
                            <p class="text-xs text-purple-600">Admins</p>
                            <p class="text-xl font-bold text-purple-800">${adminCount}</p>
                        </div>
                        <div class="p-3 bg-green-50 rounded-lg">
                            <p class="text-xs text-green-600">Clock-ins Today</p>
                            <p class="text-xl font-bold text-green-800">${todayClockIns || 0}</p>
                        </div>
                        <div class="p-3 bg-yellow-50 rounded-lg">
                            <p class="text-xs text-yellow-600">Pending Requests</p>
                            <p class="text-xl font-bold text-yellow-800">${pendingRequests || 0}</p>
                        </div>
                    </div>
                `;
            } catch (err) {
                console.error('Error loading system stats:', err);
                container.innerHTML = '<p class="text-red-500 text-sm">Error loading stats.</p>';
            }
        }

        async function loadPendingRequestsAdmin() {
            const container = document.getElementById('pending-requests-admin');
            if (!container) return;

            try {
                const { data, error } = await client
                    .from('requests')
                    .select('*')
                    .eq('status', 'pending')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (!data || data.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">No pending requests.</p>';
                    return;
                }

                container.innerHTML = data.map(req => `
                    <div class="p-3 border rounded-lg bg-white">
                        <div class="flex justify-between items-start">
                            <div>
                                <span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">${req.request_type}</span>
                                <p class="font-medium mt-1">Employee: ${req.employee_name || req.employee_id}</p>
                                <p class="text-sm text-gray-600 mt-1">${req.details || 'No details provided'}</p>
                                <p class="text-xs text-gray-400 mt-1">Submitted: ${new Date(req.created_at).toLocaleString()}</p>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="approveRequest('${req.id}')" class="px-3 py-1 text-sm text-white bg-green-500 hover:bg-green-600 rounded">Approve</button>
                                <button onclick="rejectRequest('${req.id}')" class="px-3 py-1 text-sm text-white bg-red-500 hover:bg-red-600 rounded">Reject</button>
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch (err) {
                console.error('Error loading requests:', err);
                container.innerHTML = '<p class="text-red-500 text-sm">Error loading requests.</p>';
            }
        }

        window.saveAllRoleChanges = async function() {
            const selects = document.querySelectorAll('[id^="role-"]');
            const changes = [];

            selects.forEach(select => {
                const userId = select.id.replace('role-', '');
                const newRole = select.value;
                const originalRole = select.dataset.original;

                if (newRole !== originalRole) {
                    changes.push({ id: userId, role: newRole });
                }
            });

            if (changes.length === 0) {
                alert('No changes to save.');
                return;
            }

            if (!confirm(`You are about to change roles for ${changes.length} user(s). Continue?`)) return;

            try {
                for (const change of changes) {
                    const { error } = await client
                        .from('users')
                        .update({ role: change.role })
                        .eq('id', change.id);

                    if (error) throw error;
                }

                alert('‚úÖ Roles updated successfully!');
                loadUserRoles();
            } catch (err) {
                console.error('Error saving role changes:', err);
                alert('‚ùå Failed to update roles: ' + err.message);
            }
        };

        window.approveRequest = async function(requestId) {
            await updateRequestStatus(requestId, 'approved');
        };

        window.rejectRequest = async function(requestId) {
            await updateRequestStatus(requestId, 'rejected');
        };

        async function updateRequestStatus(requestId, status) {
            try {
                const { error } = await client
                    .from('requests')
                    .update({ status, processed_at: new Date().toISOString(), processed_by: currentUser.id })
                    .eq('id', requestId);

                if (error) throw error;

                alert(`‚úÖ Request ${status}!`);
                loadPendingRequestsAdmin();
                loadSystemStats();
            } catch (err) {
                console.error('Error updating request:', err);
                alert('‚ùå Failed to update request.');
            }
        }
        
        function renderReportingConsole() {
            return `
                <div class="bg-white p-6 rounded-xl shadow-md max-w-4xl">
                    <h2 class="text-xl font-bold mb-4">System Reporting Console</h2>
                    <p class="text-sm text-gray-500 mb-6">Generate ad-hoc reports and access previously saved payroll, HR, and financial report documents.</p>

                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <select id="report-type" class="p-3 border rounded-lg bg-white">
                            <option value="">Select Report Type</option>
                            <option value="salary_list">Employee Salary List</option>
                            <option value="hours_summary">Hours Summary Report</option>
                            <option value="deductions">Deductions Summary</option>
                            <option value="tax_filing">Tax Filing Data Export</option>
                        </select>
                        <input type="date" id="report-start" class="p-3 border rounded-lg">
                        <input type="date" id="report-end" class="p-3 border rounded-lg">
                    </div>

                    <div class="flex space-x-4">
                        <button onclick="generateReport()" class="py-3 px-6 text-white font-semibold rounded-xl accent-gradient hover:opacity-90 transition">
                            Generate New Report
                        </button>
                        <button onclick="exportReportToCSV()" class="py-3 px-6 text-purple-600 font-semibold rounded-xl border border-purple-300 hover:bg-purple-50 transition">
                            Export to CSV
                        </button>
                    </div>

                    <!-- Report Display Area -->
                    <div id="report-display" class="mt-8 p-4 border-2 border-dashed border-gray-200 rounded-xl bg-gray-50">
                        <p class="text-gray-500 text-center py-8">Select a report type and date range, then click "Generate New Report"</p>
                    </div>

                    <div class="mt-8">
                        <h3 class="text-lg font-semibold mb-3">Generated Reports History</h3>
                        <div id="reports-history" class="space-y-3">
                            <p class="text-gray-500 text-sm">Reports you generate will appear here for quick access.</p>
                            </div>
                            </div>
                        </div>
            `;
        }

        // Report generation storage
        let generatedReports = [];
        let currentReportData = null;

        window.generateReport = async function() {
            const reportType = document.getElementById('report-type').value;
            const startDate = document.getElementById('report-start').value;
            const endDate = document.getElementById('report-end').value;
            const displayArea = document.getElementById('report-display');

            if (!reportType) {
                alert('‚ùå Please select a report type.');
                return;
            }

            if (!startDate || !endDate) {
                alert('‚ùå Please select both start and end dates.');
                return;
            }

            displayArea.innerHTML = '<p class="text-gray-500 text-center py-8">Generating report...</p>';

            try {
                let reportHTML = '';
                let reportTitle = '';

                switch (reportType) {
                    case 'salary_list':
                        reportTitle = 'Employee Salary List';
                        reportHTML = await generateSalaryListReport(startDate, endDate);
                        break;
                    case 'hours_summary':
                        reportTitle = 'Hours Summary Report';
                        reportHTML = await generateHoursSummaryReport(startDate, endDate);
                        break;
                    case 'deductions':
                        reportTitle = 'Deductions Summary';
                        reportHTML = await generateDeductionsReport(startDate, endDate);
                        break;
                    case 'tax_filing':
                        reportTitle = 'Tax Filing Data';
                        reportHTML = await generateTaxFilingReport(startDate, endDate);
                        break;
                }

                displayArea.innerHTML = `
                    <div class="bg-white rounded-lg">
                        <div class="flex justify-between items-center mb-4 pb-3 border-b">
                            <h4 class="font-bold text-lg text-gray-800">${reportTitle}</h4>
                            <span class="text-sm text-gray-500">Period: ${startDate} to ${endDate}</span>
                    </div>
                        ${reportHTML}
                        <p class="text-xs text-gray-400 mt-4">Generated: ${new Date().toLocaleString()}</p>
                </div>
            `;

                // Add to history
                addReportToHistory(reportTitle, startDate, endDate);

            } catch (err) {
                console.error('Report generation error:', err);
                displayArea.innerHTML = '<p class="text-red-500 text-center py-8">Error generating report: ' + err.message + '</p>';
            }
        };

        async function generateSalaryListReport(startDate, endDate) {
            const { data, error } = await client
                .from('payroll_records')
                .select('*')
                .gte('period_start', startDate)
                .lte('period_end', endDate)
                .order('employee_name');

            if (error) throw error;

            if (!data || data.length === 0) {
                return '<p class="text-gray-500 text-center py-4">No payroll records found for this period.</p>';
            }

            currentReportData = data;

            let html = `
                <table class="min-w-full divide-y divide-gray-200 text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-2 text-left font-medium text-gray-500">Employee ID</th>
                            <th class="px-3 py-2 text-left font-medium text-gray-500">Name</th>
                            <th class="px-3 py-2 text-right font-medium text-gray-500">Hours</th>
                            <th class="px-3 py-2 text-right font-medium text-gray-500">Rate</th>
                            <th class="px-3 py-2 text-right font-medium text-gray-500">Gross Pay</th>
                            <th class="px-3 py-2 text-right font-medium text-gray-500">Net Pay</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
            `;

            let totals = { hours: 0, gross: 0, net: 0 };
            data.forEach(r => {
                totals.hours += r.total_hours || 0;
                totals.gross += r.gross_pay || 0;
                totals.net += r.net_pay || 0;
                html += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-3 py-2">${r.employee_id}</td>
                        <td class="px-3 py-2">${r.employee_name || '-'}</td>
                        <td class="px-3 py-2 text-right">${(r.total_hours || 0).toFixed(2)}</td>
                        <td class="px-3 py-2 text-right">JMD ${r.hourly_rate || HOURLY_RATE}</td>
                        <td class="px-3 py-2 text-right">JMD ${(r.gross_pay || 0).toLocaleString()}</td>
                        <td class="px-3 py-2 text-right font-medium text-green-600">JMD ${(r.net_pay || 0).toLocaleString()}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                    <tfoot class="bg-gray-100 font-bold">
                        <tr>
                            <td colspan="2" class="px-3 py-2">TOTALS (${data.length} employees)</td>
                            <td class="px-3 py-2 text-right">${totals.hours.toFixed(2)}</td>
                            <td class="px-3 py-2"></td>
                            <td class="px-3 py-2 text-right">JMD ${totals.gross.toLocaleString()}</td>
                            <td class="px-3 py-2 text-right text-green-600">JMD ${totals.net.toLocaleString()}</td>
                        </tr>
                    </tfoot>
                </table>
            `;

            return html;
        }

        async function generateHoursSummaryReport(startDate, endDate) {
            const { data, error } = await client
                .from('attendance')
                .select('*')
                .gte('date', startDate)
                .lte('date', endDate)
                .not('clock_out', 'is', null)
                .order('date');

            if (error) throw error;

            if (!data || data.length === 0) {
                return '<p class="text-gray-500 text-center py-4">No attendance records found for this period.</p>';
            }

            // Group by employee
            const employeeHours = {};
            data.forEach(r => {
                const empId = r.employee_id;
                if (!employeeHours[empId]) {
                    employeeHours[empId] = { total: 0, days: new Set(), records: 0 };
                }
                const hours = calculateHoursFromRecord(r);
                employeeHours[empId].total += hours;
                employeeHours[empId].days.add(r.date);
                employeeHours[empId].records++;
            });

            currentReportData = Object.entries(employeeHours).map(([id, data]) => ({
                employee_id: id,
                total_hours: data.total,
                days_worked: data.days.size,
                records: data.records
            }));

            let html = `
                <table class="min-w-full divide-y divide-gray-200 text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-2 text-left font-medium text-gray-500">Employee ID</th>
                            <th class="px-3 py-2 text-right font-medium text-gray-500">Days Worked</th>
                            <th class="px-3 py-2 text-right font-medium text-gray-500">Clock Records</th>
                            <th class="px-3 py-2 text-right font-medium text-gray-500">Total Hours</th>
                            <th class="px-3 py-2 text-right font-medium text-gray-500">Avg Hours/Day</th>
                            <th class="px-3 py-2 text-right font-medium text-gray-500">Est. Pay (JMD)</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
            `;

            let grandTotal = 0;
            Object.entries(employeeHours).forEach(([empId, data]) => {
                grandTotal += data.total;
                const avgHours = data.days.size > 0 ? data.total / data.days.size : 0;
                html += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-3 py-2 font-medium">${empId}</td>
                        <td class="px-3 py-2 text-right">${data.days.size}</td>
                        <td class="px-3 py-2 text-right">${data.records}</td>
                        <td class="px-3 py-2 text-right font-medium">${data.total.toFixed(2)}</td>
                        <td class="px-3 py-2 text-right">${avgHours.toFixed(2)}</td>
                        <td class="px-3 py-2 text-right text-green-600">JMD ${(data.total * HOURLY_RATE).toLocaleString()}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                    <tfoot class="bg-gray-100 font-bold">
                        <tr>
                            <td class="px-3 py-2">TOTAL</td>
                            <td colspan="2"></td>
                            <td class="px-3 py-2 text-right">${grandTotal.toFixed(2)} hrs</td>
                            <td></td>
                            <td class="px-3 py-2 text-right text-green-600">JMD ${(grandTotal * HOURLY_RATE).toLocaleString()}</td>
                        </tr>
                    </tfoot>
                </table>
            `;

            return html;
        }

        async function generateDeductionsReport(startDate, endDate) {
            const { data, error } = await client
                .from('payroll_records')
                .select('*')
                .gte('period_start', startDate)
                .lte('period_end', endDate);

            if (error) throw error;

            if (!data || data.length === 0) {
                return '<p class="text-gray-500 text-center py-4">No payroll records found for this period.</p>';
            }

            currentReportData = data;

            let html = `
                <table class="min-w-full divide-y divide-gray-200 text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-2 text-left font-medium text-gray-500">Employee</th>
                            <th class="px-3 py-2 text-right font-medium text-gray-500">Gross Pay</th>
                            <th class="px-3 py-2 text-right font-medium text-gray-500">NIS (3%)</th>
                            <th class="px-3 py-2 text-right font-medium text-gray-500">NHT (2%)</th>
                            <th class="px-3 py-2 text-right font-medium text-gray-500">PAYE</th>
                            <th class="px-3 py-2 text-right font-medium text-gray-500">Total Ded.</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
            `;

            let totals = { gross: 0, nis: 0, nht: 0, paye: 0, total: 0 };
            data.forEach(r => {
                totals.gross += r.gross_pay || 0;
                totals.nis += r.nis || 0;
                totals.nht += r.nht || 0;
                totals.paye += r.paye || 0;
                totals.total += r.total_deductions || 0;
                html += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-3 py-2">${r.employee_name || r.employee_id}</td>
                        <td class="px-3 py-2 text-right">JMD ${(r.gross_pay || 0).toLocaleString()}</td>
                        <td class="px-3 py-2 text-right text-red-600">-JMD ${(r.nis || 0).toLocaleString()}</td>
                        <td class="px-3 py-2 text-right text-red-600">-JMD ${(r.nht || 0).toLocaleString()}</td>
                        <td class="px-3 py-2 text-right text-red-600">-JMD ${(r.paye || 0).toLocaleString()}</td>
                        <td class="px-3 py-2 text-right font-medium text-red-600">-JMD ${(r.total_deductions || 0).toLocaleString()}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                    <tfoot class="bg-gray-100 font-bold">
                        <tr>
                            <td class="px-3 py-2">TOTALS</td>
                            <td class="px-3 py-2 text-right">JMD ${totals.gross.toLocaleString()}</td>
                            <td class="px-3 py-2 text-right text-red-600">-JMD ${totals.nis.toLocaleString()}</td>
                            <td class="px-3 py-2 text-right text-red-600">-JMD ${totals.nht.toLocaleString()}</td>
                            <td class="px-3 py-2 text-right text-red-600">-JMD ${totals.paye.toLocaleString()}</td>
                            <td class="px-3 py-2 text-right text-red-600">-JMD ${totals.total.toLocaleString()}</td>
                        </tr>
                    </tfoot>
                </table>
            `;

            return html;
        }

        async function generateTaxFilingReport(startDate, endDate) {
            const { data, error } = await client
                .from('payroll_records')
                .select('*')
                .gte('period_start', startDate)
                .lte('period_end', endDate);

            if (error) throw error;

            if (!data || data.length === 0) {
                return '<p class="text-gray-500 text-center py-4">No payroll records found for this period.</p>';
            }

            // Aggregate by employee for tax filing
            const employeeTotals = {};
            data.forEach(r => {
                const empId = r.employee_id;
                if (!employeeTotals[empId]) {
                    employeeTotals[empId] = { name: r.employee_name, gross: 0, nis: 0, nht: 0, paye: 0 };
                }
                employeeTotals[empId].gross += r.gross_pay || 0;
                employeeTotals[empId].nis += r.nis || 0;
                employeeTotals[empId].nht += r.nht || 0;
                employeeTotals[empId].paye += r.paye || 0;
            });

            currentReportData = Object.entries(employeeTotals).map(([id, data]) => ({
                employee_id: id,
                employee_name: data.name,
                total_gross: data.gross,
                total_nis: data.nis,
                total_nht: data.nht,
                total_paye: data.paye
            }));

            let html = `
                <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                    <p class="text-sm text-blue-800"><strong>Tax Filing Summary</strong> - Use this data for statutory submissions to TAJ (Tax Administration Jamaica)</p>
                </div>
                <table class="min-w-full divide-y divide-gray-200 text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-2 text-left font-medium text-gray-500">TRN/Emp ID</th>
                            <th class="px-3 py-2 text-left font-medium text-gray-500">Employee Name</th>
                            <th class="px-3 py-2 text-right font-medium text-gray-500">Total Emoluments</th>
                            <th class="px-3 py-2 text-right font-medium text-gray-500">NIS Contrib.</th>
                            <th class="px-3 py-2 text-right font-medium text-gray-500">NHT Contrib.</th>
                            <th class="px-3 py-2 text-right font-medium text-gray-500">PAYE Withheld</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
            `;

            let totals = { gross: 0, nis: 0, nht: 0, paye: 0 };
            Object.entries(employeeTotals).forEach(([empId, data]) => {
                totals.gross += data.gross;
                totals.nis += data.nis;
                totals.nht += data.nht;
                totals.paye += data.paye;
                html += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-3 py-2 font-mono">${empId}</td>
                        <td class="px-3 py-2">${data.name || '-'}</td>
                        <td class="px-3 py-2 text-right">JMD ${data.gross.toLocaleString()}</td>
                        <td class="px-3 py-2 text-right">JMD ${data.nis.toLocaleString()}</td>
                        <td class="px-3 py-2 text-right">JMD ${data.nht.toLocaleString()}</td>
                        <td class="px-3 py-2 text-right">JMD ${data.paye.toLocaleString()}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                    <tfoot class="bg-gray-100 font-bold">
                        <tr>
                            <td colspan="2" class="px-3 py-2">EMPLOYER TOTALS</td>
                            <td class="px-3 py-2 text-right">JMD ${totals.gross.toLocaleString()}</td>
                            <td class="px-3 py-2 text-right">JMD ${totals.nis.toLocaleString()}</td>
                            <td class="px-3 py-2 text-right">JMD ${totals.nht.toLocaleString()}</td>
                            <td class="px-3 py-2 text-right">JMD ${totals.paye.toLocaleString()}</td>
                        </tr>
                    </tfoot>
                </table>
            `;

            return html;
        }

        function addReportToHistory(title, startDate, endDate) {
            const historyContainer = document.getElementById('reports-history');
            if (!historyContainer) return;

            const reportId = Date.now();
            generatedReports.push({ id: reportId, title, startDate, endDate, timestamp: new Date() });

            // Update the history display
            if (generatedReports.length === 1) {
                historyContainer.innerHTML = '';
            }

            const reportEl = document.createElement('div');
            reportEl.className = 'p-3 border rounded-lg flex justify-between items-center bg-gray-50';
            reportEl.innerHTML = `
                <span>${title} (${startDate} to ${endDate})</span>
                <span class="text-xs text-gray-500">${new Date().toLocaleString()}</span>
                <button onclick="reloadReport(${reportId})" class="text-purple-600 hover:text-indigo-600 text-sm font-semibold">Reload</button>
            `;
            historyContainer.insertBefore(reportEl, historyContainer.firstChild);
        }

        window.reloadReport = function(reportId) {
            const report = generatedReports.find(r => r.id === reportId);
            if (report) {
                document.getElementById('report-start').value = report.startDate;
                document.getElementById('report-end').value = report.endDate;
                generateReport();
            }
        };

        window.exportReportToCSV = function() {
            if (!currentReportData || currentReportData.length === 0) {
                alert('‚ùå Please generate a report first.');
                return;
            }

            // Get headers from first object
            const headers = Object.keys(currentReportData[0]);
            let csvContent = headers.join(',') + '\n';

            currentReportData.forEach(row => {
                const values = headers.map(h => {
                    let val = row[h];
                    if (typeof val === 'string' && val.includes(',')) {
                        val = '"' + val + '"';
                    }
                    return val;
                });
                csvContent += values.join(',') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `report_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            alert('‚úÖ Report exported to CSV!');
        };

        function renderSystemMaintenance() {
            return `
                <div class="bg-white p-6 rounded-xl shadow-md max-w-3xl">
                    <h2 class="text-xl font-bold mb-4">System Maintenance and Data Management</h2>
                    <p class="text-sm text-gray-500 mb-6">Perform critical system tasks such as data backups and records purging.</p>

                    <div class="space-y-6">
                        <!-- Backup Section -->
                        <div class="p-4 border border-green-200 rounded-xl">
                            <h3 class="font-bold text-lg text-green-700 mb-3">üîí System Database Backup</h3>
                            <p class="text-sm text-gray-600 mb-3">Create a full database-level backup of all tables. Only one admin can manage backups at a time.</p>
                            
                            <div id="backup-lock-status" class="mb-4 p-3 rounded-lg bg-gray-50">
                                <p class="text-sm text-gray-600">Checking backup lock status...</p>
                            </div>
                            
                            <div id="backup-info" class="mb-4 grid grid-cols-2 gap-4">
                                <div class="p-3 bg-green-50 rounded-lg">
                                    <p class="text-xs text-green-600">Last Backup</p>
                                    <p id="last-backup-time" class="text-sm font-semibold text-green-800">Checking...</p>
                                </div>
                                <div class="p-3 bg-blue-50 rounded-lg">
                                    <p class="text-xs text-blue-600">Backup Owner</p>
                                    <p id="backup-owner" class="text-sm font-semibold text-blue-800">Checking...</p>
                                </div>
                            </div>
                            
                            <div id="backup-records-count" class="mb-4 p-3 bg-purple-50 rounded-lg hidden">
                                <p class="text-xs text-purple-600 mb-2">Records in Backup Tables</p>
                                <div class="grid grid-cols-4 gap-2 text-center text-xs">
                                    <div><span class="font-bold text-purple-800" id="backup-users-count">-</span><br>Users</div>
                                    <div><span class="font-bold text-purple-800" id="backup-attendance-count">-</span><br>Attendance</div>
                                    <div><span class="font-bold text-purple-800" id="backup-payroll-count">-</span><br>Payroll</div>
                                    <div><span class="font-bold text-purple-800" id="backup-requests-count">-</span><br>Requests</div>
                                </div>
                            </div>
                            
                            <div class="flex gap-3">
                                <button id="backup-btn" onclick="runSystemBackup()" class="flex-1 py-3 px-4 text-sm text-white bg-green-500 hover:bg-green-600 rounded-lg font-semibold disabled:opacity-50 disabled:cursor-not-allowed">
                                    üîÑ Run Database Backup
                                </button>
                                <button id="export-backup-btn" onclick="exportBackupToFile()" class="py-3 px-4 text-sm text-white bg-blue-500 hover:bg-blue-600 rounded-lg font-semibold">
                                    üì• Export JSON
                                </button>
                            </div>
                            <p id="backup-action-hint" class="text-xs text-gray-500 mt-2 text-center"></p>
                        </div>

                        <!-- Purge Section -->
                        <div class="p-4 border border-red-200 rounded-xl bg-red-50">
                            <h3 class="font-bold text-lg text-red-700 mb-3">Purge Ancient Records</h3>
                            <p class="text-sm text-gray-600 mb-3">Permanently delete records older than the specified date to maintain data privacy and compliance. <strong>This action is irreversible.</strong></p>
                            <div class="flex space-x-4">
                                <input type="date" id="purge-date" value="2015-01-01" class="p-3 border rounded-lg flex-grow">
                                <button onclick="executePurge()" class="py-2 px-4 text-sm text-white bg-red-600 hover:bg-red-700 rounded-lg">Execute Purge</button>
                            </div>
                        </div>

                        <!-- Database Stats -->
                        <div class="p-4 border border-gray-200 rounded-xl">
                            <h3 class="font-bold text-lg text-gray-700 mb-3">Database Statistics</h3>
                            <div id="db-stats" class="grid grid-cols-4 gap-4">
                                <div class="p-3 bg-blue-50 rounded-lg text-center">
                                    <p class="text-xs text-blue-600">Users</p>
                                    <p id="stat-users" class="text-xl font-bold text-blue-800">-</p>
                                </div>
                                <div class="p-3 bg-purple-50 rounded-lg text-center">
                                    <p class="text-xs text-purple-600">Attendance</p>
                                    <p id="stat-attendance" class="text-xl font-bold text-purple-800">-</p>
                                </div>
                                <div class="p-3 bg-green-50 rounded-lg text-center">
                                    <p class="text-xs text-green-600">Payroll Records</p>
                                    <p id="stat-payroll" class="text-xl font-bold text-green-800">-</p>
                                </div>
                                <div class="p-3 bg-yellow-50 rounded-lg text-center">
                                    <p class="text-xs text-yellow-600">Requests</p>
                                    <p id="stat-requests" class="text-xl font-bold text-yellow-800">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // System Maintenance Functions - Database Backup with Locking
        let backupSettings = null;

        // Initialize backup status when maintenance page loads
        window.initBackupStatus = async function() {
            try {
                // Check if backup_settings table exists and get current status
                const { data: settings, error } = await client
                    .from('backup_settings')
                    .select('*')
                    .limit(1)
                    .single();
                
                if (error && error.code === 'PGRST116') {
                    // No settings exist yet - backup never run
                    backupSettings = null;
                    updateBackupUI(null);
                } else if (error) {
                    throw error;
                } else {
                    backupSettings = settings;
                    updateBackupUI(settings);
                }
            } catch (err) {
                console.error('Error checking backup status:', err);
                document.getElementById('backup-lock-status').innerHTML = 
                    '<p class="text-red-600">‚ö†Ô∏è Could not check backup status. Table may not exist.</p>';
            }
        };

        function updateBackupUI(settings) {
            const lockStatusEl = document.getElementById('backup-lock-status');
            const lastBackupEl = document.getElementById('last-backup-time');
            const ownerEl = document.getElementById('backup-owner');
            const backupBtn = document.getElementById('backup-btn');
            const hintEl = document.getElementById('backup-action-hint');
            const recordsCountEl = document.getElementById('backup-records-count');
            const exportBtn = document.getElementById('export-backup-btn');

            if (!settings) {
                // No backup has ever been run
                lockStatusEl.innerHTML = '<p class="text-yellow-600">üîì <strong>No backup exists yet.</strong> First admin to click will become the backup owner.</p>';
                lastBackupEl.textContent = 'Never';
                ownerEl.textContent = 'None';
                backupBtn.innerHTML = 'üöÄ Initialize First Backup';
                backupBtn.disabled = false;
                if (exportBtn) {
                    exportBtn.disabled = true;
                    exportBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
                hintEl.textContent = 'Click to create backup tables and become the backup administrator.';
                recordsCountEl.classList.add('hidden');
            } else if (settings.locked_by === currentUser.id) {
                // Current user owns the backup
                lockStatusEl.innerHTML = '<p class="text-green-600">‚úÖ <strong>You own the backup lock.</strong> You can run backups anytime.</p>';
                lastBackupEl.textContent = new Date(settings.last_backup_at).toLocaleString();
                ownerEl.textContent = settings.locked_by_name + ' (You)';
                backupBtn.innerHTML = 'üîÑ Sync & Update Backup';
                backupBtn.disabled = false;
                if (exportBtn) {
                    exportBtn.disabled = false;
                    exportBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
                hintEl.textContent = 'This will update both original tables and backup tables.';
                recordsCountEl.classList.remove('hidden');
                loadBackupCounts();
            } else {
                // Another admin owns the backup
                lockStatusEl.innerHTML = `<p class="text-red-600">üîí <strong>Backup locked by ${settings.locked_by_name}.</strong> Only they can run backups.</p>`;
                lastBackupEl.textContent = new Date(settings.last_backup_at).toLocaleString();
                ownerEl.textContent = settings.locked_by_name;
                backupBtn.innerHTML = 'üîí Backup Locked';
                backupBtn.disabled = true;
                if (exportBtn) {
                    exportBtn.disabled = false;
                    exportBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
                hintEl.textContent = 'Contact ' + settings.locked_by_name + ' to run a backup or transfer ownership.';
                recordsCountEl.classList.remove('hidden');
                loadBackupCounts();
            }
        }

        async function loadBackupCounts() {
            try {
                const [usersRes, attendanceRes, payrollRes, requestsRes] = await Promise.all([
                    client.from('users_backup').select('*', { count: 'exact', head: true }),
                    client.from('attendance_backup').select('*', { count: 'exact', head: true }),
                    client.from('payroll_records_backup').select('*', { count: 'exact', head: true }),
                    client.from('requests_backup').select('*', { count: 'exact', head: true })
                ]);
                
                document.getElementById('backup-users-count').textContent = usersRes.count || 0;
                document.getElementById('backup-attendance-count').textContent = attendanceRes.count || 0;
                document.getElementById('backup-payroll-count').textContent = payrollRes.count || 0;
                document.getElementById('backup-requests-count').textContent = requestsRes.count || 0;
            } catch (err) {
                console.log('Could not load backup counts:', err.message);
            }
        }

        window.runSystemBackup = async function() {
            const isFirstBackup = !backupSettings;
            
            let confirmMsg = isFirstBackup 
                ? 'This will:\n1. Create backup tables in the database\n2. Copy all current data to backup tables\n3. Lock backups to your account\n\nContinue?'
                : 'This will sync all data to the backup tables.\n\nContinue?';
            
            if (!confirm(confirmMsg)) return;

            const backupBtn = document.getElementById('backup-btn');
            const originalText = backupBtn.innerHTML;
            backupBtn.innerHTML = '‚è≥ Backing up...';
            backupBtn.disabled = true;

            try {
                if (isFirstBackup) {
                    // First backup - create settings and lock to this user
                    await performFirstBackup();
                } else {
                    // Subsequent backup - sync data
                    await performSyncBackup();
                }
                
                // Refresh status
                await initBackupStatus();
                
            } catch (err) {
                console.error('Backup error:', err);
                alert('‚ùå Backup failed: ' + err.message);
                backupBtn.innerHTML = originalText;
                backupBtn.disabled = false;
            }
        };

        async function performFirstBackup() {
            // Fetch all current data
            const [usersRes, attendanceRes, payrollRes, requestsRes, announcementsRes] = await Promise.all([
                client.from('users').select('*'),
                client.from('attendance').select('*'),
                client.from('payroll_records').select('*'),
                client.from('requests').select('*'),
                client.from('announcements').select('*')
            ]);

            // Insert into backup tables (tables should be created via SQL first)
            const backupPromises = [];
            
            if (usersRes.data?.length > 0) {
                // Clear and insert
                await client.from('users_backup').delete().neq('id', '');
                backupPromises.push(client.from('users_backup').insert(usersRes.data));
            }
            
            if (attendanceRes.data?.length > 0) {
                await client.from('attendance_backup').delete().neq('id', '00000000-0000-0000-0000-000000000000');
                backupPromises.push(client.from('attendance_backup').insert(attendanceRes.data));
            }
            
            if (payrollRes.data?.length > 0) {
                await client.from('payroll_records_backup').delete().neq('id', '00000000-0000-0000-0000-000000000000');
                backupPromises.push(client.from('payroll_records_backup').insert(payrollRes.data));
            }
            
            if (requestsRes.data?.length > 0) {
                await client.from('requests_backup').delete().neq('id', '00000000-0000-0000-0000-000000000000');
                backupPromises.push(client.from('requests_backup').insert(requestsRes.data));
            }
            
            if (announcementsRes.data?.length > 0) {
                await client.from('announcements_backup').delete().neq('id', '00000000-0000-0000-0000-000000000000');
                backupPromises.push(client.from('announcements_backup').insert(announcementsRes.data));
            }

            await Promise.all(backupPromises);

            // Create backup settings and lock to this user
            const { error: settingsError } = await client
                .from('backup_settings')
                .insert({
                    locked_by: currentUser.id,
                    locked_by_name: currentUser.name,
                    last_backup_at: new Date().toISOString(),
                    backup_count: 1
                });

            if (settingsError) throw settingsError;

            const counts = {
                users: usersRes.data?.length || 0,
                attendance: attendanceRes.data?.length || 0,
                payroll: payrollRes.data?.length || 0,
                requests: requestsRes.data?.length || 0,
                announcements: announcementsRes.data?.length || 0
            };

            alert(`‚úÖ Initial backup completed!\n\nüîí Backup locked to: ${currentUser.name}\n\nRecords backed up:\n- Users: ${counts.users}\n- Attendance: ${counts.attendance}\n- Payroll: ${counts.payroll}\n- Requests: ${counts.requests}\n- Announcements: ${counts.announcements}`);
        }

        async function performSyncBackup() {
            // Fetch all current data
            const [usersRes, attendanceRes, payrollRes, requestsRes, announcementsRes] = await Promise.all([
                client.from('users').select('*'),
                client.from('attendance').select('*'),
                client.from('payroll_records').select('*'),
                client.from('requests').select('*'),
                client.from('announcements').select('*')
            ]);

            // Clear and reinsert into backup tables (full sync)
            await client.from('users_backup').delete().neq('id', '');
            await client.from('attendance_backup').delete().neq('id', '00000000-0000-0000-0000-000000000000');
            await client.from('payroll_records_backup').delete().neq('id', '00000000-0000-0000-0000-000000000000');
            await client.from('requests_backup').delete().neq('id', '00000000-0000-0000-0000-000000000000');
            await client.from('announcements_backup').delete().neq('id', '00000000-0000-0000-0000-000000000000');

            const backupPromises = [];
            
            if (usersRes.data?.length > 0) {
                backupPromises.push(client.from('users_backup').insert(usersRes.data));
            }
            if (attendanceRes.data?.length > 0) {
                backupPromises.push(client.from('attendance_backup').insert(attendanceRes.data));
            }
            if (payrollRes.data?.length > 0) {
                backupPromises.push(client.from('payroll_records_backup').insert(payrollRes.data));
            }
            if (requestsRes.data?.length > 0) {
                backupPromises.push(client.from('requests_backup').insert(requestsRes.data));
            }
            if (announcementsRes.data?.length > 0) {
                backupPromises.push(client.from('announcements_backup').insert(announcementsRes.data));
            }

            await Promise.all(backupPromises);

            // Update backup settings
            const { error: updateError } = await client
                .from('backup_settings')
                .update({
                    last_backup_at: new Date().toISOString(),
                    backup_count: (backupSettings.backup_count || 0) + 1
                })
                .eq('id', backupSettings.id);

            if (updateError) throw updateError;

            const counts = {
                users: usersRes.data?.length || 0,
                attendance: attendanceRes.data?.length || 0,
                payroll: payrollRes.data?.length || 0,
                requests: requestsRes.data?.length || 0,
                announcements: announcementsRes.data?.length || 0
            };

            alert(`‚úÖ Backup sync completed!\n\nRecords synced:\n- Users: ${counts.users}\n- Attendance: ${counts.attendance}\n- Payroll: ${counts.payroll}\n- Requests: ${counts.requests}\n- Announcements: ${counts.announcements}`);
        }

        // Export backup to JSON file (available to backup owner)
        window.exportBackupToFile = async function() {
            try {
                const [usersRes, attendanceRes, payrollRes, requestsRes, announcementsRes] = await Promise.all([
                    client.from('users_backup').select('*'),
                    client.from('attendance_backup').select('*'),
                    client.from('payroll_records_backup').select('*'),
                    client.from('requests_backup').select('*'),
                    client.from('announcements_backup').select('*')
                ]);

                const backupData = {
                    export_date: new Date().toISOString(),
                    exported_by: currentUser.name,
                    source: 'backup_tables',
                    data: {
                        users: usersRes.data || [],
                        attendance: attendanceRes.data || [],
                        payroll_records: payrollRes.data || [],
                        requests: requestsRes.data || [],
                        announcements: announcementsRes.data || []
                    },
                    counts: {
                        users: usersRes.data?.length || 0,
                        attendance: attendanceRes.data?.length || 0,
                        payroll_records: payrollRes.data?.length || 0,
                        requests: requestsRes.data?.length || 0,
                        announcements: announcementsRes.data?.length || 0
                    }
                };

                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `payflow_backup_export_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                alert('‚úÖ Backup data exported to file!');
            } catch (err) {
                console.error('Export error:', err);
                alert('‚ùå Export failed: ' + err.message);
            }
        };

        window.executePurge = async function() {
            const purgeDate = document.getElementById('purge-date').value;
            
            if (!purgeDate) {
                alert('‚ùå Please select a date.');
                return;
            }

            const confirmMsg = `‚ö†Ô∏è WARNING: IRREVERSIBLE ACTION ‚ö†Ô∏è\n\nThis will permanently delete ALL records created before ${purgeDate} from:\n- Attendance records\n- Payroll records\n- Requests\n\nUser accounts will NOT be deleted.\n\nAre you absolutely sure you want to proceed?`;

            if (!confirm(confirmMsg)) return;

            // Double confirmation
            const doubleConfirm = prompt(`Type "PURGE" to confirm deletion of records before ${purgeDate}:`);
            if (doubleConfirm !== 'PURGE') {
                alert('Purge cancelled.');
                return;
            }

            try {
                // Count records to be deleted first
                const { count: attendanceCount } = await client
                    .from('attendance')
                    .select('*', { count: 'exact', head: true })
                    .lt('date', purgeDate);

                const { count: payrollCount } = await client
                    .from('payroll_records')
                    .select('*', { count: 'exact', head: true })
                    .lt('period_end', purgeDate);

                const { count: requestCount } = await client
                    .from('requests')
                    .select('*', { count: 'exact', head: true })
                    .lt('created_at', purgeDate);

                // Execute deletions
                const [attDel, payDel, reqDel] = await Promise.all([
                    client.from('attendance').delete().lt('date', purgeDate),
                    client.from('payroll_records').delete().lt('period_end', purgeDate),
                    client.from('requests').delete().lt('created_at', purgeDate)
                ]);

                const errors = [attDel.error, payDel.error, reqDel.error].filter(e => e);
                
                if (errors.length > 0) {
                    console.error('Purge errors:', errors);
                    alert('‚ö†Ô∏è Some records could not be deleted. Check console for details.');
                } else {
                    alert(`‚úÖ Purge completed successfully!\n\nRecords deleted:\n- Attendance: ${attendanceCount || 0}\n- Payroll: ${payrollCount || 0}\n- Requests: ${requestCount || 0}`);
                }

                // Refresh stats
                loadMaintenanceStats();

            } catch (err) {
                console.error('Purge error:', err);
                alert('‚ùå Purge failed: ' + err.message);
            }
        };

        async function loadMaintenanceStats() {
            try {
                const [usersRes, attendanceRes, payrollRes, requestsRes] = await Promise.all([
                    client.from('users').select('*', { count: 'exact', head: true }),
                    client.from('attendance').select('*', { count: 'exact', head: true }),
                    client.from('payroll_records').select('*', { count: 'exact', head: true }),
                    client.from('requests').select('*', { count: 'exact', head: true })
                ]);

                const statUsers = document.getElementById('stat-users');
                const statAttendance = document.getElementById('stat-attendance');
                const statPayroll = document.getElementById('stat-payroll');
                const statRequests = document.getElementById('stat-requests');

                if (statUsers) statUsers.textContent = usersRes.count || 0;
                if (statAttendance) statAttendance.textContent = attendanceRes.count || 0;
                if (statPayroll) statPayroll.textContent = payrollRes.count || 0;
                if (statRequests) statRequests.textContent = requestsRes.count || 0;

            } catch (err) {
                console.error('Error loading maintenance stats:', err);
            }
        }

        function renderBudgetingContent(pageId) {
            const isEmployeePersonal = pageId === 'my_budget' && currentUser.role === 'employee';
            const isStaffManagement = pageId === 'emp_budget' && (currentUser.role === 'admin' || currentUser.role === 'ceo');
            const isBusiness = pageId === 'business_budget';

            let title;
            let mainContent;

            if (isEmployeePersonal) {
                title = 'My Personal Expense Projection';
                mainContent = `
                    <p class="text-sm text-gray-500 mb-6">Track your projected earnings and plan your personal budget based on your work hours.</p>
                    
                    <!-- Earnings Summary -->
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="p-4 bg-green-50 rounded-xl border border-green-200">
                            <p class="text-xs text-green-600 font-medium">Est. Monthly Earnings</p>
                            <p id="budget-monthly-earnings" class="text-2xl font-bold text-green-800">Loading...</p>
                    </div>
                        <div class="p-4 bg-blue-50 rounded-xl border border-blue-200">
                            <p class="text-xs text-blue-600 font-medium">Hours This Month</p>
                            <p id="budget-monthly-hours" class="text-2xl font-bold text-blue-800">Loading...</p>
                    </div>
                        <div class="p-4 bg-purple-50 rounded-xl border border-purple-200">
                            <p class="text-xs text-purple-600 font-medium">After Deductions</p>
                            <p id="budget-net-estimate" class="text-2xl font-bold text-purple-800">Loading...</p>
                        </div>
                    </div>

                    <!-- Budget Calculator -->
                    <div class="p-4 border rounded-xl bg-gray-50 mb-6">
                        <h3 class="font-bold text-gray-800 mb-3">Personal Budget Planner</h3>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="text-sm text-gray-600">Expected Hours Next Month</label>
                                <input type="number" id="planned-hours" value="160" class="w-full p-2 border rounded-lg mt-1">
                            </div>
                            <div>
                                <label class="text-sm text-gray-600">Rate (JMD/hour)</label>
                                <input type="number" value="${HOURLY_RATE}" class="w-full p-2 border rounded-lg mt-1 bg-gray-100" readonly>
                            </div>
                        </div>
                        <button onclick="calculatePersonalBudget()" class="py-2 px-4 text-sm font-semibold rounded-lg text-white accent-gradient">
                            Calculate Projection
                        </button>
                    </div>

                    <!-- Expense Categories -->
                    <div class="p-4 border rounded-xl">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-gray-800">Monthly Expense Categories</h3>
                            <button onclick="addExpenseCategory()" class="text-sm text-purple-600 hover:text-purple-800">+ Add Category</button>
                        </div>
                        <div id="expense-categories" class="space-y-2">
                            <div class="flex items-center justify-between p-2 bg-white rounded border">
                                <span>Rent/Housing</span>
                                <input type="number" class="w-32 p-1 border rounded text-right expense-input" value="50000" onchange="updateBudgetSummary()">
                            </div>
                            <div class="flex items-center justify-between p-2 bg-white rounded border">
                                <span>Transportation</span>
                                <input type="number" class="w-32 p-1 border rounded text-right expense-input" value="15000" onchange="updateBudgetSummary()">
                            </div>
                            <div class="flex items-center justify-between p-2 bg-white rounded border">
                                <span>Food/Groceries</span>
                                <input type="number" class="w-32 p-1 border rounded text-right expense-input" value="25000" onchange="updateBudgetSummary()">
                            </div>
                            <div class="flex items-center justify-between p-2 bg-white rounded border">
                                <span>Utilities</span>
                                <input type="number" class="w-32 p-1 border rounded text-right expense-input" value="10000" onchange="updateBudgetSummary()">
                            </div>
                            <div class="flex items-center justify-between p-2 bg-white rounded border">
                                <span>Savings</span>
                                <input type="number" class="w-32 p-1 border rounded text-right expense-input" value="10000" onchange="updateBudgetSummary()">
                            </div>
                        </div>
                        <div id="budget-summary" class="mt-4 p-3 bg-indigo-50 rounded-lg border border-indigo-200">
                            <div class="flex justify-between text-sm">
                                <span class="text-indigo-700">Total Planned Expenses:</span>
                                <span id="total-expenses" class="font-bold text-indigo-800">JMD 110,000</span>
                            </div>
                            <div class="flex justify-between text-sm mt-1">
                                <span class="text-indigo-700">Remaining After Expenses:</span>
                                <span id="remaining-budget" class="font-bold text-green-600">Calculating...</span>
                            </div>
                        </div>
                    </div>
                `;
            } else if (isStaffManagement) {
                title = 'Employee Budgeting Management';
                mainContent = `
                    <p class="text-sm text-gray-500 mb-6">Review and generate detailed expense projections for individual employees based on their work data.</p>
                    
                    <div class="flex space-x-4 mb-6">
                        <input type="text" id="emp-budget-id" placeholder="Employee ID" class="p-3 border rounded-lg flex-grow">
                        <select id="emp-budget-period" class="p-3 border rounded-lg bg-white">
                            <option value="current">Current Month</option>
                            <option value="last">Last Month</option>
                            <option value="quarter">This Quarter</option>
                            <option value="ytd">Year to Date</option>
                        </select>
                        <button onclick="loadEmployeeBudgetData()" class="py-2 px-4 text-sm font-semibold rounded-lg text-white bg-indigo-500 hover:bg-indigo-600 transition">
                            Load Data
                        </button>
                    </div>

                    <div id="emp-budget-results" class="p-4 border-2 border-dashed border-indigo-200 rounded-xl bg-indigo-50">
                        <p class="text-indigo-700 text-center py-8">Enter an Employee ID and click "Load Data" to view their budget projection.</p>
                    </div>
                `;
            } else if (isBusiness) {
                title = 'Business Budget Generation';
                mainContent = `
                    <p class="text-sm text-gray-500 mb-6">Generate company-wide payroll budget projections and forecasts.</p>
                    
                    <div class="flex space-x-4 mb-6">
                        <select id="business-budget-period" class="p-3 border rounded-lg bg-white">
                            <option value="next_month">Next Month Projection</option>
                            <option value="next_quarter">Next Quarter Projection</option>
                            <option value="annual">Annual Budget Forecast</option>
                        </select>
                        <button onclick="generateBusinessBudget()" class="py-2 px-4 text-sm font-semibold rounded-lg text-white accent-gradient">
                            Generate Budget Report
                        </button>
                    </div>

                    <div id="business-budget-results" class="p-4 border-2 border-dashed border-purple-200 rounded-xl bg-purple-50">
                        <p class="text-purple-700 text-center py-8">Select a projection period and click "Generate Budget Report".</p>
                    </div>
                `;
            } else {
                title = 'Budgeting Error';
                mainContent = '<p class="text-red-600">Invalid page or role context for budgeting tool.</p>';
            }

            return `
                <div class="bg-white p-6 rounded-xl shadow-md max-w-4xl">
                    <h2 class="text-xl font-bold mb-4">${title}</h2>
                    ${mainContent}
                </div>
            `;
        }

        // Budget page functions
        async function loadPersonalBudgetData() {
            try {
                // Get current month's hours
                const startOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
                
                const { data } = await client
                    .from('attendance')
                    .select('*')
                    .eq('employee_id', currentUser.id)
                    .gte('date', startOfMonth)
                    .not('clock_out', 'is', null);

                const totalHours = data?.reduce((sum, r) => sum + calculateHoursFromRecord(r), 0) || 0;
                const grossPay = totalHours * HOURLY_RATE;

                // Calculate deductions
                const nis = Math.min(grossPay * 0.03, 3000);
                const nht = grossPay * 0.02;
                const eduTax = grossPay * 0.0225;
                const annualized = grossPay * 12;
                const paye = annualized > 1500096 ? ((annualized - 1500096) * 0.25) / 12 : 0;
                const totalDed = nis + nht + eduTax + paye;
                const netPay = grossPay - totalDed;

                // Update UI
                const earningsEl = document.getElementById('budget-monthly-earnings');
                const hoursEl = document.getElementById('budget-monthly-hours');
                const netEl = document.getElementById('budget-net-estimate');

                if (earningsEl) earningsEl.textContent = 'JMD ' + grossPay.toLocaleString();
                if (hoursEl) hoursEl.textContent = totalHours.toFixed(1) + ' hrs';
                if (netEl) netEl.textContent = 'JMD ' + netPay.toLocaleString();

                // Update budget summary
                updateBudgetSummary();

            } catch (err) {
                console.error('Error loading personal budget data:', err);
            }
        }

        window.calculatePersonalBudget = function() {
            const hours = parseFloat(document.getElementById('planned-hours')?.value) || 0;
            const gross = hours * HOURLY_RATE;
            
            // Calculate deductions
            const nis = Math.min(gross * 0.03, 3000);
            const nht = gross * 0.02;
            const eduTax = gross * 0.0225;
            const annualized = gross * 12;
            const paye = annualized > 1500096 ? ((annualized - 1500096) * 0.25) / 12 : 0;
            const totalDed = nis + nht + eduTax + paye;
            const net = gross - totalDed;

            const netEstEl = document.getElementById('budget-net-estimate');
            if (netEstEl) {
                netEstEl.textContent = 'JMD ' + net.toLocaleString();
            }

            updateBudgetSummary();
            
            alert(`üìä Budget Projection for ${hours} hours:\n\nGross Pay: JMD ${gross.toLocaleString()}\nDeductions: JMD ${totalDed.toLocaleString()}\nNet Pay: JMD ${net.toLocaleString()}`);
        };

        window.updateBudgetSummary = function() {
            const inputs = document.querySelectorAll('.expense-input');
            let totalExpenses = 0;
            inputs.forEach(input => {
                totalExpenses += parseFloat(input.value) || 0;
            });

            const totalExpEl = document.getElementById('total-expenses');
            const remainingEl = document.getElementById('remaining-budget');
            const netEstEl = document.getElementById('budget-net-estimate');

            if (totalExpEl) {
                totalExpEl.textContent = 'JMD ' + totalExpenses.toLocaleString();
            }

            if (remainingEl && netEstEl) {
                const netText = netEstEl.textContent.replace('JMD ', '').replace(/,/g, '');
                const net = parseFloat(netText) || 0;
                const remaining = net - totalExpenses;
                remainingEl.textContent = 'JMD ' + remaining.toLocaleString();
                remainingEl.className = remaining >= 0 ? 'font-bold text-green-600' : 'font-bold text-red-600';
            }
        };

        window.addExpenseCategory = function() {
            const name = prompt('Enter expense category name:');
            if (!name) return;

            const container = document.getElementById('expense-categories');
            if (!container) return;

            const div = document.createElement('div');
            div.className = 'flex items-center justify-between p-2 bg-white rounded border';
            div.innerHTML = `
                <span>${name}</span>
                <div class="flex items-center space-x-2">
                    <input type="number" class="w-32 p-1 border rounded text-right expense-input" value="0" onchange="updateBudgetSummary()">
                    <button onclick="this.parentElement.parentElement.remove(); updateBudgetSummary();" class="text-red-500 hover:text-red-700 text-sm">√ó</button>
                </div>
            `;
            container.appendChild(div);
        };

        window.loadEmployeeBudgetData = async function() {
            const empId = document.getElementById('emp-budget-id')?.value.trim().toUpperCase();
            const period = document.getElementById('emp-budget-period')?.value;
            const resultsDiv = document.getElementById('emp-budget-results');

            if (!empId) {
                alert('‚ùå Please enter an Employee ID.');
                return;
            }

            resultsDiv.innerHTML = '<p class="text-indigo-700 text-center py-8">Loading...</p>';

            try {
                // Get employee info
                const { data: empData, error: empError } = await client
                    .from('users')
                    .select('*')
                    .eq('id', empId)
                    .single();

                if (empError || !empData) {
                    resultsDiv.innerHTML = '<p class="text-red-500 text-center py-8">Employee not found.</p>';
                    return;
                }

                // Calculate date range based on period
                let startDate, endDate;
                const now = new Date();

                if (period === 'current') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
                    endDate = now.toISOString().split('T')[0];
                } else if (period === 'last') {
                    startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1).toISOString().split('T')[0];
                    endDate = new Date(now.getFullYear(), now.getMonth(), 0).toISOString().split('T')[0];
                } else if (period === 'quarter') {
                    const quarterStart = Math.floor(now.getMonth() / 3) * 3;
                    startDate = new Date(now.getFullYear(), quarterStart, 1).toISOString().split('T')[0];
                    endDate = now.toISOString().split('T')[0];
                } else {
                    startDate = new Date(now.getFullYear(), 0, 1).toISOString().split('T')[0];
                    endDate = now.toISOString().split('T')[0];
                }

                // Get attendance records
                const { data: attendance } = await client
                    .from('attendance')
                    .select('*')
                    .eq('employee_id', empId)
                    .gte('date', startDate)
                    .lte('date', endDate)
                    .not('clock_out', 'is', null);

                const totalHours = attendance?.reduce((sum, r) => sum + calculateHoursFromRecord(r), 0) || 0;
                const daysWorked = new Set(attendance?.map(r => r.date) || []).size;
                const grossPay = totalHours * HOURLY_RATE;

                // Calculate deductions
                const nis = Math.min(grossPay * 0.03, 3000);
                const nht = grossPay * 0.02;
                const eduTax = grossPay * 0.0225;
                const annualized = grossPay * 12;
                const paye = annualized > 1500096 ? ((annualized - 1500096) * 0.25) / 12 : 0;
                const totalDed = nis + nht + eduTax + paye;
                const netPay = grossPay - totalDed;

                // Project for full month/period
                const avgHoursPerDay = daysWorked > 0 ? totalHours / daysWorked : 8;
                const projectedMonthlyHours = avgHoursPerDay * 22; // Assume 22 working days
                const projectedGross = projectedMonthlyHours * HOURLY_RATE;

                resultsDiv.innerHTML = `
                    <div class="bg-white rounded-lg p-4">
                        <h3 class="font-bold text-lg text-gray-800 mb-4">${empData.name} (${empId})</h3>
                        
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="p-3 bg-blue-50 rounded-lg">
                                <p class="text-xs text-blue-600">Period</p>
                                <p class="font-bold text-blue-800">${startDate} to ${endDate}</p>
                            </div>
                            <div class="p-3 bg-purple-50 rounded-lg">
                                <p class="text-xs text-purple-600">Days Worked</p>
                                <p class="font-bold text-purple-800">${daysWorked}</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-3 gap-4 mb-4">
                            <div class="p-3 bg-indigo-50 rounded-lg">
                                <p class="text-xs text-indigo-600">Actual Hours</p>
                                <p class="font-bold text-indigo-800">${totalHours.toFixed(2)} hrs</p>
                            </div>
                            <div class="p-3 bg-green-50 rounded-lg">
                                <p class="text-xs text-green-600">Actual Gross</p>
                                <p class="font-bold text-green-800">JMD ${grossPay.toLocaleString()}</p>
                            </div>
                            <div class="p-3 bg-yellow-50 rounded-lg">
                                <p class="text-xs text-yellow-600">Actual Net</p>
                                <p class="font-bold text-yellow-800">JMD ${netPay.toLocaleString()}</p>
                            </div>
                        </div>

                        <div class="p-4 border border-purple-200 rounded-lg bg-purple-50 mt-4">
                            <h4 class="font-bold text-purple-800 mb-2">Monthly Projection</h4>
                            <p class="text-sm text-purple-700">Based on ${avgHoursPerDay.toFixed(1)} avg hours/day √ó 22 working days:</p>
                            <div class="grid grid-cols-2 gap-4 mt-2">
                                <div>
                                    <p class="text-xs text-purple-600">Projected Hours</p>
                                    <p class="font-bold text-purple-800">${projectedMonthlyHours.toFixed(2)} hrs</p>
                                </div>
                                <div>
                                    <p class="text-xs text-purple-600">Projected Gross</p>
                                    <p class="font-bold text-purple-800">JMD ${projectedGross.toLocaleString()}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

            } catch (err) {
                console.error('Error loading employee budget:', err);
                resultsDiv.innerHTML = '<p class="text-red-500 text-center py-8">Error loading data.</p>';
            }
        };

        window.generateBusinessBudget = async function() {
            const period = document.getElementById('business-budget-period')?.value;
            const resultsDiv = document.getElementById('business-budget-results');

            resultsDiv.innerHTML = '<p class="text-purple-700 text-center py-8">Generating report...</p>';

            try {
                // Get all employees
                const { data: employees } = await client
                    .from('users')
                    .select('*')
                    .eq('role', 'employee');

                // Get recent payroll data for projection
                const threeMonthsAgo = new Date();
                threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);

                const { data: recentPayroll } = await client
                    .from('payroll_records')
                    .select('*')
                    .gte('period_start', threeMonthsAgo.toISOString().split('T')[0]);

                // Calculate averages
                let totalGross = 0, totalNet = 0, totalHours = 0;
                recentPayroll?.forEach(r => {
                    totalGross += r.gross_pay || 0;
                    totalNet += r.net_pay || 0;
                    totalHours += r.total_hours || 0;
                });

                const avgMonthlyGross = recentPayroll?.length > 0 ? totalGross / 3 : 0;
                const avgMonthlyNet = recentPayroll?.length > 0 ? totalNet / 3 : 0;
                const avgMonthlyHours = recentPayroll?.length > 0 ? totalHours / 3 : 0;

                // Calculate projections based on period
                let multiplier = 1;
                let periodLabel = 'Next Month';

                if (period === 'next_quarter') {
                    multiplier = 3;
                    periodLabel = 'Next Quarter';
                } else if (period === 'annual') {
                    multiplier = 12;
                    periodLabel = 'Annual';
                }

                const projectedGross = avgMonthlyGross * multiplier;
                const projectedNet = avgMonthlyNet * multiplier;
                const projectedHours = avgMonthlyHours * multiplier;
                const employeeCount = employees?.length || 0;

                // Calculate employer costs (employer NIS and NHT contributions)
                const employerNIS = projectedGross * 0.03;
                const employerNHT = projectedGross * 0.03;
                const totalEmployerCost = projectedGross + employerNIS + employerNHT;

                resultsDiv.innerHTML = `
                    <div class="bg-white rounded-lg p-4">
                        <h3 class="font-bold text-lg text-gray-800 mb-4">${periodLabel} Budget Projection</h3>
                        
                        <div class="grid grid-cols-4 gap-4 mb-6">
                            <div class="p-3 bg-blue-50 rounded-lg text-center">
                                <p class="text-xs text-blue-600">Active Employees</p>
                                <p class="text-2xl font-bold text-blue-800">${employeeCount}</p>
                            </div>
                            <div class="p-3 bg-purple-50 rounded-lg text-center">
                                <p class="text-xs text-purple-600">Projected Hours</p>
                                <p class="text-2xl font-bold text-purple-800">${projectedHours.toFixed(0)}</p>
                            </div>
                            <div class="p-3 bg-green-50 rounded-lg text-center">
                                <p class="text-xs text-green-600">Projected Gross</p>
                                <p class="text-xl font-bold text-green-800">JMD ${projectedGross.toLocaleString()}</p>
                            </div>
                            <div class="p-3 bg-yellow-50 rounded-lg text-center">
                                <p class="text-xs text-yellow-600">Net to Employees</p>
                                <p class="text-xl font-bold text-yellow-800">JMD ${projectedNet.toLocaleString()}</p>
                            </div>
                        </div>

                        <div class="p-4 border border-red-200 rounded-lg bg-red-50 mb-4">
                            <h4 class="font-bold text-red-800 mb-2">Employer Costs Breakdown</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-red-700">Employee Wages (Gross):</span>
                                    <span class="font-bold">JMD ${projectedGross.toLocaleString()}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-red-700">Employer NIS (3%):</span>
                                    <span class="font-bold">JMD ${employerNIS.toLocaleString()}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-red-700">Employer NHT (3%):</span>
                                    <span class="font-bold">JMD ${employerNHT.toLocaleString()}</span>
                                </div>
                                <div class="flex justify-between border-t pt-2 text-lg">
                                    <span class="font-bold text-red-800">Total Employer Cost:</span>
                                    <span class="font-bold text-red-800">JMD ${totalEmployerCost.toLocaleString()}</span>
                                </div>
                            </div>
                        </div>

                        <p class="text-xs text-gray-500 mt-4">
                            * Projections based on 3-month average. Actual costs may vary based on employee hours and new hires.
                        </p>
                    </div>
                `;

            } catch (err) {
                console.error('Error generating business budget:', err);
                resultsDiv.innerHTML = '<p class="text-red-500 text-center py-8">Error generating budget report.</p>';
            }
        };

        // --- Task List Feature ---
        function renderTaskList() {
            const canAssign = currentUser.role === 'admin' || currentUser.role === 'ceo';
            return `
                <div class="bg-white p-6 rounded-xl shadow-md max-w-6xl">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Task Management</h2>
                            <p class="text-sm text-gray-500 mt-1">Organize and track your tasks efficiently</p>
                        </div>
                        <button onclick="showTaskModal()" class="py-2 px-4 text-white font-semibold rounded-lg accent-gradient hover:opacity-90 transition">
                            + New Task
                        </button>
                    </div>

                    <!-- Task Filters -->
                    <div class="flex gap-3 mb-6">
                        <button onclick="filterTasks('all')" id="filter-all" class="px-4 py-2 rounded-lg font-semibold bg-purple-600 text-white">All</button>
                        <button onclick="filterTasks('pending')" id="filter-pending" class="px-4 py-2 rounded-lg font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300">Pending</button>
                        <button onclick="filterTasks('completed')" id="filter-completed" class="px-4 py-2 rounded-lg font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300">Completed</button>
                        ${canAssign ? `
                        <button onclick="filterTasks('assigned')" id="filter-assigned" class="px-4 py-2 rounded-lg font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300">Assigned by Me</button>
                        ` : ''}
                    </div>

                    <!-- Tasks Grid -->
                    <div id="tasks-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <p class="text-gray-500 text-center col-span-full py-8">Loading tasks...</p>
                    </div>
                </div>

                <!-- Task Modal -->
                <div id="task-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
                    <div class="bg-white p-6 rounded-xl shadow-xl max-w-lg w-full mx-4">
                        <h3 id="task-modal-title" class="text-xl font-bold mb-4">Create New Task</h3>
                        <div class="space-y-4">
                            <input type="text" id="task-title" placeholder="Task Title" class="w-full p-3 border rounded-lg">
                            <textarea id="task-description" rows="3" placeholder="Task description..." class="w-full p-3 border rounded-lg"></textarea>
                            ${canAssign ? `
                            <select id="task-assignee" class="w-full p-3 border rounded-lg bg-white">
                                <option value="${currentUser.id}">Assign to Myself</option>
                            </select>
                            ` : ''}
                            <input type="date" id="task-due-date" class="w-full p-3 border rounded-lg">
                            <select id="task-priority" class="w-full p-3 border rounded-lg bg-white">
                                <option value="low">Low Priority</option>
                                <option value="medium" selected>Medium Priority</option>
                                <option value="high">High Priority</option>
                                <option value="urgent">Urgent</option>
                            </select>
                        </div>
                        <div class="flex space-x-3 mt-6">
                            <button onclick="saveTask()" class="flex-1 py-2 text-white font-semibold rounded-lg accent-gradient">Save Task</button>
                            <button onclick="closeTaskModal()" class="flex-1 py-2 text-gray-600 font-semibold rounded-lg border border-gray-300 hover:bg-gray-50">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
        }

        let allTasks = [];
        let currentTaskFilter = 'all';
        let editingTaskId = null;

        window.loadTaskList = async function() {
            try {
                let query = client.from('tasks').select('*');
                
                if (currentUser.role === 'employee') {
                    // Employees see tasks assigned to them or created by them
                    query = query.or(`assigned_to.eq.${currentUser.id},created_by.eq.${currentUser.id}`);
                }
                // Admins/CEO can see all tasks (no filter)
                
                const { data, error } = await query.order('created_at', { ascending: false });

                if (error) throw error;

                allTasks = data || [];
                renderTasks(allTasks);
                
                // Load employees for assign dropdown if admin/ceo
                if (currentUser.role === 'admin' || currentUser.role === 'ceo') {
                    loadEmployeesForTasks();
                }
            } catch (err) {
                console.error('Error loading tasks:', err);
                document.getElementById('tasks-container').innerHTML = '<p class="text-red-500 text-center col-span-full py-8">Error loading tasks.</p>';
            }
        };

        async function loadEmployeesForTasks() {
            try {
                const { data } = await client
                    .from('users')
                    .select('id, name')
                    .eq('role', 'employee')
                    .order('name');

                const select = document.getElementById('task-assignee');
                if (!select) return;

                select.innerHTML = `<option value="${currentUser.id}">Assign to Myself</option>`;
                if (data) {
                    data.forEach(emp => {
                        const option = document.createElement('option');
                        option.value = emp.id;
                        option.textContent = emp.name + ' (' + emp.id + ')';
                        select.appendChild(option);
                    });
                }
            } catch (err) {
                console.error('Error loading employees:', err);
            }
        }

        function renderTasks(tasks) {
            const container = document.getElementById('tasks-container');
            if (!container) return;

            if (tasks.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center col-span-full py-8">No tasks found.</p>';
                return;
            }

            const priorityColors = {
                low: 'bg-blue-100 border-blue-300 text-blue-800',
                medium: 'bg-yellow-100 border-yellow-300 text-yellow-800',
                high: 'bg-orange-100 border-orange-300 text-orange-800',
                urgent: 'bg-red-100 border-red-300 text-red-800'
            };

            container.innerHTML = tasks.map(task => {
                const isCompleted = task.status === 'completed';
                const priority = priorityColors[task.priority] || priorityColors.medium;
                const isAssignedToMe = task.assigned_to === currentUser.id;
                const isMyTask = task.created_by === currentUser.id;

                return `
                    <div class="p-4 rounded-xl border-2 ${isCompleted ? 'bg-gray-50 border-gray-200 opacity-75' : 'bg-white border-gray-200 hover:border-purple-300'} transition-all shadow-sm hover:shadow-md">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <h3 class="font-bold text-gray-800 ${isCompleted ? 'line-through' : ''}">${task.title}</h3>
                                ${task.assigned_to && task.assigned_to !== task.created_by ? `
                                <p class="text-xs text-gray-500 mt-1">Assigned to: ${task.assigned_to_name || task.assigned_to}</p>
                                ` : ''}
                            </div>
                            <span class="px-2 py-1 text-xs rounded-full ${priority}">${task.priority}</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-3 ${isCompleted ? 'line-through' : ''}">${task.description || 'No description'}</p>
                        ${task.due_date ? `
                        <p class="text-xs text-gray-500 mb-2">
                            üìÖ Due: ${new Date(task.due_date).toLocaleDateString()}
                            ${new Date(task.due_date) < new Date() && !isCompleted ? '<span class="text-red-600 font-semibold"> (Overdue)</span>' : ''}
                        </p>
                        ` : ''}
                        <div class="flex gap-2 mt-3">
                            ${isAssignedToMe || isMyTask ? `
                            <button onclick="toggleTaskStatus('${task.id}')" class="flex-1 py-1.5 px-3 text-xs font-semibold rounded-lg ${isCompleted ? 'bg-yellow-500 hover:bg-yellow-600 text-white' : 'bg-green-500 hover:bg-green-600 text-white'}">
                                ${isCompleted ? 'Mark Incomplete' : 'Mark Complete'}
                            </button>
                            ` : ''}
                            ${isMyTask || currentUser.role === 'admin' || currentUser.role === 'ceo' ? `
                            <button onclick="editTask('${task.id}')" class="py-1.5 px-3 text-xs font-semibold rounded-lg bg-purple-500 hover:bg-purple-600 text-white">Edit</button>
                            <button onclick="deleteTask('${task.id}')" class="py-1.5 px-3 text-xs font-semibold rounded-lg bg-red-500 hover:bg-red-600 text-white">Delete</button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.filterTasks = function(filter) {
            currentTaskFilter = filter;
            
            // Update button styles
            document.querySelectorAll('[id^="filter-"]').forEach(btn => {
                btn.classList.remove('bg-purple-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            document.getElementById('filter-' + filter).classList.remove('bg-gray-200', 'text-gray-700');
            document.getElementById('filter-' + filter).classList.add('bg-purple-600', 'text-white');

            let filtered = allTasks;
            if (filter === 'pending') {
                filtered = allTasks.filter(t => t.status !== 'completed');
            } else if (filter === 'completed') {
                filtered = allTasks.filter(t => t.status === 'completed');
            } else if (filter === 'assigned') {
                filtered = allTasks.filter(t => t.created_by === currentUser.id && t.assigned_to !== currentUser.id);
            }

            renderTasks(filtered);
        };

        window.showTaskModal = function() {
            editingTaskId = null;
            document.getElementById('task-modal-title').textContent = 'Create New Task';
            document.getElementById('task-title').value = '';
            document.getElementById('task-description').value = '';
            document.getElementById('task-due-date').value = '';
            document.getElementById('task-priority').value = 'medium';
            if (document.getElementById('task-assignee')) {
                document.getElementById('task-assignee').value = currentUser.id;
            }
            document.getElementById('task-modal').classList.remove('hidden');
        };

        window.closeTaskModal = function() {
            document.getElementById('task-modal').classList.add('hidden');
            editingTaskId = null;
        };

        window.saveTask = async function() {
            const title = document.getElementById('task-title').value.trim();
            const description = document.getElementById('task-description').value.trim();
            const dueDate = document.getElementById('task-due-date').value;
            const priority = document.getElementById('task-priority').value;
            const assigneeId = document.getElementById('task-assignee')?.value || currentUser.id;

            if (!title) {
                showToast('Please enter a task title.', 'error');
                return;
            }

            try {
                // Get assignee name
                let assigneeName = currentUser.name;
                if (assigneeId !== currentUser.id) {
                    const { data: empData } = await client
                        .from('users')
                        .select('name')
                        .eq('id', assigneeId)
                        .single();
                    assigneeName = empData?.name || assigneeId;
                }

                if (editingTaskId) {
                    // Update existing task
                    const { error } = await client
                        .from('tasks')
                        .update({
                            title,
                            description,
                            due_date: dueDate || null,
                            priority,
                            assigned_to: assigneeId,
                            assigned_to_name: assigneeName,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', editingTaskId);

                    if (error) throw error;
                    showToast('Task updated successfully!', 'success');
                } else {
                    // Create new task
                    const { error } = await client
                        .from('tasks')
                        .insert([{
                            title,
                            description,
                            due_date: dueDate || null,
                            priority,
                            status: 'pending',
                            created_by: currentUser.id,
                            created_by_name: currentUser.name,
                            assigned_to: assigneeId,
                            assigned_to_name: assigneeName,
                            created_at: new Date().toISOString()
                        }]);

                    if (error) throw error;
                    showToast('Task created successfully!', 'success');
                }

                closeTaskModal();
                loadTaskList();
            } catch (err) {
                console.error('Error saving task:', err);
                showToast('Failed to save task: ' + err.message, 'error');
            }
        };

        window.editTask = async function(taskId) {
            const task = allTasks.find(t => t.id === taskId);
            if (!task) return;

            editingTaskId = taskId;
            document.getElementById('task-modal-title').textContent = 'Edit Task';
            document.getElementById('task-title').value = task.title;
            document.getElementById('task-description').value = task.description || '';
            document.getElementById('task-due-date').value = task.due_date || '';
            document.getElementById('task-priority').value = task.priority || 'medium';
            if (document.getElementById('task-assignee')) {
                document.getElementById('task-assignee').value = task.assigned_to || currentUser.id;
            }
            document.getElementById('task-modal').classList.remove('hidden');
        };

        window.deleteTask = async function(taskId) {
            if (!confirm('Are you sure you want to delete this task?')) return;

            try {
                const { error } = await client
                    .from('tasks')
                    .delete()
                    .eq('id', taskId);

                if (error) throw error;
                showToast('Task deleted successfully!', 'success');
                loadTaskList();
            } catch (err) {
                console.error('Error deleting task:', err);
                showToast('Failed to delete task', 'error');
            }
        };

        window.toggleTaskStatus = async function(taskId) {
            const task = allTasks.find(t => t.id === taskId);
            if (!task) return;

            const newStatus = task.status === 'completed' ? 'pending' : 'completed';

            try {
                const { error } = await client
                    .from('tasks')
                    .update({
                        status: newStatus,
                        completed_at: newStatus === 'completed' ? new Date().toISOString() : null,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', taskId);

                if (error) throw error;
                showToast(`Task marked as ${newStatus}!`, 'success');
                loadTaskList();
            } catch (err) {
                console.error('Error updating task:', err);
                showToast('Failed to update task', 'error');
            }
        };

        // Dashboard Tasks & Meetings
        async function loadDashboardTasks() {
            try {
                let query = client
                    .from('tasks')
                    .select('*')
                    .eq('status', 'pending');
                
                if (currentUser.role === 'employee') {
                    query = query.or(`assigned_to.eq.${currentUser.id},created_by.eq.${currentUser.id}`);
                }
                // Admins/CEO see all pending tasks
                
                const { data } = await query
                    .order('created_at', { ascending: false })
                    .limit(5);

                const container = document.getElementById('dashboard-tasks');
                if (!container) return;

                if (!data || data.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-sm">No pending tasks</p>';
                    return;
                }

                container.innerHTML = data.map(task => `
                    <div class="p-3 bg-white rounded-lg border border-gray-200 flex items-center justify-between">
                        <div class="flex-1">
                            <p class="font-semibold text-sm text-gray-800">${task.title}</p>
                            ${task.due_date ? `<p class="text-xs text-gray-500">Due: ${new Date(task.due_date).toLocaleDateString()}</p>` : ''}
                        </div>
                        <button onclick="toggleTaskStatus('${task.id}')" class="ml-2 px-3 py-1 text-xs font-semibold rounded-lg bg-green-500 hover:bg-green-600 text-white">
                            Complete
                        </button>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Error loading dashboard tasks:', err);
            }
        }

        async function loadDashboardMeetings() {
            try {
                let query = client.from('meetings').select('*');
                
                if (currentUser.role === 'employee') {
                    query = query.eq('audience', 'everyone');
                } else if (currentUser.role === 'admin') {
                    query = query.or('audience.eq.everyone,audience.eq.admins_only');
                }
                
                const { data } = await query
                    .gte('meeting_date', new Date().toISOString())
                    .order('meeting_date', { ascending: true })
                    .limit(5);

                const container = document.getElementById('dashboard-meetings');
                if (!container) return;

                if (!data || data.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-sm">No upcoming meetings</p>';
                    return;
                }

                container.innerHTML = data.map(meeting => `
                    <div class="p-3 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg border border-indigo-200">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-semibold text-sm text-indigo-800">üìÖ ${meeting.title}</p>
                                <p class="text-xs text-indigo-600 mt-1">${new Date(meeting.meeting_date).toLocaleString()}</p>
                                ${meeting.description ? `<p class="text-xs text-gray-600 mt-1">${meeting.description.substring(0, 50)}...</p>` : ''}
                            </div>
                            <span class="px-2 py-1 text-xs rounded-full bg-indigo-100 text-indigo-700">${meeting.audience === 'admins_only' ? 'Admins' : 'All'}</span>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Error loading meetings:', err);
            }
        }

        // --- Icon Helper ---

        function getIcon(name, classes = 'text-gray-500') {
            // Note: Updated 'updates' icon to 'megaphone'
            const icons = {
                gauge: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-layout-dashboard w-6 h-6 ' + classes + '"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>',
                'file-text': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text w-6 h-6 ' + classes + '"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>',
                'clipboard-list': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clipboard-list w-6 h-6 ' + classes + '"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg>',
                gift: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-gift w-6 h-6 ' + classes + '"><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13"/><path d="M19 12v9"/><path d="M5 12v9"/><path d="M10 8V3a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v5"/></svg>',
                banknote: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-banknote w-6 h-6 ' + classes + '"><rect width="20" height="12" x="2" y="6" rx="2"/><circle cx="12" cy="12" r="2"/><path d="M6 12h.01"/><path d="M18 12h.01"/></svg>',
                clock: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clock w-6 h-6 ' + classes + '"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
                calculator: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calculator w-6 h-6 ' + classes + '"><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="18" y2="18"/><line x1="16" x2="16" y1="14" y2="14"/><line x1="16" x2="16" y1="10" y2="10"/><line x1="8" x2="8" y1="18" y2="18"/><line x1="8" x2="8" y1="14" y2="14"/><line x1="8" x2="8" y1="10" y2="10"/><line x1="12" x2="12" y1="18" y2="18"/><line x1="12" x2="12" y1="14" y2="14"/><line x1="12" x2="12" y1="10" y2="10"/></svg>',
                'dollar-sign': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-dollar-sign w-6 h-6 ' + classes + '"><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>',
                'file-bar-chart': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-bar-chart w-6 h-6 ' + classes + '"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 13v7"/><path d="M14 17v3"/><path d="M18 15v5"/></svg>',
                users: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users w-6 h-6 ' + classes + '"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
                lock: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-lock w-6 h-6 ' + classes + '"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>',
                server: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-server w-6 h-6 ' + classes + '"><rect width="20" height="8" x="2" y="2" rx="2" ry="2"/><rect width="20" height="8" x="2" y="14" rx="2" ry="2"/><line x1="6" x2="6" y1="6" y2="6"/><line x1="6" x2="6" y1="18" y2="18"/></svg>',
                calendar: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar w-6 h-6 ' + classes + '"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>',
                leaf: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-leaf w-6 h-6 ' + classes + '"><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17.5 7 19 8c1.5 1.5 2 4.1 2 5.6 0 3.9-3.4 7.2-7.2 7.2h-.1A4.9 4.9 0 0 1 11 20z"/><path d="M12 9H4a2 2 0 0 1 0-4h8"/></svg>',
                mail: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-mail w-6 h-6 ' + classes + '"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>',
                database: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-database w-6 h-6 ' + classes + '"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5V19A9 3 0 0 0 21 19V5"/><path d="M3 12A9 3 0 0 0 21 12"/></svg>',
                'list-ordered': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-list-ordered w-6 h-6 ' + classes + '"><line x1="10" x2="21" y1="6" y2="6"/><line x1="10" x2="21" y1="12" y2="12"/><line x1="10" x2="21" y1="18" y2="18"/><path d="M4 6h1c.5 0 1-.5 1-1V1"/><path d="M4 10h2l-.5 4"/><path d="M6 18H4c.8 0 1.5-.7 1.5-1.5v-1c0-.8-.7-1.5-1.5-1.5H6"/></svg>',
                'book-open-check': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-book-open-check w-6 h-6 ' + classes + '"><path d="M8 3H2v15h7c1.7 0 3.3.4 4.5 1.3"/><path d="M22 17V5c0-1.7-1.3-3-3-3h-9c-1.7 0-3 1.3-3 3v13c0 1.7 1.3 3 3 3h13c1.7 0 3-1.3 3-3Z"/><path d="m16 9-3 3-1.5-1.5"/></path></svg>',
                download: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download w-6 h-6 ' + classes + '"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>',
                megaphone: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-megaphone w-6 h-6 ' + classes + '"><path d="m3 11 1.4-1.4A5 5 0 0 1 8 8.6V20a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-2c0-.7.1-1.3.4-1.9l2.4-2.4a5 5 0 0 0-.4-3.3z"/><path d="M21 15s-1.4-1.4-2.4-2.4c-.6-.6-.9-1.3-.9-2.1V4c0-1.1-.9-2-2-2h-3a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h3c1.1 0 2-.9 2-2v-2c0-.7.1-1.3.4-1.9l2.4-2.4c.3-.3.4-.6.4-1s-.1-.7-.4-1L18.6 8.6"/></svg>',
                'book-open': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-book-open w-6 h-6 ' + classes + '"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>',
                hours: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clock w-6 h-6 ' + classes + '"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
            };
            return icons[name] || icons['gauge'];
        }

        // Initialize the app state (Show login screen first)
        document.addEventListener('DOMContentLoaded', () => {
            // Check if a user is logged in (simulated)
            if (currentUser) {
                initializeAppUI(currentUser);
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('app-container').classList.add('hidden');
            }
        });
    </script>
</body>
</html>